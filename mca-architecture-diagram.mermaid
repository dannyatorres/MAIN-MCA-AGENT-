%%{init: {'theme': 'dark', 'themeVariables': { 'primaryColor': '#3b82f6', 'primaryTextColor': '#fff', 'primaryBorderColor': '#60a5fa', 'lineColor': '#94a3b8', 'secondaryColor': '#1e293b', 'tertiaryColor': '#0f172a'}}}%%

flowchart TB
    subgraph UI["ğŸ–¥ï¸ User Interface Layer"]
        LP["ğŸ“‹ Left Panel<br/>Lead List"]
        CP["ğŸ’¬ Center Panel<br/>Chat / Dashboard"]
        RP["ğŸ§  Right Panel<br/>Intelligence Tabs"]
    end

    subgraph Core["âš™ï¸ Application Core"]
        CC["ğŸ¯ CommandCenter<br/>(app-core.js)<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Module Registry<br/>â€¢ API Gateway<br/>â€¢ Global State"]
        
        subgraph StateHub["ğŸ“Š State Management"]
            ConvCore["ConversationCore<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>conversations: Map<br/>currentId: string<br/>selectedConv: object"]
        end
    end

    subgraph Modules["ğŸ“¦ Feature Modules"]
        direction LR
        MSG["ğŸ’¬ MessagingModule<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Send/Receive SMS<br/>â€¢ Deduplication<br/>â€¢ File Upload"]
        DOC["ğŸ“„ DocumentsModule<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Drag & Drop<br/>â€¢ Type Classification<br/>â€¢ Document Cache"]
        AI["ğŸ¤– AIAssistant<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Chat Interface<br/>â€¢ History Cache<br/>â€¢ Context Mgmt"]
        FCS["ğŸ“Š FCSModule<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Financial Analysis<br/>â€¢ Job Polling<br/>â€¢ Report Display"]
        LND["ğŸ¦ LendersModule<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Qualification<br/>â€¢ Multi-Submit<br/>â€¢ Response Log"]
        STATS["ğŸ“ˆ StatsModule<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ Dashboard Stats<br/>â€¢ Funding Goals<br/>â€¢ Metrics"]
    end

    subgraph RealTime["âš¡ Real-Time Layer"]
        WS["ğŸ”Œ WebSocketManager<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Events:<br/>â€¢ new_message<br/>â€¢ conversation_updated<br/>â€¢ refresh_lead_list<br/>â€¢ document_uploaded<br/>â€¢ fcs_completed"]
    end

    subgraph Infra["ğŸ”§ Infrastructure"]
        API["ğŸŒ ApiService<br/>GET/POST/PUT/DELETE"]
        UTIL["ğŸ› ï¸ Utilities<br/>Date, Currency, Phone"]
        TPL["ğŸ“ Templates<br/>HTML Generators"]
        FMT["âœ¨ Formatters<br/>Phone, SSN, Currency"]
    end

    subgraph External["â˜ï¸ External Services"]
        BE["ğŸ–¥ï¸ Backend API<br/>(REST + Socket.io)"]
        TWILIO["ğŸ“ Twilio Voice"]
        GDRIVE["ğŸ“ Google Drive"]
    end

    %% UI to Core connections
    LP --> ConvCore
    CP --> MSG
    RP --> AI
    RP --> DOC
    RP --> FCS
    RP --> LND

    %% Core orchestration
    CC --> ConvCore
    CC --> MSG
    CC --> DOC
    CC --> AI
    CC --> FCS
    CC --> LND
    CC --> STATS
    CC --> WS

    %% Real-time event flow
    WS --> MSG
    WS --> ConvCore
    WS --> DOC
    WS --> FCS

    %% Infrastructure usage
    CC --> API
    MSG --> UTIL
    DOC --> UTIL
    ConvCore --> TPL

    %% External connections
    API --> BE
    WS --> BE
    FCS --> GDRIVE
    
    subgraph CallMgr["ğŸ“ Calling"]
        CALL["CallManager<br/>Twilio Voice Client"]
    end
    
    CALL --> TWILIO

    %% Styling
    classDef coreClass fill:#1e40af,stroke:#3b82f6,color:#fff
    classDef moduleClass fill:#166534,stroke:#22c55e,color:#fff
    classDef infraClass fill:#7c2d12,stroke:#f97316,color:#fff
    classDef rtClass fill:#7e22ce,stroke:#a855f7,color:#fff
    classDef extClass fill:#4c1d95,stroke:#8b5cf6,color:#fff
    
    class CC,ConvCore coreClass
    class MSG,DOC,AI,FCS,LND,STATS moduleClass
    class API,UTIL,TPL,FMT infraClass
    class WS rtClass
    class BE,TWILIO,GDRIVE extClass
