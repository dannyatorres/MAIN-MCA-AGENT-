<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>User Management - MCA Command Center</title>
  <link rel="stylesheet" href="/css/modules/01-theme.css">
  <link rel="stylesheet" href="/css/user-menu.css">
  <link rel="stylesheet" href="/css/admin.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <header class="admin-header">
    <h1>
      <a href="/command-center.html"><i class="fas fa-arrow-left"></i></a>
      User Management
    </h1>
    <div id="user-menu"></div>
  </header>

  <main class="admin-container">
    <div class="admin-toolbar">
      <div>
        <span id="userCount">0 users</span>
      </div>
      <div class="toolbar-actions">
        <button class="btn btn-secondary" id="btn-reports">
          ðŸ“Š Daily Reports
        </button>
        <button class="btn btn-secondary" id="btn-training">
          ðŸ§  AI Learning
        </button>
        <button class="btn btn-secondary" id="btn-rules">
          <i class="fas fa-gavel"></i> AI Rules
        </button>
        <button class="btn btn-primary" id="addUserBtn">
          <i class="fas fa-plus"></i> Add User
        </button>
      </div>
    </div>

    <table class="users-table">
      <thead>
        <tr>
          <th>Name</th>
          <th>Email</th>
          <th>Username</th>
          <th>Role</th>
          <th>Status</th>
          <th>Last Login</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody id="usersTableBody">
        <tr><td colspan="7" class="empty-state">Loading...</td></tr>
      </tbody>
    </table>
  </main>

  <!-- Add/Edit User Modal -->
  <div class="modal-overlay" id="userModal">
    <div class="modal">
      <div class="modal-header">
        <h2 id="modalTitle">Add User</h2>
        <button class="modal-close" id="modalClose">&times;</button>
      </div>
      <div class="modal-body">
        <form id="userForm">
          <input type="hidden" id="userId">
          <div class="form-group">
            <label>Name *</label>
            <input type="text" id="userName" required>
          </div>
          <div class="form-group">
            <label>Email *</label>
            <input type="email" id="userEmail" required>
          </div>
          <div class="form-group">
            <label>Username *</label>
            <input type="text" id="userUsername" required>
          </div>
          <div class="form-group" id="passwordGroup">
            <label>Password *</label>
            <input type="password" id="userPassword">
            <small class="text-muted">Min 8 chars, 1 uppercase, 1 number</small>
          </div>
          <div class="form-group">
            <label>Role</label>
            <select id="userRole">
              <option value="agent">Agent</option>
              <option value="viewer">Viewer</option>
              <option value="manager">Manager</option>
              <option value="admin">Admin</option>
            </select>
          </div>
          <div class="form-group">
            <label>Agent Name (AI Persona)</label>
            <input type="text" id="userAgentName" placeholder="e.g. Dan Torres">
            <small class="text-muted">Name the AI uses when texting leads</small>
          </div>

          <!-- Service Settings Section (only shown when editing) -->
          <div class="form-section hidden" id="serviceSettingsSection">
            <h4><i class="fas fa-cogs"></i> Service Access</h4>

          <div class="form-group">
            <label>Google Drive Folder ID</label>
            <input type="text" id="userDriveFolderId" placeholder="Leave blank for default">
            <small class="text-muted">Custom folder for this user's bank statements</small>
            <button type="button" class="btn btn-primary btn-sm mt-10" id="btn-test-drive">
              <i class="fas fa-plug"></i> Test Connection
            </button>
            <div id="driveTestResult" class="mt-10 text-xs"></div>
          </div>

          <div class="form-group">
            <label>Campaign Hook Message</label>
            <textarea id="userCampaignHook" rows="3" class="form-textarea" placeholder="Hey {{LEAD_NAME}}, I'm an underwriter - saw you took funding recently..."></textarea>
            <small class="text-muted">First message sent to new leads. Leave blank for default.</small>
          </div>

            <div class="services-grid">
              <label class="toggle-item">
                <input type="checkbox" id="svc_aiAgent" checked>
                <span>AI Agent (SMS Bot)</span>
              </label>
              <label class="toggle-item">
                <input type="checkbox" id="svc_driveSync" checked>
                <span>Drive Sync</span>
              </label>
              <label class="toggle-item">
                <input type="checkbox" id="svc_fcs" checked>
                <span>FCS Analysis</span>
              </label>
              <label class="toggle-item">
                <input type="checkbox" id="svc_commander" checked>
                <span>Commander Strategy</span>
              </label>
              <label class="toggle-item">
                <input type="checkbox" id="svc_lenderMatcher" checked>
                <span>Lender Matcher</span>
              </label>
              <label class="toggle-item">
                <input type="checkbox" id="svc_successPredictor" checked>
                <span>Success Predictor</span>
              </label>
            </div>
          </div>

          <div id="formError" class="error-msg hidden"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="modalCancel">Cancel</button>
        <button class="btn btn-primary" id="modalSave">Save</button>
      </div>
    </div>
  </div>

  <!-- Reset Password Modal -->
  <div class="modal-overlay" id="passwordModal">
    <div class="modal">
      <div class="modal-header">
        <h2>Reset Password</h2>
        <button class="modal-close" id="passwordModalClose">&times;</button>
      </div>
      <div class="modal-body">
        <form id="passwordForm">
          <input type="hidden" id="passwordUserId">
          <p class="mb-16 text-muted">Resetting password for: <strong id="passwordUserName"></strong></p>
          <div class="form-group">
            <label>New Password *</label>
            <input type="password" id="newPassword" required>
            <small class="text-muted">Min 8 chars, 1 uppercase, 1 number</small>
          </div>
          <div id="passwordFormError" class="error-msg hidden"></div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="passwordModalCancel">Cancel</button>
        <button class="btn btn-primary" id="passwordModalSave">Reset Password</button>
      </div>
    </div>
  </div>

  <!-- Training Modal -->
  <div id="trainingModal" class="modal-overlay">
    <div class="modal modal-lg">
      <div class="modal-header">
        <h2 class="modal-title">ðŸ§  AI Learning</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <div class="mb-30">
          <h3 class="text-blue">Suggested Patterns</h3>
          <p class="text-muted text-xs">These patterns appeared 2+ times. Approve to add to AI persona.</p>
          <div id="pendingPatterns"></div>
        </div>

        <div>
          <h3 class="text-green">Active Patterns</h3>
          <p class="text-muted text-xs">Currently in dan_torres.md</p>
          <div id="currentPatterns" class="panel-box"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- AI Rules Modal -->
  <div id="rulesModal" class="modal-overlay">
    <div class="modal modal-xl">
      <div class="modal-header">
        <h2 class="modal-title"><i class="fas fa-gavel"></i> AI Rule Suggestions</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body modal-body-scroll">

        <!-- Pending Suggestions -->
        <div class="mb-30">
          <div class="flex-between flex-center mb-12">
            <h3 class="text-warning m-0"><i class="fas fa-brain"></i> Pending Suggestions</h3>
            <button class="btn btn-sm btn-secondary" id="btn-refresh-rules">
              <i class="fas fa-sync"></i> Refresh
            </button>
          </div>
          <p class="text-muted text-xs mb-12">AI-detected patterns from declined submissions. Approve to block future submissions.</p>
          <div id="ruleSuggestionsList" class="panel-muted">
            <div class="p-20 text-center text-muted">Loading...</div>
          </div>
        </div>

        <!-- Needs Manual Review -->
        <div>
          <div class="flex-between flex-center mb-12">
            <h3 class="text-blue m-0"><i class="fas fa-exclamation-circle"></i> Needs Manual Review</h3>
            <button class="btn btn-sm btn-secondary" id="btn-refresh-needs-review">
              <i class="fas fa-sync"></i> Refresh
            </button>
          </div>
          <p class="text-muted text-xs mb-12">Declines where AI couldn't detect a clear pattern. Create rules manually.</p>
          <div id="needsReviewList" class="panel-muted">
            <div class="p-20 text-center text-muted">Loading...</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Manual Rule Modal -->
  <div id="manualRuleModal" class="modal-overlay">
    <div class="modal modal-md">
      <div class="modal-header">
        <h2 class="modal-title">Create Manual Rule</h2>
        <button class="modal-close">&times;</button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="manualRuleSubmissionId">

        <div class="card-muted mb-16">
          <div class="text-xs text-muted">Decline Context</div>
          <div id="manualRuleContext" class="mt-4"></div>
        </div>

        <div class="form-group">
          <label>Rule Type *</label>
          <select id="manualRuleType">
            <option value="">Select...</option>
            <option value="industry_block">Industry Block</option>
            <option value="state_block">State Block</option>
            <option value="minimum_requirement">Minimum Requirement</option>
            <option value="position_restriction">Position Restriction</option>
            <option value="other">Other</option>
          </select>
        </div>

        <div class="form-group">
          <label>Industry (if blocking an industry)</label>
          <input type="text" id="manualRuleIndustry" placeholder="e.g., Trucking">
        </div>

        <div class="form-group">
          <label>State (if blocking a state)</label>
          <input type="text" id="manualRuleState" class="input-uppercase" placeholder="e.g., CA" maxlength="2">
        </div>

        <div class="form-group">
          <label>Condition (for minimum requirements)</label>
          <div class="form-row">
            <select id="manualRuleField" class="flex-1">
              <option value="">Field...</option>
              <option value="tib">Time in Business (months)</option>
              <option value="revenue">Monthly Revenue</option>
              <option value="fico">FICO Score</option>
              <option value="position">Position</option>
            </select>
            <select id="manualRuleOperator" class="w-80">
              <option value="min">Min</option>
              <option value="max">Max</option>
            </select>
            <input type="number" id="manualRuleValue" class="w-100" placeholder="Value">
          </div>
        </div>

        <div class="form-group">
          <label>Rule Description *</label>
          <input type="text" id="manualRuleMessage" placeholder="e.g., Does not fund trucking companies">
        </div>

        <div id="manualRuleError" class="error-msg hidden"></div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" id="manualRuleCancel">Cancel</button>
        <button class="btn btn-primary" id="saveManualRuleBtn">
          <i class="fas fa-save"></i> Save Rule
        </button>
      </div>
    </div>
  </div>

  <!-- Daily Reports Modal -->
  <div id="dailyReportsModal" class="modal-overlay">
    <div class="modal modal-xxl">
      <div class="modal-header">
        <h2 class="modal-title">ðŸ“Š Daily Operations Reports</h2>
        <button class="modal-close">&times;</button>
      </div>

      <!-- Tabs -->
      <div class="report-tabs">
        <button class="report-tab active" data-tab="daily">Daily Report</button>
        <button class="report-tab" data-tab="briefing">Broker Briefing</button>
        <button class="report-tab" data-tab="analytics">Broker Analytics</button>
      </div>

      <div class="modal-body modal-body-scroll-lg p-0">

        <!-- TAB: Daily Report -->
        <div id="tabDaily">
          <div class="sticky-bar">
            <div class="flex gap-10 flex-center">
              <input type="date" id="reportDate" class="broker-select">
              <button class="btn btn-primary btn-sm" id="btn-generate-report"><i class="fas fa-bolt"></i> Generate</button>
              <button class="btn btn-secondary btn-sm" id="btn-view-report"><i class="fas fa-eye"></i> View</button>
            </div>
            <div id="reportStatus" class="text-xs text-muted"></div>
          </div>
          <div id="reportStatsBar" class="report-stats hidden">
            <div class="flex gap-20 flex-wrap">
              <div class="report-stat"><span class="report-stat-num" id="statNewLeads">0</span><span class="report-stat-label">New Leads</span></div>
              <div class="report-stat"><span class="report-stat-num" id="statMsgsSent">0</span><span class="report-stat-label">Msgs Sent</span></div>
              <div class="report-stat"><span class="report-stat-num" id="statMsgsRecv">0</span><span class="report-stat-label">Msgs Received</span></div>
              <div class="report-stat"><span class="report-stat-num" id="statSubmissions">0</span><span class="report-stat-label">Submissions</span></div>
              <div class="report-stat"><span class="report-stat-num text-success" id="statOffers">0</span><span class="report-stat-label">Offers</span></div>
              <div class="report-stat"><span class="report-stat-num text-danger" id="statDeclines">0</span><span class="report-stat-label">Declines</span></div>
              <div class="report-stat"><span class="report-stat-num" id="statActive">0</span><span class="report-stat-label">Active Leads</span></div>
            </div>
          </div>
          <div id="reportContent" class="p-20">
            <div class="text-center text-muted p-40">Select a date and click <strong>View</strong> to load a report, or <strong>Generate</strong> to create a new one.</div>
          </div>
          <div class="px-20 pb-20">
            <h4 class="section-header">Recent Reports</h4>
            <div id="reportHistory" class="flex gap-8 flex-wrap"></div>
          </div>
        </div>

        <!-- TAB: Broker Briefing -->
        <div id="tabBriefing" class="hidden">
          <div class="sticky-bar">
            <div class="flex gap-10 flex-center flex-wrap">
              <select id="briefingBroker" class="broker-select">
                <option value="">Select broker...</option>
              </select>
              <select id="briefingMode" class="broker-select">
                <option value="today">Today</option>
                <option value="date">Pick Date</option>
              </select>
              <input type="date" id="briefingDate" class="broker-select hidden">
              <button class="btn btn-primary btn-sm" id="btn-generate-briefing"><i class="fas fa-bolt"></i> Generate Briefing</button>
              <button class="btn btn-secondary btn-sm" id="btn-quick-briefing"><i class="fas fa-eye"></i> Quick View</button>
            </div>
            <div id="briefingStatus" class="text-xs text-muted"></div>
          </div>
          <div id="briefingContent" class="p-20">
            <div class="text-center text-muted p-40">Select a broker to see their action briefing â€” what they need to do right now.</div>
          </div>
        </div>

        <!-- TAB: Broker Analytics -->
        <div id="tabAnalytics" class="hidden">
          <div class="sticky-bar">
            <div class="flex gap-10 flex-center flex-wrap">
              <select id="analyticsBroker" class="broker-select">
                <option value="">Select broker...</option>
              </select>
              <input type="date" id="analyticsStart" class="broker-select">
              <span class="text-muted">to</span>
              <input type="date" id="analyticsEnd" class="broker-select">
              <button class="btn btn-primary btn-sm" id="btn-generate-analytics"><i class="fas fa-chart-bar"></i> Analyze</button>
            </div>
            <div id="analyticsStatus" class="text-xs text-muted"></div>
          </div>
          <div id="analyticsContent" class="p-20">
            <div class="text-center text-muted p-40">Select a broker and date range to view their performance analytics.</div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <script src="/js/user-menu.js"></script>
  <script src="/js/admin.js"></script>

</body>
</html>
