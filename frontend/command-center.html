<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>MCAagent</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/command-center.css">

    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Additional styles for modular components -->
    <style>
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #111827;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #374151;
        }

        .modal-body {
            padding: 20px 24px;
        }

        .modal-footer {
            padding: 16px 24px 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Form Styles */
        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Button Styles */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-secondary {
            background-color: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background-color: #e5e7eb;
        }

        /* Processing Indicator Styles */
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .processing-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            min-width: 200px;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }

        .processing-text {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
        }

        .processing-subtext {
            font-size: 14px;
            color: #6b7280;
        }

        /* Intelligence Tab Content Styles */
        .intelligence-content .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .intelligence-content .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Form Section Styles */
        .form-section {
            margin-bottom: 24px;
        }

        .form-section h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
            color: #111827;
        }

        /* Document Selection Styles */
        #fcsDocumentSelection,
        #submissionDocumentList {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 12px;
            }

            .modal-content {
                margin: 20px;
                width: calc(100% - 40px);
                max-width: none;
            }
        }

        /* Edit Form Responsive Styles */
        .edit-form-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        /* Responsive form rows with max field widths */
        .edit-form-row,
        .edit-form-container .form-row {
            display: grid;
            gap: 16px;
            margin-bottom: 16px;
            grid-template-columns: repeat(auto-fit, minmax(200px, 350px));
        }

        /* Different grid layouts based on number of fields needed */
        .edit-form-row-2 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 350px));
        }

        .edit-form-row-3 {
            grid-template-columns: repeat(auto-fit, minmax(180px, 280px));
        }

        .edit-form-row-4 {
            grid-template-columns: repeat(auto-fit, minmax(150px, 250px));
        }

        .edit-form-row-5 {
            grid-template-columns: repeat(auto-fit, minmax(140px, 220px));
        }

        .edit-form-row-6 {
            grid-template-columns: repeat(auto-fit, minmax(120px, 200px));
        }

        /* Ensure form inputs don't stretch beyond reasonable widths */
        .edit-form-container .form-group input,
        .edit-form-container .form-group select,
        .edit-form-container .form-group textarea {
            width: 100%;
            max-width: 350px;
        }

        /* For fields that should be full width */
        .form-group.full-width input,
        .form-group.full-width textarea {
            max-width: 100% !important;
        }

        /* Section headers stay full width */
        .form-section h3 {
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        /* Responsive behavior for smaller screens */
        @media (max-width: 1400px) {
            .edit-form-container {
                max-width: 1000px;
            }
        }

        @media (max-width: 1200px) {
            .edit-form-container {
                max-width: 900px;
            }

            .edit-form-row-6 {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .edit-form-container {
                padding: 16px;
            }

            .edit-form-row-2,
            .edit-form-row-3,
            .edit-form-row-4,
            .edit-form-row-5,
            .edit-form-row-6 {
                grid-template-columns: 1fr;
            }

            .edit-form-container .form-group input,
            .edit-form-container .form-group select,
            .edit-form-container .form-group textarea {
                max-width: 100%;
            }
        }

        /* Fix for Edit tab form field widths */
        .edit-form-container {
            max-width: 1400px;
            padding: 20px;
        }

        .edit-form-container .form-row-six {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 220px));
            gap: 16px;
            margin-bottom: 16px;
        }

        .edit-form-container .form-group {
            width: 100%;
        }

        .edit-form-container .form-group input,
        .edit-form-container .form-group select,
        .edit-form-container .form-group textarea {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Ensure the grid doesn't stretch beyond reasonable sizes */
        .edit-form-container .form-section {
            margin-bottom: 24px;
        }

        .edit-form-container .form-section h4 {
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        /* For wider screens, limit the grid expansion */
        @media (min-width: 1400px) {
            .edit-form-container .form-row-six {
                grid-template-columns: repeat(6, minmax(150px, 200px));
            }
        }

        /* For medium screens */
        @media (max-width: 1200px) {
            .edit-form-container .form-row-six {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }

        /* For small screens */
        @media (max-width: 768px) {
            .edit-form-container .form-row-six {
                grid-template-columns: 1fr;
            }
        }

        /* Fix for ALL Edit tab form fields and rows */
        #intelligenceContent .edit-form-container .form-group,
        #intelligenceContent .form-group {
            display: inline-block;
            vertical-align: top;
            margin-right: 16px;
            margin-bottom: 16px;
            min-width: 150px;
            max-width: 220px;
        }

        #intelligenceContent .edit-form-container input,
        #intelligenceContent .edit-form-container select,
        #intelligenceContent .edit-form-container textarea,
        #intelligenceContent input[type="text"],
        #intelligenceContent input[type="number"],
        #intelligenceContent input[type="email"],
        #intelligenceContent input[type="tel"],
        #intelligenceContent input[type="url"],
        #intelligenceContent input[type="date"],
        #intelligenceContent select {
            width: 100% !important;
            max-width: 200px !important;
            box-sizing: border-box;
        }

        /* Target all form rows regardless of class name */
        #intelligenceContent .form-row,
        #intelligenceContent .form-row-two,
        #intelligenceContent .form-row-three,
        #intelligenceContent .form-row-four,
        #intelligenceContent .form-row-five,
        #intelligenceContent .form-row-six,
        #intelligenceContent [class*="form-row"] {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 16px;
        }

        /* Ensure form sections don't stretch */
        #intelligenceContent .form-section {
            max-width: 1400px;
            margin-bottom: 24px;
        }

        /* Override any inherited width styles */
        #intelligenceContent .form-section .form-group {
            flex: 0 0 auto !important;
            width: auto !important;
            max-width: 220px !important;
        }

        /* Specific handling for different row types */
        #intelligenceContent .form-row-six .form-group {
            flex: 0 1 calc(16.666% - 16px);
            min-width: 140px;
            max-width: 200px;
        }

        /* Ensure dropdowns don't stretch */
        #intelligenceContent select.form-input,
        #intelligenceContent .form-select {
            max-width: 220px !important;
        }

        /* For any row that doesn't have a specific class */
        #intelligenceContent .edit-form-container > div {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }

        #intelligenceContent .edit-form-container > div > .form-group {
            flex: 0 0 auto;
            max-width: 220px;
        }
    </style>
</head>
<body>
    <div class="command-center">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1 class="title">MCAagent</h1>
                <div class="connection-status" id="connectionStatus">
                    <span class="status-dot disconnected"></span>
                    <span class="status-text">Connecting...</span>
                </div>
            </div>
            <div class="header-right">
            </div>
        </header>

        <div class="main-content">
            <!-- Left Panel - Conversations List -->
            <div class="left-panel">
                <div class="panel-header">
                    <div class="panel-actions">
                        <button class="action-button primary" id="addLeadBtn" onclick="openNewLeadModal()">
                            New Conversation
                        </button>
                        <button class="action-button secondary" id="csvImportBtn" onclick="openCsvImportModal()">
                            Import Conversations
                        </button>
                        <button class="action-button secondary" id="toggleDeleteModeBtn" onclick="toggleDeleteMode()">
                            Delete Conversations
                        </button>
                        <button class="action-button danger" id="deleteSelectedBtn" style="display: none;">
                            Delete Selected
                        </button>
                    </div>
                    <div class="panel-controls">
                        <select class="state-filter" id="stateFilter">
                            <option value="">All States</option>
                            <option value="INTERESTED">Interested</option>
                            <option value="FCS_RUNNING">FCS Running</option>
                            <option value="COLLECTING_INFO">Collecting Info</option>
                            <option value="QUALIFIED">Qualified</option>
                            <option value="OFFER_SENT">Offer Sent</option>
                            <option value="NEGOTIATING">Negotiating</option>
                            <option value="ACCEPTED">Accepted</option>
                        </select>
                        <input type="text" class="search-field" id="searchInput" placeholder="Search conversations">
                    </div>
                </div>
                <div class="conversations-list" id="conversationsList">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>Loading conversations...</p>
                    </div>
                </div>
            </div>

            <!-- Center Panel - Conversation Thread -->
            <div class="center-panel">
                <div class="panel-header">
                    <div class="conversation-info" id="conversationInfo">
                        <h2>Select a conversation</h2>
                        <p>Choose a conversation from the left to view messages</p>
                    </div>
                    <!-- Center panel is now messaging-only - action buttons moved to right panel -->
                </div>
                <div class="messages-container" id="messagesContainer">
                    <div class="empty-state">
                        <div class="empty-icon">üí¨</div>
                        <h3>No conversation selected</h3>
                        <p>Select a conversation from the left panel to view the message thread</p>
                    </div>
                </div>
                <div class="message-input-container" id="messageInputContainer" style="display: none;">
                    <div class="ai-suggestions" id="aiSuggestions" style="display: none;">
                        <div class="suggestions-header">
                            <span>AI Suggestions:</span>
                            <button class="close-suggestions" id="closeSuggestions">√ó</button>
                        </div>
                        <div class="suggestions-list" id="suggestionsList"></div>
                    </div>
                    <div class="input-row">
                        <button class="attachment-icon" id="attachmentBtn" title="Attach file">üìé</button>
                        <textarea class="message-input" id="messageInput" placeholder="Message" rows="1"></textarea>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Lead Intelligence -->
            <div class="right-panel">
                <div class="panel-header">
                    <h2>Lead Intelligence</h2>
                    <div class="intelligence-tabs" id="intelligenceTabs">
                        <button class="tab-btn active" data-tab="ai-assistant">AI Agent</button>
                        <button class="tab-btn" data-tab="documents">Documents</button>
                        <button class="tab-btn" data-tab="edit">Edit</button>
                        <button class="tab-btn" data-tab="fcs">FCS</button>
                        <button class="tab-btn" data-tab="lenders">Lenders</button>
                        <button class="tab-btn" data-tab="lender-management">Manage Lenders</button>
                        <button class="tab-btn" data-tab="email">Email</button>
                    </div>
                </div>
                <div class="intelligence-content" id="intelligenceContent">
                    <div class="empty-state">
                        <div class="empty-icon">üìä</div>
                        <h3>No data available</h3>
                        <p>Select a conversation to view lead intelligence</p>
                    </div>

                    <!-- Hidden containers for different tabs -->
                    <div id="lenderForm" style="display: none;"></div>
                    <div id="lenderResults" style="display: none;"></div>
                    <div id="lenderLoading" style="display: none;"></div>
                    <div id="lenderErrorMsg" style="display: none;"></div>
                    <div id="lendersTableContainer" style="display: none;"></div>
                    <div id="lenderTibDisplay" style="display: none;"></div>
                    <div id="fcsDocumentSelection" style="display: none;"></div>
                    <div id="fcsResults" style="display: none;"></div>
                    <div id="fcsLoading" style="display: none;"></div>
                    <div id="fcsErrorMsg" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-left">
                <span id="lastUpdated">Last updated: Never</span>
            </div>
            <div class="status-center">
                <div class="processing-indicator" id="processingIndicator" style="display: none;">
                    <div class="loading-spinner small"></div>
                    <span id="processingText">Processing...</span>
                </div>
            </div>
            <div class="status-right">
                <span id="systemStatus">System: Ready</span>
            </div>
        </div>
    </div>

    <!-- Modals -->

    <!-- CSV Import Modal -->
    <div class="modal" id="csvImportModal" style="display: none;">
        <div class="modal-content" style="max-width: 900px; width: 90%; max-height: 90vh;">
            <div class="modal-header">
                <h3>üìä Import Conversations from CSV</h3>
                <button class="modal-close" id="closeCsvImportModal">√ó</button>
            </div>
            <div class="modal-body" style="max-height: calc(90vh - 130px); overflow-y: auto;">
                <!-- Progress Steps -->
                <div style="display: flex; justify-content: space-between; margin-bottom: 24px; gap: 8px;">
                    <div style="flex: 1; text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px; border: 2px solid transparent;" id="csvStep1" class="csv-step csv-step-active">
                        <div style="display: inline-block; width: 24px; height: 24px; background: #3b82f6; color: white; border-radius: 50%; line-height: 24px; margin-bottom: 6px; font-size: 12px; font-weight: 600;">1</div>
                        <div style="font-size: 13px; font-weight: 600; color: #374151;">Upload CSV</div>
                    </div>
                    <div style="flex: 1; text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px; border: 2px solid transparent;" id="csvStep2" class="csv-step">
                        <div style="display: inline-block; width: 24px; height: 24px; background: #9ca3af; color: white; border-radius: 50%; line-height: 24px; margin-bottom: 6px; font-size: 12px; font-weight: 600;">2</div>
                        <div style="font-size: 13px; font-weight: 600; color: #6b7280;">Map Columns</div>
                    </div>
                    <div style="flex: 1; text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px; border: 2px solid transparent;" id="csvStep3" class="csv-step">
                        <div style="display: inline-block; width: 24px; height: 24px; background: #9ca3af; color: white; border-radius: 50%; line-height: 24px; margin-bottom: 6px; font-size: 12px; font-weight: 600;">3</div>
                        <div style="font-size: 13px; font-weight: 600; color: #6b7280;">Validate</div>
                    </div>
                    <div style="flex: 1; text-align: center; padding: 12px; background: #f9fafb; border-radius: 6px; border: 2px solid transparent;" id="csvStep4" class="csv-step">
                        <div style="display: inline-block; width: 24px; height: 24px; background: #9ca3af; color: white; border-radius: 50%; line-height: 24px; margin-bottom: 6px; font-size: 12px; font-weight: 600;">4</div>
                        <div style="font-size: 13px; font-weight: 600; color: #6b7280;">Import</div>
                    </div>
                </div>

                <!-- Step 1: Upload -->
                <div id="csvUploadSection" class="csv-section">
                    <div style="border: 2px dashed #d1d5db; border-radius: 8px; padding: 32px; text-align: center; cursor: pointer; transition: all 0.3s;" id="csvUploadArea">
                        <div style="font-size: 48px; margin-bottom: 16px;">üìÑ</div>
                        <h4 style="margin: 0 0 8px 0; color: #111827;">Drag and drop your CSV file here</h4>
                        <p style="margin: 0 0 12px 0; color: #6b7280; font-size: 14px;">Or click to select a file</p>
                        <input type="file" style="display: none;" id="csvFileInput" accept=".csv" />
                        <button class="btn btn-primary" id="csvSelectFileBtn">Select File</button>
                    </div>
                    <div style="display: none; background: #f9fafb; padding: 16px; border-radius: 6px; margin-top: 16px;" id="csvFileInfo">
                        <h4 style="margin: 0 0 12px 0; color: #111827; font-size: 14px; font-weight: 600;">File Information</h4>
                        <div id="csvFileDetails"></div>
                    </div>
                </div>

                <!-- Step 2: Column Mapping -->
                <div id="csvMappingSection" class="csv-section" style="display: none;">
                    <h4 style="margin: 0 0 12px 0; color: #111827;">Map CSV Columns to Database Fields</h4>
                    <p style="margin: 0 0 16px 0; color: #6b7280; font-size: 14px;">Review the auto-detected column mappings and adjust as needed:</p>

                    <div style="overflow-x: auto; margin-bottom: 16px;">
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 6px; overflow: hidden; border: 1px solid #e5e7eb;" id="csvPreviewTable">
                            <thead id="csvPreviewHeader"></thead>
                            <tbody id="csvPreviewBody"></tbody>
                        </table>
                    </div>

                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px; margin: 16px 0;" id="csvMappingControls">
                        <!-- Column mapping controls will be populated here -->
                    </div>

                    <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                        <button class="btn btn-secondary" id="csvBackToUploadBtn">‚Üê Back to Upload</button>
                        <button class="btn btn-primary" id="csvValidateMappingBtn">Validate Mapping ‚úì</button>
                    </div>
                </div>

                <!-- Step 3: Validation -->
                <div id="csvValidationSection" class="csv-section" style="display: none;">
                    <h4 style="margin: 0 0 12px 0; color: #111827;">Data Validation</h4>
                    <p style="margin: 0 0 16px 0; color: #6b7280; font-size: 14px;">Review validation results and fix any issues:</p>

                    <div id="csvValidationResults"></div>

                    <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                        <button class="btn btn-secondary" id="csvBackToMappingBtn">‚Üê Back to Mapping</button>
                        <button class="btn btn-primary" id="csvProceedToImportBtn">Proceed to Import ‚Üí</button>
                    </div>
                </div>

                <!-- Step 4: Import -->
                <div id="csvImportSection" class="csv-section" style="display: none;">
                    <h4 style="margin: 0 0 12px 0; color: #111827;">Import Data</h4>
                    <p style="margin: 0 0 16px 0; color: #6b7280; font-size: 14px;">Importing your CSV data into the system...</p>

                    <div style="width: 100%; height: 20px; background: #e5e7eb; border-radius: 10px; overflow: hidden; margin: 16px 0;">
                        <div style="height: 100%; background: #3b82f6; transition: width 0.3s ease; border-radius: 10px; width: 0%;" id="csvProgressFill"></div>
                    </div>

                    <div id="csvImportStatus">
                        <div style="text-align: center; padding: 20px;">
                            <div class="spinner"></div>
                            <p style="margin: 16px 0 0 0; color: #6b7280;">Starting import process...</p>
                        </div>
                    </div>

                    <div style="display: flex; justify-content: flex-end; margin-top: 20px;">
                        <button class="btn btn-primary" style="display: none;" id="csvViewResultsBtn">üìä View Results</button>
                    </div>
                </div>

                <!-- Status Messages -->
                <div id="csvStatusMessages" style="margin-top: 16px;"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="lenderModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Qualify Lenders</h3>
                <button class="modal-close" id="closeLenderModal">√ó</button>
            </div>
            <div class="modal-body">
                <p>This will run lender qualification based on the current conversation data and FCS results (if available).</p>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="useExistingData" checked>
                        Use existing conversation and FCS data
                    </label>
                </div>
                <div class="form-group" id="manualDataGroup" style="display: none;">
                    <label>Business Name</label>
                    <input type="text" id="lenderBusinessName" class="form-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelLender">Cancel</button>
                <button class="btn btn-primary" id="confirmLender">Qualify Lenders</button>
            </div>
        </div>
    </div>

    <!-- Add Lead Modal -->
    <div class="modal" id="addLeadModal" style="display: none;">
        <div class="modal-content comprehensive-modal">
            <div class="modal-header">
                <h3>Add New Lead</h3>
                <button class="modal-close" id="closeAddLeadModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="edit-form-container">
                    <!-- Business Information Section -->
                    <div class="form-section">
                    <div class="section-header" onclick="toggleSection('businessInfo')">
                        <h4>üìä Business Information</h4>
                        <span class="section-toggle">‚àí</span>
                    </div>
                    <div class="section-content" id="businessInfo">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Company Name <span class="required">*</span></label>
                                <input type="text" id="companyName" class="form-input" placeholder="ABC Corporation">
                            </div>
                            <div class="form-group">
                                <label>Doing Business As (DBA)</label>
                                <input type="text" id="dbaName" class="form-input" placeholder="ABC Corp">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Primary Phone <span class="required">*</span></label>
                                <input type="tel" id="primaryPhone" class="form-input" placeholder="(555) 123-4567">
                            </div>
                            <div class="form-group">
                                <label>Business Phone</label>
                                <input type="tel" id="businessPhone" class="form-input" placeholder="(555) 987-6543">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Website</label>
                                <input type="url" id="website" class="form-input" placeholder="https://www.example.com">
                            </div>
                            <div class="form-group">
                                <label>Tax ID (Encrypted)</label>
                                <input type="text" id="federalTaxId" class="form-input" placeholder="12-3456789">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Entity Type</label>
                                <select id="entityType" class="form-select">
                                    <option value="">Select Entity Type...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Industry Type</label>
                                <select id="industryType" class="form-select">
                                    <option value="">Select Industry...</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Time in Business (Months)</label>
                                <input type="number" id="timeInBusiness" class="form-input" placeholder="24" min="1" max="999">
                            </div>
                            <div class="form-group">
                                <label>Requested Amount</label>
                                <input type="number" id="requestedAmount" class="form-input" placeholder="50000" min="1000" max="10000000" step="1000">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Monthly Revenue</label>
                                <input type="number" id="monthlyRevenue" class="form-input" placeholder="25000" min="0" max="50000000" step="1000">
                            </div>
                            <div class="form-group">
                                <label>Annual Revenue</label>
                                <input type="number" id="annualRevenue" class="form-input" placeholder="300000" min="0" max="500000000" step="10000">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Business Address</label>
                                <input type="text" id="businessAddress" class="form-input" placeholder="123 Main Street">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" id="businessCity" class="form-input" placeholder="Los Angeles">
                            </div>
                            <div class="form-group">
                                <label>State</label>
                                <select id="businessState" class="form-select">
                                    <option value="">Select State...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ZIP Code</label>
                                <input type="text" id="businessZip" class="form-input" placeholder="90210">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Lead Source</label>
                                <select id="leadSource" class="form-select">
                                    <option value="">Select Source...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Priority</label>
                                <select id="priority" class="form-select">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Owner Information Section -->
                <div class="form-section">
                    <div class="section-header" onclick="toggleSection('owner1Info')">
                        <h4>üë§ Owner Information</h4>
                        <span class="section-toggle">‚àí</span>
                    </div>
                    <div class="section-content" id="owner1Info">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Owner First Name</label>
                                <input type="text" id="owner1FirstName" class="form-input" placeholder="John">
                            </div>
                            <div class="form-group">
                                <label>Owner Last Name</label>
                                <input type="text" id="owner1LastName" class="form-input" placeholder="Smith">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Owner Email</label>
                                <input type="email" id="owner1Email" class="form-input" placeholder="john@example.com">
                            </div>
                            <div class="form-group">
                                <label>Owner Phone</label>
                                <input type="tel" id="owner1Phone" class="form-input" placeholder="(555) 123-4567">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Owner Ownership %</label>
                                <input type="number" id="owner1OwnershipPercentage" class="form-input" placeholder="50" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label>Owner Date of Birth</label>
                                <input type="date" id="owner1DateOfBirth" class="form-input">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Owner Home Address</label>
                                <input type="text" id="owner1HomeAddress" class="form-input" placeholder="456 Oak Street">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Owner City</label>
                                <input type="text" id="owner1HomeCity" class="form-input" placeholder="Los Angeles">
                            </div>
                            <div class="form-group">
                                <label>Owner State</label>
                                <select id="owner1HomeState" class="form-select">
                                    <option value="">Select State...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Owner ZIP Code</label>
                                <input type="text" id="owner1HomeZip" class="form-input" placeholder="90210">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Owner SSN (Encrypted)</label>
                                <input type="text" id="owner1SSN" class="form-input" placeholder="123-45-6789" maxlength="11">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Partner Information Section -->
                <div class="form-section">
                    <div class="section-header" onclick="toggleSection('owner2Info')">
                        <h4>üë§ Partner Information (Optional)</h4>
                        <span class="section-toggle">+</span>
                    </div>
                    <div class="section-content collapsed" id="owner2Info" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Partner First Name</label>
                                <input type="text" id="owner2FirstName" class="form-input" placeholder="Jane">
                            </div>
                            <div class="form-group">
                                <label>Partner Last Name</label>
                                <input type="text" id="owner2LastName" class="form-input" placeholder="Smith">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Partner Email</label>
                                <input type="email" id="owner2Email" class="form-input" placeholder="jane@example.com">
                            </div>
                            <div class="form-group">
                                <label>Partner Phone</label>
                                <input type="tel" id="owner2Phone" class="form-input" placeholder="(555) 987-6543">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Partner Ownership %</label>
                                <input type="number" id="owner2OwnershipPercentage" class="form-input" placeholder="50" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label>Partner Date of Birth</label>
                                <input type="date" id="owner2DateOfBirth" class="form-input">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Partner Home Address</label>
                                <input type="text" id="owner2HomeAddress" class="form-input" placeholder="789 Pine Street">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Partner City</label>
                                <input type="text" id="owner2HomeCity" class="form-input" placeholder="Los Angeles">
                            </div>
                            <div class="form-group">
                                <label>Partner State</label>
                                <select id="owner2HomeState" class="form-select">
                                    <option value="">Select State...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Partner ZIP Code</label>
                                <input type="text" id="owner2HomeZip" class="form-input" placeholder="90210">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Partner SSN (Encrypted)</label>
                                <input type="text" id="owner2SSN" class="form-input" placeholder="123-45-6789" maxlength="11">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Marketing and Notes Section -->
                <div class="form-section">
                    <div class="section-header" onclick="toggleSection('marketingNotes')">
                        <h4>üìß Marketing & Notes</h4>
                        <span class="section-toggle">+</span>
                    </div>
                    <div class="section-content collapsed" id="marketingNotes" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Marketing Notifications</label>
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="marketingNotification" value="TEXT">
                                        <span class="radio-indicator"></span>
                                        Text Only
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="marketingNotification" value="EMAIL">
                                        <span class="radio-indicator"></span>
                                        Email Only
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="marketingNotification" value="BOTH" checked>
                                        <span class="radio-indicator"></span>
                                        Both Text & Email
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Notes</label>
                                <textarea id="notes" class="form-textarea" rows="4" placeholder="Additional notes about this lead..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Lead Modal -->
    <div class="modal" id="editLeadModal" style="display: none;">
        <div class="modal-content comprehensive-modal">
            <div class="modal-header">
                <h3>Edit Lead - Comprehensive CRM</h3>
                <button class="modal-close" id="closeEditLeadModal">√ó</button>
            </div>
            <div class="modal-body">
                <div class="edit-form-container">
                    <!-- Business Information Section -->
                    <div class="form-section">
                    <div class="section-header" onclick="toggleSection('editBusinessInfo')">
                        <h4>üìä Business Information</h4>
                        <span class="section-toggle">‚àí</span>
                    </div>
                    <div class="section-content" id="editBusinessInfo">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Company Name <span class="required">*</span></label>
                                <input type="text" id="editCompanyName" class="form-input" placeholder="ABC Corporation">
                            </div>
                            <div class="form-group">
                                <label>Doing Business As (DBA)</label>
                                <input type="text" id="editDbaName" class="form-input" placeholder="ABC Corp">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Primary Phone <span class="required">*</span></label>
                                <input type="tel" id="editPrimaryPhone" class="form-input" placeholder="(555) 123-4567">
                            </div>
                            <div class="form-group">
                                <label>Business Phone</label>
                                <input type="tel" id="editBusinessPhone" class="form-input" placeholder="(555) 987-6543">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Website</label>
                                <input type="url" id="editWebsite" class="form-input" placeholder="https://www.example.com">
                            </div>
                            <div class="form-group">
                                <label>Tax ID (Encrypted)</label>
                                <input type="text" id="editTaxId" class="form-input" placeholder="12-3456789">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Entity Type</label>
                                <select id="editEntityType" class="form-select">
                                    <option value="">Select Entity Type...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Industry Type</label>
                                <select id="editIndustryType" class="form-select">
                                    <option value="">Select Industry...</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Time in Business (Months)</label>
                                <input type="number" id="editTimeInBusiness" class="form-input" placeholder="24" min="1" max="999">
                            </div>
                            <div class="form-group">
                                <label>Requested Amount</label>
                                <input type="number" id="editRequestedAmount" class="form-input" placeholder="50000" min="1000" max="10000000" step="1000">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Monthly Revenue</label>
                                <input type="number" id="editMonthlyRevenue" class="form-input" placeholder="25000" min="0" max="50000000" step="1000">
                            </div>
                            <div class="form-group">
                                <label>Annual Revenue</label>
                                <input type="number" id="editAnnualRevenue" class="form-input" placeholder="300000" min="0" max="500000000" step="10000">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Business Address</label>
                                <input type="text" id="editBusinessAddress" class="form-input" placeholder="123 Main Street">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" id="editBusinessCity" class="form-input" placeholder="Los Angeles">
                            </div>
                            <div class="form-group">
                                <label>State</label>
                                <select id="editBusinessState" class="form-select">
                                    <option value="">Select State...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ZIP Code</label>
                                <input type="text" id="editBusinessZip" class="form-input" placeholder="90210">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Lead Source</label>
                                <select id="editLeadSource" class="form-select">
                                    <option value="">Select Source...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Priority</label>
                                <select id="editPriority" class="form-select">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Owner Information Section -->
                <div class="form-section">
                    <div class="section-header" onclick="toggleSection('editOwner1Info')">
                        <h4>üë§ Owner Information</h4>
                        <span class="section-toggle">‚àí</span>
                    </div>
                    <div class="section-content" id="editOwner1Info">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Owner First Name</label>
                                <input type="text" id="editOwner1FirstName" class="form-input" placeholder="John">
                            </div>
                            <div class="form-group">
                                <label>Owner Last Name</label>
                                <input type="text" id="editOwner1LastName" class="form-input" placeholder="Smith">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Owner Email</label>
                                <input type="email" id="editOwner1Email" class="form-input" placeholder="john@example.com">
                            </div>
                            <div class="form-group">
                                <label>Owner Phone</label>
                                <input type="tel" id="editOwner1Phone" class="form-input" placeholder="(555) 123-4567">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Owner Ownership %</label>
                                <input type="number" id="editOwner1Ownership" class="form-input" placeholder="50" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label>Owner Date of Birth</label>
                                <input type="date" id="editOwner1DOB" class="form-input">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Owner Home Address</label>
                                <input type="text" id="editOwner1HomeAddress" class="form-input" placeholder="456 Oak Street">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Owner City</label>
                                <input type="text" id="editOwner1HomeCity" class="form-input" placeholder="Los Angeles">
                            </div>
                            <div class="form-group">
                                <label>Owner State</label>
                                <select id="editOwner1HomeState" class="form-select">
                                    <option value="">Select State...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Owner ZIP Code</label>
                                <input type="text" id="editOwner1HomeZip" class="form-input" placeholder="90210">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Owner SSN (Encrypted)</label>
                                <input type="text" id="editOwner1SSN" class="form-input" placeholder="123-45-6789" maxlength="11">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Partner Information Section -->
                <div class="form-section">
                    <div class="section-header" onclick="toggleSection('editOwner2Info')">
                        <h4>üë§ Partner Information (Optional)</h4>
                        <span class="section-toggle">+</span>
                    </div>
                    <div class="section-content collapsed" id="editOwner2Info" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Partner First Name</label>
                                <input type="text" id="editOwner2FirstName" class="form-input" placeholder="Jane">
                            </div>
                            <div class="form-group">
                                <label>Partner Last Name</label>
                                <input type="text" id="editOwner2LastName" class="form-input" placeholder="Smith">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Partner Email</label>
                                <input type="email" id="editOwner2Email" class="form-input" placeholder="jane@example.com">
                            </div>
                            <div class="form-group">
                                <label>Partner Phone</label>
                                <input type="tel" id="editOwner2Phone" class="form-input" placeholder="(555) 987-6543">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Partner Ownership %</label>
                                <input type="number" id="editOwner2Ownership" class="form-input" placeholder="50" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label>Partner Date of Birth</label>
                                <input type="date" id="editOwner2DOB" class="form-input">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Partner Home Address</label>
                                <input type="text" id="editOwner2HomeAddress" class="form-input" placeholder="789 Pine Street">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Partner City</label>
                                <input type="text" id="editOwner2HomeCity" class="form-input" placeholder="Los Angeles">
                            </div>
                            <div class="form-group">
                                <label>Partner State</label>
                                <select id="editOwner2HomeState" class="form-select">
                                    <option value="">Select State...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Partner ZIP Code</label>
                                <input type="text" id="editOwner2HomeZip" class="form-input" placeholder="90210">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Partner SSN (Encrypted)</label>
                                <input type="text" id="editOwner2SSN" class="form-input" placeholder="123-45-6789" maxlength="11">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Marketing and Notes Section -->
                <div class="form-section">
                    <div class="section-header" onclick="toggleSection('editMarketingNotes')">
                        <h4>üìß Marketing & Notes</h4>
                        <span class="section-toggle">+</span>
                    </div>
                    <div class="section-content collapsed" id="editMarketingNotes" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Marketing Notifications</label>
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="editMarketingNotification" value="TEXT">
                                        <span class="radio-indicator"></span>
                                        Text Only
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="editMarketingNotification" value="EMAIL">
                                        <span class="radio-indicator"></span>
                                        Email Only
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="editMarketingNotification" value="BOTH" checked>
                                        <span class="radio-indicator"></span>
                                        Both Text & Email
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Notes</label>
                                <textarea id="editNotes" class="form-textarea" rows="4" placeholder="Additional notes about this lead..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditLead">Cancel</button>
                <button class="btn btn-primary" id="saveEditLead">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Edit Lead Inline Modal -->
    <div class="modal" id="editLeadInlineModal" style="display: none;">
        <div class="modal-content" style="max-width: 1200px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Edit Lead Information</h3>
                <button class="modal-close" id="closeEditLeadInlineModal">&times;</button>
            </div>
            <div class="modal-body" id="editLeadInlineContent">
                <!-- Form content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Lenders Inline Modal -->
    <div class="modal" id="lendersInlineModal" style="display: none;">
        <div class="modal-content" style="max-width: 1400px; width: 95%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Lender Qualification & Submission</h3>
                <button class="modal-close" id="closeLendersInlineModal">&times;</button>
            </div>
            <div class="modal-body" id="lendersInlineContent">
                <!-- Lender form content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Confirmation Dialogs -->
    <div class="modal" id="deleteConfirmModal" style="display: none;">
        <div class="modal-content small-modal">
            <div class="modal-header">
                <h3>‚ö†Ô∏è Delete Lead</h3>
                <button class="modal-close" id="closeDeleteConfirmModal">√ó</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to <strong>permanently delete</strong> this lead?</p>
                <p class="warning-text">This action cannot be undone. All messages, FCS results, and lead data will be permanently removed.</p>
                <div class="lead-info" id="deleteLeadInfo">
                    <strong>Lead:</strong> <span id="deleteLeadName">Loading...</span><br>
                    <strong>Phone:</strong> <span id="deleteLeadPhone">Loading...</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelDelete">Cancel</button>
                <button class="btn btn-danger" id="confirmDelete">Delete Lead</button>
            </div>
        </div>
    </div>

    <div class="modal" id="archiveConfirmModal" style="display: none;">
        <div class="modal-content small-modal">
            <div class="modal-header">
                <h3>üì¶ Archive Lead</h3>
                <button class="modal-close" id="closeArchiveConfirmModal">√ó</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to <strong>archive</strong> this lead?</p>
                <p class="info-text">Archived leads can be restored later but won't appear in active conversations.</p>
                <div class="lead-info" id="archiveLeadInfo">
                    <strong>Lead:</strong> <span id="archiveLeadName">Loading...</span><br>
                    <strong>Phone:</strong> <span id="archiveLeadPhone">Loading...</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelArchive">Cancel</button>
                <button class="btn btn-primary" id="confirmArchive">Archive Lead</button>
            </div>
        </div>
    </div>

    <!-- Signature Modal -->
    <div class="modal" id="signatureModal" style="display: none;">
        <div class="modal-content signature-modal">
            <div class="modal-header">
                <h3>Sign Application</h3>
                <button class="modal-close" id="closeSignatureModal">√ó</button>
            </div>
            <div class="modal-body">
                <p>Please sign below to authorize this Working Capital Application:</p>
                <div class="signature-container">
                    <canvas id="signatureCanvas" width="400" height="200"></canvas>
                </div>
                <div class="signature-controls">
                    <button class="btn btn-secondary" id="clearSignature">Clear</button>
                    <button class="btn btn-secondary" id="useTypedSignature">Use Typed Name</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelSignature">Cancel</button>
                <button class="btn btn-primary" id="confirmSignature">Generate Application</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="notifications" id="notifications"></div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script>
        // Initialize WebSocket connection immediately after Socket.io loads
        if (typeof io !== 'undefined') {
            console.log('‚úÖ Socket.io loaded successfully');
            
            // Create global WebSocket connection
            window.globalSocket = io('http://localhost:3001', {
                transports: ['websocket', 'polling'],
                timeout: 20000
            });
            
            window.globalSocket.on('connect', () => {
                console.log('üîå Connected to WebSocket server:', window.globalSocket.id);
            });
            
            window.globalSocket.on('disconnect', () => {
                console.log('‚ùå Disconnected from WebSocket server');
            });
            
            window.globalSocket.on('new_message', (data) => {
                console.log('üì® New message received via WebSocket:', data);
                
                // If we have conversation UI loaded, use the new handler method
                if (window.conversationUI && window.conversationUI.handleIncomingMessage) {
                    window.conversationUI.handleIncomingMessage(data);
                } else {
                    console.log('‚ö†Ô∏è ConversationUI not yet loaded, message will be shown when UI initializes');
                }
            });
            
            window.globalSocket.on('conversation_updated', (data) => {
                console.log('üìã Conversation updated via WebSocket:', data);
                
                // Refresh conversation list
                if (window.conversationUI) {
                    window.conversationUI.loadConversations();
                }
            });
            
            // Test connection
            window.globalSocket.emit('test', 'Hello from frontend!');
            
        } else {
            console.error('‚ùå Socket.io failed to load from CDN');
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <!-- 1. Utilities FIRST (no dependencies) -->
    <script src="js/templates-utilities.js"></script>

    <!-- 2. WebSocket (no dependencies on other modules) -->
    <script src="js/websocket.js"></script>

    <!-- 3. Core modules (depend on utilities) -->
    <script src="js/conversation-core.js"></script>
    <script src="js/messaging.js"></script>
    <script src="js/documents.js"></script>
    <script src="js/intelligence-tabs.js"></script>
    <script src="js/fcs-module.js"></script>
    <script src="js/lenders.js"></script>
    <script src="js/ai-assistant.js"></script>
    <script src="js/email-tab.js"></script>
    <script src="js/stats.js"></script>
    <script src="js/csv-import-modal.js"></script>

    <!-- New Lead Form Generator -->
    <script src="js/new-lead-form.js"></script>

    <!-- 4. Main app LAST (depends on everything) -->
    <script src="js/command-center.js"></script>
    <script>
        // Comprehensive CRM Form Functions
        let lookupData = {};
        
        // Load lookup data for dropdowns
        async function loadLookupData() {
            try {
                console.log('üîß Loading lookup data for dropdowns...');
                
                // For now, use static data since server might be having issues
                lookupData = {
                    states: [
                        { code: 'CA', name: 'California' },
                        { code: 'NY', name: 'New York' },
                        { code: 'TX', name: 'Texas' },
                        { code: 'FL', name: 'Florida' },
                        { code: 'IL', name: 'Illinois' }
                    ],
                    entityTypes: [
                        { id: 1, name: 'Corporation' },
                        { id: 2, name: 'LLC' },
                        { id: 3, name: 'Partnership' },
                        { id: 4, name: 'Sole Proprietorship' }
                    ],
                    industryTypes: [
                        { id: 1, name: 'Construction' },
                        { id: 2, name: 'Restaurant' },
                        { id: 3, name: 'Retail' },
                        { id: 4, name: 'Professional Services' },
                        { id: 5, name: 'Manufacturing' }
                    ],
                    leadSources: [
                        { id: 1, name: 'Google Ads' },
                        { id: 2, name: 'Facebook' },
                        { id: 3, name: 'LinkedIn' },
                        { id: 4, name: 'Referral' },
                        { id: 5, name: 'Website' }
                    ],
                    users: [
                        { id: 1, first_name: 'John', last_name: 'Smith' },
                        { id: 2, first_name: 'Sarah', last_name: 'Johnson' },
                        { id: 3, first_name: 'Mike', last_name: 'Wilson' }
                    ]
                };
                
                console.log('‚úÖ Lookup data loaded successfully');
                populateDropdowns();
            } catch (error) {
                console.error('‚ùå Error loading lookup data:', error);
                // Initialize with empty arrays to prevent errors
                if (!lookupData || typeof lookupData !== 'object') {
                    lookupData = {
                        states: [],
                        entityTypes: [],
                        industryTypes: [],
                        leadSources: [],
                        users: []
                    };
                }
                console.log('‚ö†Ô∏è Using fallback empty data');
                populateDropdowns();
            }
        }
        
        // Populate dropdown options
        function populateDropdowns() {
            try {
                console.log('üîß Populating dropdowns with lookup data...');
                
                // Check if lookupData is properly loaded
                if (!lookupData || typeof lookupData !== 'object') {
                    console.warn('‚ö†Ô∏è lookupData is not available, skipping dropdown population');
                    return;
                }
                
                // States
                const stateSelects = ['businessState', 'stateOfIncorporation', 'owner1HomeState', 'owner2HomeState'];
                if (lookupData.states && Array.isArray(lookupData.states)) {
                    stateSelects.forEach(selectId => {
                        const select = document.getElementById(selectId);
                        if (select) {
                            select.innerHTML = '<option value="">Select State...</option>';
                            lookupData.states.forEach(state => {
                                select.innerHTML += `<option value="${state.code}">${state.name}</option>`;
                            });
                        }
                    });
                    console.log('‚úÖ States populated successfully');
                } else {
                    console.warn('‚ö†Ô∏è States data not available');
                }
                
                // Entity Types
                const entitySelect = document.getElementById('entityType');
                if (entitySelect && lookupData.entityTypes && Array.isArray(lookupData.entityTypes)) {
                    entitySelect.innerHTML = '<option value="">Select Entity Type...</option>';
                    lookupData.entityTypes.forEach(type => {
                        entitySelect.innerHTML += `<option value="${type.name}">${type.name}</option>`;
                    });
                    console.log('‚úÖ Entity types populated successfully');
                } else {
                    console.warn('‚ö†Ô∏è Entity types data not available');
                }
                
                // Industry Types
                const industrySelect = document.getElementById('industryType');
                if (industrySelect && lookupData.industryTypes && Array.isArray(lookupData.industryTypes)) {
                    industrySelect.innerHTML = '<option value="">Select Industry...</option>';
                    lookupData.industryTypes.forEach(type => {
                        industrySelect.innerHTML += `<option value="${type.name}">${type.name}</option>`;
                    });
                    console.log('‚úÖ Industry types populated successfully');
                } else {
                    console.warn('‚ö†Ô∏è Industry types data not available');
                }
                
                // Lead Sources
                const leadSourceSelect = document.getElementById('leadSource');
                if (leadSourceSelect && lookupData.leadSources && Array.isArray(lookupData.leadSources)) {
                    leadSourceSelect.innerHTML = '<option value="">Select Lead Source...</option>';
                    lookupData.leadSources.forEach(source => {
                        leadSourceSelect.innerHTML += `<option value="${source.name}">${source.name}</option>`;
                    });
                    console.log('‚úÖ Lead sources populated successfully');
                } else {
                    console.warn('‚ö†Ô∏è Lead sources data not available');
                }
                
                // Users
                const assignedToSelect = document.getElementById('assignedTo');
                if (assignedToSelect && lookupData.users && Array.isArray(lookupData.users)) {
                    assignedToSelect.innerHTML = '<option value="">Select User...</option>';
                    lookupData.users.forEach(user => {
                        assignedToSelect.innerHTML += `<option value="${user.first_name} ${user.last_name}">${user.first_name} ${user.last_name}</option>`;
                    });
                    console.log('‚úÖ Users populated successfully');
                } else {
                    console.warn('‚ö†Ô∏è Users data not available');
                }
                
                console.log('‚úÖ Dropdown population completed');
            } catch (error) {
                console.error('‚ùå Error populating dropdowns:', error);
                // Don't throw the error to prevent the global error handler from triggering
            }
        }
        
        // Toggle collapsible sections
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const toggle = content.previousElementSibling.querySelector('.section-toggle');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.textContent = '‚àí';
                toggle.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                toggle.textContent = '+';
                toggle.classList.add('collapsed');
            }
        }
        
        // Toggle Partner section
        function toggleOwner2Section() {
            try {
                console.log('üîÑ Toggling Partner section...');
                
                const checkbox = document.getElementById('addSecondOwner');
                const owner2Info = document.getElementById('owner2Info');
                const owner2Toggle = document.getElementById('owner2Toggle');
                
                if (!checkbox) {
                    console.warn('‚ö†Ô∏è addSecondOwner checkbox not found');
                    return;
                }
                
                if (!owner2Info) {
                    console.warn('‚ö†Ô∏è owner2Info element not found');
                    return;
                }
                
                if (!owner2Toggle) {
                    console.warn('‚ö†Ô∏è owner2Toggle element not found');
                    return;
                }
                
                if (checkbox.checked) {
                    owner2Info.style.display = 'block';
                    owner2Toggle.style.display = 'block';
                    console.log('‚úÖ Partner section shown');
                } else {
                    owner2Info.style.display = 'none';
                    owner2Toggle.style.display = 'none';
                    console.log('‚úÖ Partner section hidden');
                    
                    // Clear Partner fields safely
                    try {
                        const owner2Fields = owner2Info.querySelectorAll('input, select');
                        owner2Fields.forEach((field, index) => {
                            try {
                                field.value = '';
                            } catch (fieldError) {
                                console.warn(`‚ö†Ô∏è Error clearing Partner field ${index}:`, fieldError);
                            }
                        });
                        console.log('‚úÖ Partner fields cleared');
                    } catch (clearError) {
                        console.warn('‚ö†Ô∏è Error clearing Partner fields:', clearError);
                    }
                }
                
            } catch (error) {
                console.error('üö® Error in toggleOwner2Section:', error);
                // Don't re-throw, just log and continue
            }
        }
        
        // Collect comprehensive form data
        function collectComprehensiveFormData() {
            const formData = {
                // Business Information
                companyName: document.getElementById('companyName').value,
                dbaName: document.getElementById('dbaName').value,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                businessAddress: document.getElementById('businessAddress').value,
                businessAddress2: document.getElementById('businessAddress2').value,
                businessCountry: document.getElementById('businessCountry').value,
                businessState: document.getElementById('businessState').value,
                businessCity: document.getElementById('businessCity').value,
                businessZip: document.getElementById('businessZip').value,
                primaryPhone: document.getElementById('primaryPhone').value,
                cellPhone: document.getElementById('cellPhone').value,
                workPhone: document.getElementById('workPhone').value,
                faxPhone: document.getElementById('faxPhone').value,
                federalTaxId: document.getElementById('federalTaxId').value,
                businessStartDate: document.getElementById('businessStartDate').value,
                lengthOfOwnership: document.getElementById('lengthOfOwnership').value,
                website: document.getElementById('website').value,
                stateOfIncorporation: document.getElementById('stateOfIncorporation').value,
                entityType: document.getElementById('entityType').value,
                industryType: document.getElementById('industryType').value,
                businessEmail: document.getElementById('businessEmail').value,
                productSold: document.getElementById('productSold').value,
                useOfProceeds: document.getElementById('useOfProceeds').value,
                annualRevenue: document.getElementById('annualRevenue').value,
                monthlyRevenue: document.getElementById('monthlyRevenue').value,
                requestedAmount: document.getElementById('requestedAmount').value,
                leadSource: document.getElementById('leadSource').value,
                leadStatus: document.getElementById('leadStatus').value,
                assignedTo: document.getElementById('assignedTo').value,
                disposition: document.getElementById('disposition').value,
                campaign: document.getElementById('campaign').value,
                optOutDripCampaign: document.getElementById('optOutDripCampaign').value === 'true',
                marketingNotification: document.querySelector('input[name="marketingNotification"]:checked')?.value || 'BOTH',
                
                // Owner Information
                owner1: {
                    firstName: document.getElementById('owner1FirstName').value,
                    lastName: document.getElementById('owner1LastName').value,
                    email: document.getElementById('owner1Email').value,
                    ownershipPercentage: document.getElementById('owner1OwnershipPercentage').value,
                    homeAddress: document.getElementById('owner1HomeAddress').value,
                    homeAddress2: document.getElementById('owner1HomeAddress2').value,
                    homeCountry: document.getElementById('owner1HomeCountry').value,
                    homeState: document.getElementById('owner1HomeState').value,
                    homeCity: document.getElementById('owner1HomeCity').value,
                    homeZip: document.getElementById('owner1HomeZip').value,
                    ssn: document.getElementById('owner1SSN').value,
                    dateOfBirth: document.getElementById('owner1DateOfBirth').value
                }
            };
            
            // Add Partner if checkbox is checked
            if (document.getElementById('addSecondOwner').checked) {
                formData.owner2 = {
                    firstName: document.getElementById('owner2FirstName').value,
                    lastName: document.getElementById('owner2LastName').value,
                    email: document.getElementById('owner2Email').value,
                    ownershipPercentage: document.getElementById('owner2OwnershipPercentage').value,
                    homeAddress: document.getElementById('owner2HomeAddress').value,
                    homeAddress2: document.getElementById('owner2HomeAddress2').value,
                    homeCountry: document.getElementById('owner2HomeCountry').value,
                    homeState: document.getElementById('owner2HomeState').value,
                    homeCity: document.getElementById('owner2HomeCity').value,
                    homeZip: document.getElementById('owner2HomeZip').value,
                    ssn: document.getElementById('owner2SSN').value,
                    dateOfBirth: document.getElementById('owner2DateOfBirth').value
                };
            }
            
            return formData;
        }
        
        // Validate comprehensive form
        function validateComprehensiveForm(data) {
            const errors = [];
            
            // Required fields
            if (!data.companyName) errors.push('Company Name is required');
            if (!data.primaryPhone) errors.push('Primary Phone is required');
            
            // Phone validation
            const phoneRegex = /^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/;
            if (data.primaryPhone && !phoneRegex.test(data.primaryPhone)) {
                errors.push('Primary Phone must be a valid phone number');
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (data.businessEmail && !emailRegex.test(data.businessEmail)) {
                errors.push('Business Email must be valid');
            }
            
            if (data.owner1?.email && !emailRegex.test(data.owner1.email)) {
                errors.push('Owner Email must be valid');
            }
            
            if (data.owner2?.email && !emailRegex.test(data.owner2.email)) {
                errors.push('Partner Email must be valid');
            }
            
            return errors;
        }
        
        // Clear comprehensive form with null safety
        function clearComprehensiveForm() {
            try {
                console.log('üßπ Clearing comprehensive form...');
                const modal = document.getElementById('addLeadModal');
                
                if (!modal) {
                    console.warn('‚ö†Ô∏è Modal not found, skipping form clear');
                    return;
                }
                
                const inputs = modal.querySelectorAll('input, select, textarea');
                console.log(`üîç Found ${inputs.length} form inputs to clear`);
                
                inputs.forEach((input, index) => {
                    try {
                        if (input.type === 'radio') {
                            input.checked = input.value === 'BOTH' && input.name === 'marketingNotification';
                        } else if (input.type === 'checkbox') {
                            input.checked = false;
                        } else {
                            input.value = '';
                        }
                    } catch (inputError) {
                        console.warn(`‚ö†Ô∏è Error clearing input ${index}:`, inputError);
                    }
                });
                
                // Reset lead status to default (with null check)
                const leadStatusEl = document.getElementById('leadStatus');
                if (leadStatusEl) {
                    leadStatusEl.value = 'SUBMITTED';
                    console.log('‚úÖ Lead status reset to SUBMITTED');
                } else {
                    console.warn('‚ö†Ô∏è leadStatus element not found');
                }
                
                // Hide Partner section (with null checks)
                const owner2Info = document.getElementById('owner2Info');
                const owner2Toggle = document.getElementById('owner2Toggle');
                
                if (owner2Info) {
                    owner2Info.style.display = 'none';
                    console.log('‚úÖ Partner info hidden');
                } else {
                    console.warn('‚ö†Ô∏è owner2Info element not found');
                }
                
                if (owner2Toggle) {
                    owner2Toggle.style.display = 'none';
                    console.log('‚úÖ Partner toggle hidden');
                } else {
                    console.warn('‚ö†Ô∏è owner2Toggle element not found');
                }
                
                console.log('‚úÖ Form cleared successfully');
                
            } catch (error) {
                console.error('üö® Error in clearComprehensiveForm:', error);
                // Don't re-throw error - just log and continue silently
                // This prevents modal opening issues
            }
        }
        
        // DEPRECATED - These functions are replaced by the event listener in DOMContentLoaded
        // See line ~3260 for the new Add Lead button handler
        /*
        function showEditModalForNewLead() { ... }
        function openAddLeadModal() { ... }
        */

        // Clear edit form function
        function clearEditForm() {
            const modal = document.getElementById('editLeadModal');
            if (!modal) return;

            console.log('üßπ Clearing edit form...');

            const inputs = modal.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.type === 'radio') {
                    input.checked = input.value === 'BOTH' && input.name === 'editMarketingNotification';
                } else if (input.type === 'checkbox') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });

            console.log('‚úÖ Form cleared');
        }
        
        // DEPRECATED - testSimpleAdd function removed
        // Use the Add Lead button which opens the Edit modal in create mode
        
        // Enhanced debug logging
        console.log('üîß Main script loading...');
        
        // Debug all required classes
        window.debugClasses = function() {
            console.log('üîç Class availability check:');
            console.log('- CommandCenter:', typeof CommandCenter);
            console.log('- ConversationUI:', typeof ConversationUI);
            console.log('- StateManager:', typeof StateManager);
            console.log('- WebSocketManager:', typeof WebSocketManager);
        };
        
        // Debug API connection
        window.testAPI = async function() {
            console.log('üß™ Testing API connection...');
            try {
                const response = await fetch('http://localhost:3001/api/conversations');
                const data = await response.json();
                console.log('‚úÖ API Response:', data);
                return data;
            } catch (error) {
                console.error('‚ùå API Error:', error);
                return null;
            }
        };
        
        // Force conversations reload
        window.forceReload = function() {
            console.log('üöÄ Force reload conversations...');
            fetch('http://localhost:3001/api/conversations')
                .then(response => response.json())
                .then(data => {
                    console.log('üìã Got conversations data:', data);
                    if (window.commandCenter && window.commandCenter.conversationUI) {
                        // Force update the UI
                        const conversationsList = document.getElementById('conversationsList');
                        if (conversationsList) {
                            conversationsList.innerHTML = '<div class="loading">‚úÖ API Working - Found ' + data.length + ' conversations</div>';
                        }
                    }
                })
                .catch(error => {
                    console.error('‚ùå Force reload failed:', error);
                    const conversationsList = document.getElementById('conversationsList');
                    if (conversationsList) {
                        conversationsList.innerHTML = '<div class="error">‚ùå API Error: ' + error.message + '</div>';
                    }
                });
        };
        
        // Debug DOM elements
        window.debugDOM = function() {
            console.log('üîç DOM elements check:');
            const addLeadBtn = document.getElementById('addLeadBtn');
            const testBtn = document.getElementById('testAddLeadBtn');
            const modal = document.getElementById('addLeadModal');
            
            console.log('- Add Lead Button:', addLeadBtn);
            console.log('- Add Lead Button text:', addLeadBtn ? addLeadBtn.textContent : 'null');
            console.log('- Add Lead Button visible:', addLeadBtn ? (addLeadBtn.offsetWidth > 0 && addLeadBtn.offsetHeight > 0) : false);
            console.log('- Test Button:', testBtn);
            console.log('- Test Button visible:', testBtn ? (testBtn.offsetWidth > 0 && testBtn.offsetHeight > 0) : false);
            console.log('- Add Lead Modal:', modal);
        };
        
        // Manual button test
        window.testAddLeadButton = function() {
            const modal = document.getElementById('addLeadModal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('‚úÖ Modal opened manually');
            } else {
                console.log('‚ùå Modal not found');
            }
        };
        
        // Initialize comprehensive form
        function initializeComprehensiveForm() {
            console.log('üîß Initializing comprehensive form...');
            
            // Load lookup data
            loadLookupData();
            
            // Set up modal event listeners
            const modal = document.getElementById('addLeadModal');
            const closeBtn = document.getElementById('closeAddLeadModal');
            const cancelBtn = document.getElementById('cancelAddLead');
            const confirmBtn = document.getElementById('confirmAddLead');
            
            if (!modal) {
                console.warn('‚ö†Ô∏è Modal not found during initialization');
                return;
            }
            
            if (closeBtn) {
                closeBtn.onclick = () => {
                    modal.style.display = 'none';
                    clearComprehensiveForm();
                };
            }
            
            if (cancelBtn) {
                cancelBtn.onclick = () => {
                    modal.style.display = 'none';
                    clearComprehensiveForm();
                };
            }
            
            if (confirmBtn) {
                confirmBtn.onclick = async () => {
                    console.log('üöÄ Creating comprehensive lead...');
                    
                    const formData = collectComprehensiveFormData();
                    const errors = validateComprehensiveForm(formData);
                    
                    if (errors.length > 0) {
                        alert('Please fix the following errors:\n' + errors.join('\n'));
                        return;
                    }
                    
                    try {
                        // For now, create a simplified lead for the existing API
                        const leadData = {
                            businessName: formData.companyName,
                            phone: formData.primaryPhone,
                            message: `Comprehensive lead created from CRM form. Industry: ${formData.industryType}`,
                            requestedAmount: formData.requestedAmount,
                            priority: 'normal'
                        };
                        
                        console.log('üì§ Sending lead data:', leadData);
                        
                        const response = await fetch('http://localhost:3001/api/conversations', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(leadData)
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            alert('‚úÖ Lead created successfully!');
                            modal.style.display = 'none';
                            clearComprehensiveForm();
                            location.reload(); // Refresh to show new lead
                        } else {
                            alert('‚ùå Error creating lead: ' + (result.error || 'Unknown error'));
                        }
                        
                    } catch (error) {
                        console.error('Error creating lead:', error);
                        alert('‚ùå Connection error: ' + error.message);
                    }
                };
            }
            
            // Close modal when clicking outside
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    clearComprehensiveForm();
                }
            };
            
            console.log('‚úÖ Comprehensive form initialized');
        }
        
        // Initialize the command center
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üöÄ DOM Content Loaded');

            // Initialize comprehensive form - Re-enabled for standalone Add Lead modal
            setTimeout(initializeComprehensiveForm, 100);
            
            // Run debug checks
            setTimeout(debugClasses, 100);
            setTimeout(debugDOM, 500);
            
            try {
                // Check if classes are available
                if (typeof CommandCenter === 'undefined') {
                    console.error('‚ùå CommandCenter class not loaded!');
                    return;
                }
                
                window.commandCenter = new CommandCenter();
                console.log('‚úÖ CommandCenter instance created and initialized');
                
                // Add reload conversations function
                window.reloadConversations = function() {
                    console.log('üîÑ Manual reload conversations triggered');
                    if (window.commandCenter && window.commandCenter.conversationUI) {
                        window.commandCenter.conversationUI.loadConversations();
                    } else {
                        console.error('‚ùå CommandCenter or ConversationUI not available');
                    }
                };
                
                // Add manual reload function for button
                window.manualReloadConversations = function() {
                    console.log('üîÑ Manual button reload triggered');
                    try {
                        if (window.commandCenter && window.commandCenter.conversationUI) {
                            console.log('üì° Calling loadInitialData...');
                            window.commandCenter.conversationUI.loadInitialData();
                        } else {
                            console.error('‚ùå CommandCenter or ConversationUI not available');
                            alert('CommandCenter not initialized yet. Please wait and try again.');
                        }
                    } catch (error) {
                        console.error('‚ùå Manual reload error:', error);
                        alert('Error reloading: ' + error.message);
                    }
                };
                
                // Auto-retry conversations loading after delay
                setTimeout(() => {
                    console.log('‚è∞ Auto-retry conversations loading...');
                    if (window.commandCenter && window.commandCenter.conversationUI) {
                        const conversationsList = document.getElementById('conversationsList');
                        if (conversationsList && conversationsList.innerHTML.includes('Loading conversations...')) {
                            console.log('üîÑ Still loading - retrying...');
                            window.commandCenter.conversationUI.loadConversations();
                        }
                    }
                }, 3000);
                
            } catch (error) {
                console.error('‚ùå Error initializing CommandCenter:', error);
                console.error('Stack trace:', error.stack);
            }
        });
        
        // Global error handler
        window.addEventListener('error', (e) => {
            console.error('üö® Global JavaScript Error:', e.error);
            console.error('File:', e.filename);
            console.error('Line:', e.lineno);
        });

        // Lead Management Functionality
        let currentEditingLeadId = null;
        let currentConversationId = null;
        let currentConversation = null;

        // Initialize lead management functionality
        function initializeLeadManagement() {
            console.log('üîß Initializing lead management...');

            // Lead actions dropdown functionality
            const leadActionsBtn = document.getElementById('leadActionsBtn');
            const leadActionsMenu = document.getElementById('leadActionsMenu');
            
            if (leadActionsBtn && leadActionsMenu) {
                leadActionsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleLeadActionsDropdown();
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!leadActionsBtn.contains(e.target) && !leadActionsMenu.contains(e.target)) {
                        closeLeadActionsDropdown();
                    }
                });
            }

            // Edit lead button
            const editLeadBtn = document.getElementById('editLeadBtn');
            if (editLeadBtn) {
                editLeadBtn.addEventListener('click', () => {
                    closeLeadActionsDropdown();
                    openEditLeadModal();
                });
            }

            // Clone lead button
            const cloneLeadBtn = document.getElementById('cloneLeadBtn');
            if (cloneLeadBtn) {
                cloneLeadBtn.addEventListener('click', () => {
                    closeLeadActionsDropdown();
                    cloneLead();
                });
            }

            // Archive lead button
            const archiveLeadBtn = document.getElementById('archiveLeadBtn');
            if (archiveLeadBtn) {
                archiveLeadBtn.addEventListener('click', () => {
                    closeLeadActionsDropdown();
                    showArchiveConfirmation();
                });
            }

            // Delete lead button
            const deleteLeadBtn = document.getElementById('deleteLeadBtn');
            if (deleteLeadBtn) {
                deleteLeadBtn.addEventListener('click', () => {
                    closeLeadActionsDropdown();
                    showDeleteConfirmation();
                });
            }

            // Edit modal event listeners
            setupEditModalEventListeners();
            setupConfirmationDialogs();
        }

        function toggleLeadActionsDropdown() {
            const btn = document.getElementById('leadActionsBtn');
            const menu = document.getElementById('leadActionsMenu');
            
            const isOpen = btn.classList.contains('open');
            
            if (isOpen) {
                closeLeadActionsDropdown();
            } else {
                btn.classList.add('open');
                menu.classList.add('show');
                menu.style.display = 'block';
                
                // Animate in
                setTimeout(() => {
                    menu.style.opacity = '1';
                    menu.style.transform = 'translateY(0)';
                }, 10);
            }
        }

        function closeLeadActionsDropdown() {
            const btn = document.getElementById('leadActionsBtn');
            const menu = document.getElementById('leadActionsMenu');
            
            btn.classList.remove('open');
            menu.classList.remove('show');
            
            setTimeout(() => {
                menu.style.display = 'none';
            }, 200);
        }

        async function openEditLeadModal() {
            // Get current conversation from ConversationUI
            const conversationUI = window.commandCenter?.conversationUI;
            const selectedConversationId = conversationUI?.currentConversationId;
            const selectedConversation = conversationUI?.selectedConversation;
            
            if (!selectedConversationId || !selectedConversation) {
                showNotification('Please select a lead to edit', 'error');
                console.warn('No conversation selected. ConversationUI state:', {
                    conversationUI: !!conversationUI,
                    currentConversationId: selectedConversationId,
                    selectedConversation: !!selectedConversation
                });
                return;
            }

            try {
                // Show loading
                showNotification('Loading lead data...', 'info');

                // Get lead data using existing endpoint
                const response = await fetch(`http://localhost:3001/api/conversations/${selectedConversationId}`);
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to load lead data');
                }

                currentEditingLeadId = selectedConversationId;
                populateEditForm(result.conversation);
                
                const modal = document.getElementById('editLeadModal');
                modal.style.display = 'flex';

                showNotification('Lead data loaded successfully', 'success');

            } catch (error) {
                console.error('Error opening edit modal:', error);
                showNotification('Failed to load lead data: ' + error.message, 'error');
            }
        }

        function populateEditForm(conversation) {
            console.log('Populating edit form with conversation data:', conversation);
            
            // Business Information - map database fields to form fields
            const setFieldValue = (fieldId, value) => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = value || '';
                } else {
                    console.warn(`Field ${fieldId} not found in edit form`);
                }
            };
            
            // Map conversation database fields to edit form fields
            setFieldValue('editCompanyName', conversation.business_name);
            setFieldValue('editDbaName', conversation.dba_name);
            setFieldValue('editPrimaryPhone', conversation.lead_phone);
            setFieldValue('editBusinessPhone', conversation.business_phone);
            setFieldValue('editWebsite', conversation.website);
            setFieldValue('editTaxId', conversation.tax_id);
            setFieldValue('editEntityType', conversation.entity_type_id);
            setFieldValue('editIndustryType', conversation.industry_type_id);
            setFieldValue('editTimeInBusiness', conversation.time_in_business_months);
            setFieldValue('editRequestedAmount', conversation.requested_amount || conversation.priority);
            setFieldValue('editMonthlyRevenue', conversation.monthly_revenue);
            setFieldValue('editAnnualRevenue', conversation.annual_revenue);
            setFieldValue('editBusinessAddress', conversation.address);
            setFieldValue('editBusinessCity', conversation.city);
            setFieldValue('editBusinessState', conversation.state);
            setFieldValue('editBusinessZip', conversation.zip);
            setFieldValue('editLeadSource', conversation.lead_source_id);
            setFieldValue('editPriority', conversation.priority || 'medium');
            setFieldValue('editNotes', conversation.notes);
            
            // Lead details from API
            setFieldValue('editOwner1SSN', conversation.ssn);
            setFieldValue('editOwner1DOB', conversation.date_of_birth ? conversation.date_of_birth.split('T')[0] : '');
            
            // Add business start date field if it exists
            const businessStartField = document.getElementById('businessStartDate');
            if (businessStartField && conversation.business_start_date) {
                businessStartField.value = conversation.business_start_date.split('T')[0];
            }

            // Marketing preferences
            const marketingRadios = document.querySelectorAll('input[name="editMarketingNotification"]');
            marketingRadios.forEach(radio => {
                if (conversation.marketing_opt_text && conversation.marketing_opt_email) {
                    radio.checked = radio.value === 'BOTH';
                } else if (conversation.marketing_opt_text) {
                    radio.checked = radio.value === 'TEXT';
                } else if (conversation.marketing_opt_email) {
                    radio.checked = radio.value === 'EMAIL';
                } else {
                    radio.checked = radio.value === 'BOTH'; // Default
                }
            });

            // Note: Owner data may need to be fetched separately since it's not in the basic conversation endpoint
            console.log('Edit form populated successfully with basic conversation data');
        }

        async function populateEditDropdowns() {
            try {
                console.log('üìã Populating edit dropdowns...');

                // Entity Types - Static data
                const entityTypes = [
                    'LLC', 'Corporation', 'Partnership', 'Sole Proprietorship', 'S-Corp', 'C-Corp', 'Non-Profit', 'Other'
                ];
                const editEntitySelect = document.getElementById('editEntityType');
                if (editEntitySelect) {
                    editEntitySelect.innerHTML = '<option value="">Select Entity Type...</option>';
                    entityTypes.forEach(type => {
                        editEntitySelect.innerHTML += `<option value="${type}">${type}</option>`;
                    });
                }

                // Industry Types - Static data
                const industryTypes = [
                    'Restaurant', 'Retail', 'Construction', 'Healthcare', 'Professional Services',
                    'Manufacturing', 'Transportation', 'Real Estate', 'Technology', 'Hospitality',
                    'Education', 'Finance', 'Other'
                ];
                const editIndustrySelect = document.getElementById('editIndustryType');
                if (editIndustrySelect) {
                    editIndustrySelect.innerHTML = '<option value="">Select Industry...</option>';
                    industryTypes.forEach(type => {
                        editIndustrySelect.innerHTML += `<option value="${type}">${type}</option>`;
                    });
                }

                // Lead Sources - Static data
                const leadSources = [
                    'Website', 'Referral', 'Cold Call', 'Email Campaign', 'Social Media',
                    'Trade Show', 'Partner', 'Advertisement', 'Direct Mail', 'Other'
                ];
                const editLeadSourceSelect = document.getElementById('editLeadSource');
                if (editLeadSourceSelect) {
                    editLeadSourceSelect.innerHTML = '<option value="">Select Source...</option>';
                    leadSources.forEach(source => {
                        editLeadSourceSelect.innerHTML += `<option value="${source}">${source}</option>`;
                    });
                }

                // States for business and owners
                const states = [
                    { code: 'AL', name: 'Alabama' }, { code: 'AK', name: 'Alaska' },
                    { code: 'AZ', name: 'Arizona' }, { code: 'AR', name: 'Arkansas' },
                    { code: 'CA', name: 'California' }, { code: 'CO', name: 'Colorado' },
                    { code: 'CT', name: 'Connecticut' }, { code: 'DE', name: 'Delaware' },
                    { code: 'FL', name: 'Florida' }, { code: 'GA', name: 'Georgia' },
                    { code: 'HI', name: 'Hawaii' }, { code: 'ID', name: 'Idaho' },
                    { code: 'IL', name: 'Illinois' }, { code: 'IN', name: 'Indiana' },
                    { code: 'IA', name: 'Iowa' }, { code: 'KS', name: 'Kansas' },
                    { code: 'KY', name: 'Kentucky' }, { code: 'LA', name: 'Louisiana' },
                    { code: 'ME', name: 'Maine' }, { code: 'MD', name: 'Maryland' },
                    { code: 'MA', name: 'Massachusetts' }, { code: 'MI', name: 'Michigan' },
                    { code: 'MN', name: 'Minnesota' }, { code: 'MS', name: 'Mississippi' },
                    { code: 'MO', name: 'Missouri' }, { code: 'MT', name: 'Montana' },
                    { code: 'NE', name: 'Nebraska' }, { code: 'NV', name: 'Nevada' },
                    { code: 'NH', name: 'New Hampshire' }, { code: 'NJ', name: 'New Jersey' },
                    { code: 'NM', name: 'New Mexico' }, { code: 'NY', name: 'New York' },
                    { code: 'NC', name: 'North Carolina' }, { code: 'ND', name: 'North Dakota' },
                    { code: 'OH', name: 'Ohio' }, { code: 'OK', name: 'Oklahoma' },
                    { code: 'OR', name: 'Oregon' }, { code: 'PA', name: 'Pennsylvania' },
                    { code: 'RI', name: 'Rhode Island' }, { code: 'SC', name: 'South Carolina' },
                    { code: 'SD', name: 'South Dakota' }, { code: 'TN', name: 'Tennessee' },
                    { code: 'TX', name: 'Texas' }, { code: 'UT', name: 'Utah' },
                    { code: 'VT', name: 'Vermont' }, { code: 'VA', name: 'Virginia' },
                    { code: 'WA', name: 'Washington' }, { code: 'WV', name: 'West Virginia' },
                    { code: 'WI', name: 'Wisconsin' }, { code: 'WY', name: 'Wyoming' }
                ];

                const stateSelects = ['editBusinessState', 'editOwner1HomeState', 'editOwner2HomeState'];
                stateSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">Select State...</option>';
                        states.forEach(state => {
                            select.innerHTML += `<option value="${state.code}">${state.name}</option>`;
                        });
                    }
                });

                console.log('‚úÖ Edit dropdowns populated');
            } catch (error) {
                console.error('‚ùå Error populating edit dropdowns:', error);
            }
        }

        function setupEditModalEventListeners() {
            // Close buttons
            const closeBtn = document.getElementById('closeEditLeadModal');
            const cancelBtn = document.getElementById('cancelEditLead');
            const saveBtn = document.getElementById('saveEditLead');

            if (closeBtn) {
                closeBtn.addEventListener('click', closeEditModal);
            }

            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeEditModal);
            }

            if (saveBtn) {
                saveBtn.addEventListener('click', saveLeadChanges);
            }
        }

        function closeEditModal() {
            const modal = document.getElementById('editLeadModal');
            modal.style.display = 'none';

            // Reset mode back to edit
            modal.dataset.mode = 'edit';

            // Reset button text
            const saveBtn = document.getElementById('saveEditLead');
            if (saveBtn) {
                saveBtn.textContent = 'Save Changes';
            }

            // Reset title
            const modalTitle = modal.querySelector('.modal-header h3');
            if (modalTitle) {
                modalTitle.textContent = 'Edit Lead - Comprehensive CRM';
            }

            currentEditingLeadId = null;
        }

        async function saveLeadChanges() {
            const modal = document.getElementById('editLeadModal');
            const mode = modal?.dataset.mode || 'edit';

            console.log('üíæ Saving lead in mode:', mode);

            if (mode === 'edit' && !currentEditingLeadId) {
                showNotification('No lead selected for editing', 'error');
                return;
            }

            try {
                // Show loading
                showNotification(mode === 'create' ? 'Creating lead...' : 'Saving changes...', 'info');

                // Collect form data
                const leadData = collectEditFormData();

                console.log('üì§ Sending lead data:', leadData);

                let response;

                if (mode === 'create') {
                    // CREATE mode - POST to /api/conversations
                    response = await fetch('http://localhost:3001/api/conversations', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(leadData)
                    });
                } else {
                    // EDIT mode - PUT to /api/conversations/:id
                    response = await fetch(`http://localhost:3001/api/conversations/${currentEditingLeadId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(leadData)
                    });
                }

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `Failed to ${mode} lead`);
                }

                // Success
                showNotification(
                    mode === 'create' ? 'Lead created successfully!' : 'Lead updated successfully!',
                    'success'
                );

                closeEditModal();

                // Refresh the conversation list
                if (window.commandCenter?.conversationUI) {
                    await window.commandCenter.conversationUI.loadConversations();

                    // If we created a new lead, select it
                    if (mode === 'create' && result.conversation?.id) {
                        setTimeout(() => {
                            window.commandCenter.conversationUI.selectConversation(result.conversation.id);
                        }, 500);
                    } else if (mode === 'edit') {
                        // If this is the currently selected conversation, refresh it
                        const selectedConversationId = window.commandCenter.conversationUI.currentConversationId;
                        if (selectedConversationId === currentEditingLeadId) {
                            window.commandCenter.conversationUI.selectConversation(selectedConversationId);
                        }
                    }
                }

            } catch (error) {
                console.error('‚ùå Error saving lead:', error);
                showNotification('Failed to save lead: ' + error.message, 'error');
            }
        }

        function collectEditFormData() {
            // Marketing preferences
            const marketingRadio = document.querySelector('input[name="editMarketingNotification"]:checked');
            const marketingPref = marketingRadio ? marketingRadio.value : 'BOTH';

            const leadData = {
                // Business information
                business_name: document.getElementById('editCompanyName').value,
                dba_name: document.getElementById('editDbaName').value,
                lead_phone: document.getElementById('editPrimaryPhone').value,
                business_phone: document.getElementById('editBusinessPhone').value,
                website: document.getElementById('editWebsite').value,
                tax_id_encrypted: document.getElementById('editTaxId').value,
                entity_type_id: document.getElementById('editEntityType').value || null,
                industry_type_id: document.getElementById('editIndustryType').value || null,
                time_in_business_months: parseInt(document.getElementById('editTimeInBusiness').value) || null,
                requested_amount: parseInt(document.getElementById('editRequestedAmount').value) || null,
                monthly_revenue: parseInt(document.getElementById('editMonthlyRevenue').value) || null,
                annual_revenue: parseInt(document.getElementById('editAnnualRevenue').value) || null,
                address: document.getElementById('editBusinessAddress').value,
                city: document.getElementById('editBusinessCity').value,
                state: document.getElementById('editBusinessState').value,
                zip: document.getElementById('editBusinessZip').value,
                lead_source_id: document.getElementById('editLeadSource').value || null,
                priority: document.getElementById('editPriority').value,
                notes: document.getElementById('editNotes').value,
                marketing_opt_text: marketingPref === 'TEXT' || marketingPref === 'BOTH',
                marketing_opt_email: marketingPref === 'EMAIL' || marketingPref === 'BOTH',
                owners: []
            };

            // Owner data
            const owner1FirstName = document.getElementById('editOwner1FirstName').value;
            const owner1LastName = document.getElementById('editOwner1LastName').value;
            if (owner1FirstName || owner1LastName) {
                leadData.owners.push({
                    first_name: owner1FirstName,
                    last_name: owner1LastName,
                    email: document.getElementById('editOwner1Email').value,
                    phone: document.getElementById('editOwner1Phone').value,
                    ownership_percentage: parseInt(document.getElementById('editOwner1Ownership').value) || null,
                    date_of_birth: document.getElementById('editOwner1DOB').value || null,
                    address: document.getElementById('editOwner1HomeAddress').value,
                    city: document.getElementById('editOwner1HomeCity').value,
                    state: document.getElementById('editOwner1HomeState').value,
                    zip: document.getElementById('editOwner1HomeZip').value,
                    ssn_encrypted: document.getElementById('editOwner1SSN').value
                });
            }

            // Partner data (if provided)
            const owner2FirstName = document.getElementById('editOwner2FirstName').value;
            const owner2LastName = document.getElementById('editOwner2LastName').value;
            if (owner2FirstName || owner2LastName) {
                leadData.owners.push({
                    first_name: owner2FirstName,
                    last_name: owner2LastName,
                    email: document.getElementById('editOwner2Email').value,
                    phone: document.getElementById('editOwner2Phone').value,
                    ownership_percentage: parseInt(document.getElementById('editOwner2Ownership').value) || null,
                    date_of_birth: document.getElementById('editOwner2DOB').value || null,
                    address: document.getElementById('editOwner2HomeAddress').value,
                    city: document.getElementById('editOwner2HomeCity').value,
                    state: document.getElementById('editOwner2HomeState').value,
                    zip: document.getElementById('editOwner2HomeZip').value,
                    ssn_encrypted: document.getElementById('editOwner2SSN').value
                });
            }

            return leadData;
        }

        async function cloneLead() {
            // Get current conversation from ConversationUI
            const conversationUI = window.commandCenter?.conversationUI;
            const selectedConversationId = conversationUI?.currentConversationId;
            
            if (!selectedConversationId) {
                showNotification('Please select a lead to clone', 'error');
                return;
            }

            try {
                showNotification('Cloning lead...', 'info');

                const response = await fetch(`http://localhost:3001/api/conversations/${selectedConversationId}/clone`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to clone lead');
                }

                showNotification('Lead cloned successfully!', 'success');
                window.commandCenter?.conversationUI?.loadConversations();

            } catch (error) {
                console.error('Error cloning lead:', error);
                showNotification('Failed to clone lead: ' + error.message, 'error');
            }
        }

        function showArchiveConfirmation() {
            // Get current conversation from ConversationUI
            const conversationUI = window.commandCenter?.conversationUI;
            const selectedConversation = conversationUI?.selectedConversation;
            
            if (!selectedConversation) {
                showNotification('Please select a lead to archive', 'error');
                return;
            }

            // Populate confirmation dialog
            document.getElementById('archiveLeadName').textContent = selectedConversation.business_name || 'Unknown';
            document.getElementById('archiveLeadPhone').textContent = selectedConversation.lead_phone || 'N/A';

            const modal = document.getElementById('archiveConfirmModal');
            modal.style.display = 'flex';
        }

        function showDeleteConfirmation() {
            // Get current conversation from ConversationUI
            const conversationUI = window.commandCenter?.conversationUI;
            const selectedConversation = conversationUI?.selectedConversation;
            
            if (!selectedConversation) {
                showNotification('Please select a lead to delete', 'error');
                return;
            }

            // Populate confirmation dialog
            document.getElementById('deleteLeadName').textContent = selectedConversation.business_name || 'Unknown';
            document.getElementById('deleteLeadPhone').textContent = selectedConversation.lead_phone || 'N/A';

            const modal = document.getElementById('deleteConfirmModal');
            modal.style.display = 'flex';
        }

        function setupConfirmationDialogs() {
            // Archive confirmation
            const archiveModal = document.getElementById('archiveConfirmModal');
            const closeArchiveBtn = document.getElementById('closeArchiveConfirmModal');
            const cancelArchiveBtn = document.getElementById('cancelArchive');
            const confirmArchiveBtn = document.getElementById('confirmArchive');

            if (closeArchiveBtn) closeArchiveBtn.addEventListener('click', () => archiveModal.style.display = 'none');
            if (cancelArchiveBtn) cancelArchiveBtn.addEventListener('click', () => archiveModal.style.display = 'none');
            if (confirmArchiveBtn) confirmArchiveBtn.addEventListener('click', confirmArchiveLead);

            // Delete confirmation
            const deleteModal = document.getElementById('deleteConfirmModal');
            const closeDeleteBtn = document.getElementById('closeDeleteConfirmModal');
            const cancelDeleteBtn = document.getElementById('cancelDelete');
            const confirmDeleteBtn = document.getElementById('confirmDelete');

            if (closeDeleteBtn) closeDeleteBtn.addEventListener('click', () => deleteModal.style.display = 'none');
            if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', () => deleteModal.style.display = 'none');
            if (confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', confirmDeleteLead);
        }

        async function confirmArchiveLead() {
            if (!currentConversationId) return;

            try {
                showNotification('Archiving lead...', 'info');

                const response = await fetch(`http://localhost:3001/api/conversations/${currentConversationId}/archive`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to archive lead');
                }

                showNotification('Lead archived successfully!', 'success');
                document.getElementById('archiveConfirmModal').style.display = 'none';
                window.commandCenter?.conversationUI?.loadConversations();
                clearConversationView();

            } catch (error) {
                console.error('Error archiving lead:', error);
                showNotification('Failed to archive lead: ' + error.message, 'error');
            }
        }

        async function confirmDeleteLead() {
            // Get current conversation from ConversationUI
            const conversationUI = window.commandCenter?.conversationUI;
            const selectedConversationId = conversationUI?.currentConversationId;
            
            if (!selectedConversationId) return;

            try {
                showNotification('Deleting lead...', 'info');

                const response = await fetch(`http://localhost:3001/api/conversations/${selectedConversationId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to delete lead');
                }

                showNotification('Lead deleted successfully!', 'warning');
                document.getElementById('deleteConfirmModal').style.display = 'none';
                window.commandCenter?.conversationUI?.loadConversations();
                clearConversationView();

            } catch (error) {
                console.error('Error deleting lead:', error);
                showNotification('Failed to delete lead: ' + error.message, 'error');
            }
        }

        function clearConversationView() {
            // Clear conversation selection in ConversationUI
            const conversationUI = window.commandCenter?.conversationUI;
            if (conversationUI) {
                conversationUI.currentConversationId = null;
                conversationUI.selectedConversation = null;
            }
            
            const conversationActions = document.getElementById('conversationActions');
            const messageInputContainer = document.getElementById('messageInputContainer');
            const messagesContainer = document.getElementById('messagesContainer');
            const conversationInfo = document.getElementById('conversationInfo');
            
            if (conversationActions) conversationActions.style.display = 'none';
            if (messageInputContainer) messageInputContainer.style.display = 'none';
            if (messagesContainer) {
                messagesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üí¨</div>
                        <h3>No conversation selected</h3>
                        <p>Select a conversation from the left panel to view the message thread</p>
                    </div>
                `;
            }
            if (conversationInfo) {
                conversationInfo.className = 'conversation-info';
                conversationInfo.innerHTML = `
                    <h2>Select a conversation</h2>
                    <p>Choose a conversation from the left to view messages</p>
                `;
            }
        }

        // Initialize lead management when page loads
        initializeLeadManagement();
    </script>

    <!-- FCS Generation Modal -->
    <div id="fcsModal" class="modal fcs-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Generate FCS Report</h3>
                <button class="modal-close" id="closeFCSModalBtn">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                    <p style="margin: 0;">Select bank statements to analyze:</p>
                    <button id="toggleAllFcsBtn" class="btn btn-sm" style="font-size: 12px; padding: 4px 12px;">Select All</button>
                </div>
                <div id="fcsDocumentSelection" style="max-height: 300px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 6px; padding: 8px;">
                    <!-- Documents will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelFcs">Cancel</button>
                <button id="confirmFcs" class="btn btn-primary">Generate FCS</button>
            </div>
        </div>
    </div>

    <!-- Processing Indicator -->
    <div id="processingIndicator" class="processing-overlay" style="display: none;">
        <div class="processing-content">
            <div class="spinner"></div>
            <div class="processing-text">Processing...</div>
            <div class="processing-subtext" id="processingSubtext">Please wait while we process your request</div>
        </div>
    </div>

    <!-- Lender Submission Modal -->
    <div id="lenderSubmissionModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Send Submissions to Lenders</h2>
                <button class="modal-close" id="closeLenderSubmissionModal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Lenders Selection -->
                <div class="form-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <h3 style="margin: 0;">Select Lenders</h3>
                        <button type="button" id="toggleAllLendersBtn" class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;">
                            Deselect All
                        </button>
                    </div>
                    <div id="lenderSelectionList" style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px;">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Documents Selection -->
                <div class="form-section" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <h3 style="margin: 0;">Select Documents</h3>
                        <button type="button" id="toggleAllDocumentsBtn" class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;">
                            Select All
                        </button>
                    </div>
                    <div id="submissionDocumentList" style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px;">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Message -->
                <div class="form-section" style="margin-top: 20px;">
                    <h3>Message</h3>
                    <textarea id="submissionMessage" rows="6" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 14px;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelLenderSubmission">Cancel</button>
                <button class="btn btn-primary" id="confirmLenderSubmission">
                    <span id="sendSubmissionsText">Send Submissions</span>
                    <span id="sendSubmissionsLoading" style="display: none;">Sending...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Global Functions - Loaded BEFORE module script -->
    <script>
        console.log('üåê Loading global openLeadModal function...');

        // Define openLeadModal in global scope IMMEDIATELY
        window.openLeadModal = function(mode = 'create', conversationData = null) {
            console.log(`üìù openLeadModal called in ${mode.toUpperCase()} mode`);

            // Wait for intelligence module if not ready
            if (!window.conversationUI?.intelligence) {
                console.log('‚è≥ Intelligence not ready, waiting...');
                setTimeout(() => window.openLeadModal(mode, conversationData), 100);
                return;
            }

            const modal = document.getElementById('editLeadInlineModal');
            const modalContent = document.getElementById('editLeadInlineContent');

            if (!modal || !modalContent) {
                console.error('‚ùå Modal elements not found');
                return;
            }

            const intelligence = window.conversationUI.intelligence;

            if (mode === 'create') {
                console.log('‚úÖ Opening in CREATE mode');

                // Empty conversation data
                const emptyConversation = {
                    business_name: '', dba_name: '', lead_phone: '', business_phone: '',
                    website: '', tax_id: '', entity_type: '', industry_type: '',
                    business_address: '', business_address2: '', business_city: '',
                    business_state: '', business_zip: '', business_country: 'United States',
                    cell_phone: '', work_phone: '', fax_phone: '', annual_revenue: '',
                    monthly_revenue: '', requested_amount: '', time_in_business: '',
                    credit_score: '', years_in_business: '', owner_first_name: '',
                    owner_last_name: '', owner_email: '', owner_home_address: '',
                    owner_home_address2: '', owner_home_city: '', owner_home_state: '',
                    owner_home_zip: '', owner_home_country: 'United States',
                    ownership_percent: '', ssn: '', date_of_birth: '',
                    business_start_date: '', length_of_ownership: '', product_sold: '',
                    use_of_proceeds: '', lead_source: '', campaign: '', lead_status: '',
                    business_email: '', factor_rate: '', term_months: '', funding_date: '',
                    lead_details: {}
                };

                const formHTML = intelligence.createEditFormTemplate(emptyConversation);
                modalContent.innerHTML = formHTML;

                const modalTitle = modal.querySelector('.modal-header h3');
                if (modalTitle) modalTitle.textContent = 'Add New Lead - Comprehensive CRM';

                const generateBtn = modalContent.querySelector('#generateApplicationBtn');
                if (generateBtn) generateBtn.style.display = 'none';

                const submitBtn = modalContent.querySelector('.update-btn');
                if (submitBtn) {
                    submitBtn.textContent = 'Create Lead';
                    submitBtn.style.background = '#10b981';
                }

                // Attach form submission handler
                const form = modalContent.querySelector('#editLeadForm');
                if (form) {
                    form.onsubmit = async (e) => {
                        e.preventDefault();
                        await handleCreateFormSubmit(e);
                    };
                    console.log('‚úÖ Form submit handler attached');
                }

                console.log('‚úÖ Form generated for CREATE mode');
            } else if (mode === 'edit') {
                console.log('‚úÖ Opening in EDIT mode');

                if (!conversationData) {
                    console.error('‚ùå No conversation data provided for edit mode');
                    return;
                }

                const formHTML = intelligence.createEditFormTemplate(conversationData);
                modalContent.innerHTML = formHTML;

                const modalTitle = modal.querySelector('.modal-header h3');
                if (modalTitle) modalTitle.textContent = 'Edit Lead Information';

                // Attach form submission handler for edit
                const form = modalContent.querySelector('#editLeadForm');
                if (form) {
                    form.onsubmit = async (e) => {
                        e.preventDefault();
                        await handleEditFormSubmit(e, conversationData.id);
                    };
                    console.log('‚úÖ Edit form submit handler attached');
                }

                console.log('‚úÖ Form generated for EDIT mode');
            }

            // Close handlers
            const closeBtn = document.getElementById('closeEditLeadInlineModal');
            if (closeBtn) {
                closeBtn.onclick = () => { modal.style.display = 'none'; };
            }

            modal.onclick = (e) => {
                if (e.target === modal) modal.style.display = 'none';
            };

            modal.style.display = 'flex';
            console.log('‚úÖ Modal displayed');
        };

        console.log('‚úÖ openLeadModal defined globally');

        // Debug helper to test modal function
        window.testOpenLeadModal = function() {
            console.log('üß™ Testing openLeadModal function...');
            console.log('Function exists:', !!window.openLeadModal);
            console.log('Function type:', typeof window.openLeadModal);

            if (window.openLeadModal) {
                console.log('Calling openLeadModal("create")...');
                try {
                    window.openLeadModal('create');
                    console.log('‚úÖ Function executed');
                } catch (error) {
                    console.error('‚ùå Error:', error);
                }
            }
        };

        console.log('üí° Test helper added: window.testOpenLeadModal()');

        // Auto-formatting functions
        function formatSSN(value) {
            const digits = value.replace(/\D/g, '');
            if (digits.length <= 3) return digits;
            if (digits.length <= 5) return `${digits.slice(0, 3)}-${digits.slice(3)}`;
            return `${digits.slice(0, 3)}-${digits.slice(3, 5)}-${digits.slice(5, 9)}`;
        }

        function formatPhone(value) {
            const digits = value.replace(/\D/g, '');
            if (digits.length <= 3) return digits;
            if (digits.length <= 6) return `(${digits.slice(0, 3)}) ${digits.slice(3)}`;
            return `(${digits.slice(0, 3)}) ${digits.slice(3, 6)}-${digits.slice(6, 10)}`;
        }

        function formatEIN(value) {
            const digits = value.replace(/\D/g, '');
            if (digits.length <= 2) return digits;
            return `${digits.slice(0, 2)}-${digits.slice(2, 9)}`;
        }

        function stripFormatting(value) {
            return value.replace(/\D/g, '');
        }

        function attachInputFormatters(form) {
            // SSN fields
            const ssnFields = form.querySelectorAll('input[name="ownerSSN"]');
            ssnFields.forEach(field => {
                field.addEventListener('input', (e) => {
                    const cursorPos = e.target.selectionStart;
                    const oldLength = e.target.value.length;
                    e.target.value = formatSSN(e.target.value);
                    const newLength = e.target.value.length;
                    e.target.setSelectionRange(cursorPos + (newLength - oldLength), cursorPos + (newLength - oldLength));
                });
            });

            // Phone fields
            const phoneFields = form.querySelectorAll('input[name="primaryPhone"], input[name="cellPhone"], input[name="workPhone"], input[name="faxPhone"]');
            phoneFields.forEach(field => {
                field.addEventListener('input', (e) => {
                    const cursorPos = e.target.selectionStart;
                    const oldLength = e.target.value.length;
                    e.target.value = formatPhone(e.target.value);
                    const newLength = e.target.value.length;
                    e.target.setSelectionRange(cursorPos + (newLength - oldLength), cursorPos + (newLength - oldLength));
                });
            });

            // EIN/Tax ID fields
            const einFields = form.querySelectorAll('input[name="federalTaxId"]');
            einFields.forEach(field => {
                field.addEventListener('input', (e) => {
                    const cursorPos = e.target.selectionStart;
                    const oldLength = e.target.value.length;
                    e.target.value = formatEIN(e.target.value);
                    const newLength = e.target.value.length;
                    e.target.setSelectionRange(cursorPos + (newLength - oldLength), cursorPos + (newLength - oldLength));
                });
            });
        }

        // Handle new lead form submission
        async function handleNewLeadSubmit(e) {
            e.preventDefault();
            console.log('üì§ Submitting new lead...');

            const formData = new FormData(e.target);
            const data = {};

            // Convert form data to object - use exact field names the backend expects
            for (const [key, value] of formData.entries()) {
                if (value) {
                    // Strip formatting from SSN, phone, and EIN fields
                    if (key === 'ownerSSN' || key === 'primaryPhone' || key === 'cellPhone' ||
                        key === 'workPhone' || key === 'faxPhone' || key === 'federalTaxId') {
                        data[key] = stripFormatting(value);
                    } else {
                        data[key] = value;
                    }
                }
            }

            const submitBtn = e.target.querySelector('[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Creating...';
            submitBtn.disabled = true;

            try {
                const response = await fetch('http://localhost:3001/api/conversations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert('‚úÖ Lead created successfully!');
                    document.getElementById('addLeadModal').style.display = 'none';
                    location.reload(); // Refresh to show new lead
                } else {
                    throw new Error(result.error || 'Failed to create lead');
                }
            } catch (error) {
                console.error('Error creating lead:', error);
                alert('‚ùå Error: ' + error.message);
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // Simple standalone function to open the add lead modal
        window.openNewLeadModal = function() {
            console.log('üÜï Opening standalone Add Lead modal');
            const modal = document.getElementById('addLeadModal');
            if (!modal) {
                console.error('‚ùå Add Lead modal not found');
                return;
            }

            // Inject the generated form
            const modalBody = modal.querySelector('.modal-body');
            if (modalBody && typeof generateNewLeadForm === 'function') {
                modalBody.innerHTML = generateNewLeadForm();

                // Attach submit handler
                const form = document.getElementById('newLeadForm');
                if (form) {
                    form.onsubmit = async (e) => {
                        e.preventDefault();
                        await handleNewLeadSubmit(e);
                    };

                    // Attach auto-formatters
                    attachInputFormatters(form);
                }
            }

            modal.style.display = 'flex';
        };

        // Toggle delete mode - show/hide checkboxes
        window.toggleDeleteMode = function() {
            const conversationsList = document.querySelector('.conversations-list');
            const toggleBtn = document.getElementById('toggleDeleteModeBtn');

            if (!conversationsList) return;

            // Toggle delete mode class
            const isDeleteMode = conversationsList.classList.toggle('delete-mode');

            // Update button text and style
            if (isDeleteMode) {
                toggleBtn.textContent = 'Cancel';
                toggleBtn.classList.remove('secondary');
                toggleBtn.classList.add('danger');
            } else {
                toggleBtn.textContent = 'Delete Conversations';
                toggleBtn.classList.remove('danger');
                toggleBtn.classList.add('secondary');

                // Clear any selections and hide delete button
                if (window.conversationUI && window.conversationUI.core) {
                    window.conversationUI.core.selectedForDeletion.clear();
                    window.conversationUI.core.updateDeleteButtonVisibility();

                    // Uncheck all checkboxes
                    document.querySelectorAll('.delete-checkbox').forEach(checkbox => {
                        checkbox.checked = false;
                    });

                    // Remove checked styling
                    document.querySelectorAll('.conversation-item').forEach(item => {
                        item.classList.remove('checked-for-deletion');
                    });
                }
            }
        };

        // Close button handler
        document.addEventListener('DOMContentLoaded', function() {
            const closeBtn = document.getElementById('closeAddLeadModal');
            const cancelBtn = document.getElementById('cancelAddLead');
            const modal = document.getElementById('addLeadModal');

            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
            }

            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
            }

            // Close on outside click
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            }
        });

        console.log('‚úÖ openNewLeadModal defined globally');
    </script>

</body>
</html>