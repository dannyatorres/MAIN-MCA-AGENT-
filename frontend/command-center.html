<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>MCAgent</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <link rel="stylesheet" href="css/modules/01-theme.css">
    <link rel="stylesheet" href="css/modules/02-layout.css">
    <link rel="stylesheet" href="css/modules/03-panel-left-list.css">
    <link rel="stylesheet" href="css/modules/04-panel-center-chat.css">
    <link rel="stylesheet" href="css/modules/05a-panel-right-layout.css">
    <link rel="stylesheet" href="css/modules/05b-tab-documents.css">
    <link rel="stylesheet" href="css/modules/05c-tab-lenders.css">
    <link rel="stylesheet" href="css/modules/05d-tab-ai.css">
    <link rel="stylesheet" href="css/modules/06-components-modals.css">
    <link rel="stylesheet" href="css/modules/08-components-buttons.css">
    <link rel="stylesheet" href="css/modules/07-utilities.css">

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</head>
<body>
    <div class="command-center">
        <div class="main-content">
            <div class="left-panel">
                <div class="panel-header">
                    <div class="unified-toolbar">
                        <div class="filter-wrapper">
                            <select class="state-filter-icon" id="stateFilter" title="Filter Status">
                                <option value="">All</option>
                                <option value="INTERESTED">Interested</option>
                                <option value="FCS_RUNNING">FCS</option>
                                <option value="QUALIFIED">Qualified</option>
                                <option value="NEGOTIATING">Negot.</option>
                            </select>
                            <i class="fas fa-filter filter-icon-indicator"></i>
                        </div>

                        <input type="text" class="search-field-clean" id="searchInput" placeholder="Search...">

                        <div class="action-group">
                            <button class="tool-btn primary" onclick="openRichCreateModal()" title="New Conversation">
                                <i class="fas fa-plus"></i>
                            </button>

                            <button class="tool-btn" onclick="openCsvImportModal()" title="Import">
                                <i class="fas fa-file-import"></i>
                            </button>

                            <button class="tool-btn" id="resetAiBtn" onclick="resetSelectedLead()" title="Reset for AI Agent">
                                <i class="fas fa-magic"></i>
                            </button>

                            <button class="tool-btn danger-hover" id="toggleDeleteModeBtn" title="Delete">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                        </div>
                    </div>

                    <button id="deleteSelectedBtn" class="btn btn-danger full-width hidden delete-selection-trigger">
                        Delete Selected
                    </button>
                </div>
                <div class="conversations-list" id="conversationsList">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>Loading conversations...</p>
                    </div>
                </div>
            </div>

            <div class="center-panel">
                <div id="dashboardView" class="view-layer">
                    <div class="dashboard-container">
                        <div class="dashboard-header">
                            <h1>Welcome back, Agent</h1>
                            <p>Here is what's happening with your pipeline today.</p>
                        </div>
                        <div class="dashboard-toolbar">
                            <button
                                class="btn btn-secondary dashboard-action-btn"
                                id="dashFormatterBtn"
                                onclick="window.open('/lead_reformatter.html', '_blank')"
                            >
                                <i class="fas fa-table"></i> Formatter
                            </button>
                            <button
                                class="btn btn-secondary dashboard-action-btn"
                                id="dashLenderBtn"
                                onclick="if(window.openLenderManagementModal) window.openLenderManagementModal(); else alert('System loading...');"
                            >
                                <i class="fas fa-university"></i> Manage Lenders
                            </button>
                            <button class="btn btn-secondary dashboard-action-btn" onclick="openCleanerModal()" style="background: #28a745; color: white;">
                                <i class="fas fa-user-check"></i> Background Verification
                            </button>
                            <button class="btn btn-secondary dashboard-action-btn">
                                <i class="fas fa-cog"></i> Settings
                            </button>
                        </div>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-fire"></i></div>
                                <div class="stat-value" id="activeCount">-</div>
                                <div class="stat-label">Active Leads</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-spinner"></i></div>
                                <div class="stat-value" id="processingCount">-</div>
                                <div class="stat-label">Processing</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon"><i class="fas fa-calendar-check"></i></div>
                                <div class="stat-value" id="todayCount">-</div>
                                <div class="stat-label">New Today</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="chatView" class="view-layer hidden">
                    <div class="panel-header">
                        </div>

                    <div class="messages-container" id="messagesContainer">
                        </div>

                    <div class="message-input-container" id="messageInputContainer">
                        <div class="ai-suggestions hidden" id="aiSuggestions">
                            <div class="suggestions-header">
                                <span>AI Suggestions:</span>
                                <button class="close-suggestions" id="closeSuggestions">√ó</button>
                            </div>
                            <div class="suggestions-list" id="suggestionsList"></div>
                        </div>
                        <div class="input-deck-main">
                            <input type="file" id="fileInput" accept="image/*" class="hidden">
                            <button class="attachment-icon" id="attachmentBtn" title="Attach file">üìé</button>
                            <textarea class="message-input" id="messageInput" placeholder="Message" rows="1"></textarea>
                            <button class="icon-btn-small primary-send" id="sendMessageBtn" title="Send">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="right-panel">

                <div id="rightPanelHome" class="right-panel-state">
                    <div class="news-feed" id="newsFeedContainer"></div>
                </div>

                <div id="rightPanelIntelligence" class="right-panel-state hidden">
                    <div class="panel-header">
                        <div class="intelligence-tabs" id="intelligenceTabs">
                            <button class="tab-btn active" data-tab="ai-assistant">AI Agent</button>
                            <button class="tab-btn" data-tab="documents">Docs</button>
                            <button class="tab-btn" data-tab="edit">Edit</button>
                            <button class="tab-btn" data-tab="fcs">FCS</button>
                            <button class="tab-btn" data-tab="lenders">Submission</button>
                            <button class="tab-btn" data-tab="email">Email</button>
                        </div>
                    </div>
                    <div class="intelligence-content" id="intelligenceContent">
                        <div class="empty-state">
                            <div class="loading-spinner small"></div>
                            <p>Loading lead data...</p>
                        </div>

                        <div id="lenderForm" class="hidden"></div>
                        <div id="lenderResults" class="hidden"></div>
                        <div id="lenderLoading" class="hidden"></div>
                        <div id="lenderErrorMsg" class="hidden"></div>
                        <div id="lendersTableContainer" class="hidden"></div>

                        <div id="fcsDocumentSelection" class="hidden"></div>
                        <div id="fcsResults" class="hidden"></div>
                        <div id="fcsLoading" class="hidden"></div>
                        <div id="fcsErrorMsg" class="hidden"></div>
                    </div>
                </div>

            </div>
        </div>

        <div class="status-bar">
            <div class="status-left">
                <span id="lastUpdated">Last updated: Never</span>
            </div>
            <div class="status-center">
                <div class="processing-indicator hidden" id="processingIndicator">
                    <div class="loading-spinner small"></div>
                    <span id="processingText">Processing...</span>
                </div>
            </div>
            <div class="status-right">
                <span id="systemStatus">System: Ready</span>
            </div>
        </div>
    </div>

    <div class="modal hidden" id="csvImportModal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h3>üìä Import Conversations from CSV</h3>
                <button class="modal-close" id="closeCsvImportModal">√ó</button>
            </div>
            <div class="modal-body modal-body-scroll">
                <div id="csvUploadSection" class="csv-section">
                    <div class="upload-drop-zone" id="csvUploadArea">
                        <div class="upload-icon">üìÑ</div>
                        <h4 class="upload-title">Drag and drop your CSV file here</h4>
                        <p class="upload-subtitle">Or click to select a file</p>
                        <input type="file" class="hidden" id="csvFileInput" accept=".csv" />
                        <button class="btn btn-primary" id="csvSelectFileBtn">Select File</button>
                    </div>
                    <div class="csv-file-info hidden" id="csvFileInfo">
                        <h4 class="info-header">File Information</h4>
                        <div id="csvFileDetails"></div>
                    </div>
                </div>

                <div id="csvMappingSection" class="csv-section hidden">
                    <div id="csvMappingControls"></div>
                    <div class="modal-actions-row">
                         <button class="btn btn-secondary" id="csvBackToUploadBtn">Back</button>
                         <button class="btn btn-primary" id="csvValidateMappingBtn">Validate</button>
                    </div>
                </div>

                 <div id="csvValidationSection" class="csv-section hidden">
                    <div id="csvValidationResults"></div>
                    <div class="modal-actions-row">
                        <button class="btn btn-secondary" id="csvBackToMappingBtn">Back</button>
                        <button class="btn btn-primary" id="csvProceedToImportBtn">Import</button>
                    </div>
                </div>

                <div id="csvImportSection" class="csv-section hidden">
                    <h4 style="text-align:center; color:#e6edf3; margin-bottom:10px;">Importing Data...</h4>

                    <div class="progress-track-bg">
                        <div id="csvProgressFill" style="width: 0%"></div>
                    </div>

                    <div id="csvImportStatus">Preparing...</div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal hidden" id="deleteConfirmModal">
        <div class="modal-content small-modal">
            <div class="modal-header">
                <h3>‚ö†Ô∏è Delete Lead</h3>
                <button class="modal-close" id="closeDeleteConfirmModal">√ó</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to <strong>permanently delete</strong> this lead?</p>
                <div class="lead-info" id="deleteLeadInfo">
                    <strong>Lead:</strong> <span id="deleteLeadName">Loading...</span><br>
                    <strong>Phone:</strong> <span id="deleteLeadPhone">Loading...</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelDelete">Cancel</button>
                <button class="btn btn-danger" id="confirmDelete">Delete Lead</button>
            </div>
        </div>
    </div>

    <div class="modal hidden" id="archiveConfirmModal">
        <div class="modal-content small-modal">
            <div class="modal-header">
                <h3>üì¶ Archive Lead</h3>
                <button class="modal-close" id="closeArchiveConfirmModal">√ó</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to <strong>archive</strong> this lead?</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelArchive">Cancel</button>
                <button class="btn btn-primary" id="confirmArchive">Archive Lead</button>
            </div>
        </div>
    </div>

    <div class="modal hidden" id="signatureModal">
        <div class="modal-content signature-modal">
            <div class="modal-header">
                <h3>Sign Application</h3>
                <button class="modal-close" id="closeSignatureModal">√ó</button>
            </div>
            <div class="modal-body">
                <canvas id="signatureCanvas" width="400" height="200"></canvas>
                <div class="signature-controls">
                    <button class="btn btn-secondary" id="clearSignature">Clear</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelSignature">Cancel</button>
                <button class="btn btn-primary" id="confirmSignature">Generate</button>
            </div>
        </div>
    </div>

    <div class="modal hidden" id="lendersInlineModal">
        <div class="modal-content modal-xl">
            <div class="modal-header">
                <h3>Lender Qualification & Submission</h3>
                <button class="modal-close" id="closeLendersInlineModal">√ó</button>
            </div>
            <div class="modal-body" id="lendersInlineContent"></div>
        </div>
    </div>

    <div class="notifications" id="notifications"></div>

    <div id="lenderSubmissionModal" class="modal hidden">
        <div class="modal-content lender-submission-modal">

            <div id="submissionOverlay" class="submission-loading-overlay">
                 <div class="submission-loading-card">
                    <div class="submission-spinner"></div>
                    <h3>Sending...</h3>
                    <p id="submissionStatusText" class="status-text">Preparing files...</p>
                    <div class="submission-progress-track">
                        <div id="submissionProgressBar" class="submission-progress-bar"></div>
                    </div>
                </div>
            </div>

            <div class="modal-header">
                <h3>Send to Lenders</h3>
                <button id="closeLenderSubmissionModal" class="modal-close">&times;</button>
            </div>

            <div class="modal-body submission-body">
                <div class="submission-grid">
                    <div class="submission-col">
                        <div class="submission-col-header">
                            <span class="submission-col-title">Select Lenders</span>
                            <div class="header-actions">
                                <label class="toggle-override-label">
                                    <input type="checkbox" id="showAllLendersToggle"> Override Filters
                                </label>
                                <button id="toggleAllLendersBtn" class="action-link">DESELECT ALL</button>
                            </div>
                        </div>
                        <div class="submission-search-container">
                            <input type="text" id="lenderSearchInput" class="submission-search-input" placeholder="Search lenders..." autocomplete="off">
                        </div>
                        <div id="lenderSelectionList" class="selection-list"></div>
                    </div>

                    <div class="submission-col">
                        <div class="submission-col-header">
                            <span class="submission-col-title">Select Documents</span>
                            <button id="toggleAllDocumentsBtn" class="action-link">SELECT ALL</button>
                        </div>
                        <div class="submission-search-container hidden">
                            <input type="text" class="submission-search-input">
                        </div>
                        <div id="submissionDocumentList" class="selection-list documents-list"></div>
                    </div>
                </div>

                <div class="submission-message-area">
                    <label class="field-label">EMAIL MESSAGE (OPTIONAL)</label>
                    <textarea id="submissionMessage" class="submission-textarea" placeholder="Enter a message to include with the submission..."></textarea>
                </div>
            </div>

            <div class="modal-footer">
                <button id="cancelLenderSubmission" class="btn btn-secondary">Cancel</button>
                <button id="confirmLenderSubmission" class="btn btn-primary">
                    <span id="sendSubmissionsText">Send Emails</span>
                </button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <script src="https://unpkg.com/@twilio/voice-sdk@2.11.0/dist/twilio.min.js"></script>

    <script type="module" src="js/api.js"></script>
    <script type="module" src="js/formatters.js"></script>

    <script src="js/templates-utilities.js"></script>

    <script src="js/websocket.js"></script>

    <script src="js/app-core.js"></script>

    <script src="js/conversation-core.js?v=6"></script>
    <script src="js/messaging.js"></script>
    <script src="js/documents.js"></script>

    <script type="module" src="js/lead-form-controller.js"></script>
    <script type="module" src="js/intelligence-manager.js"></script>

    <script src="js/fcs-module.js"></script>
    <script src="js/lenders.js"></script>
    <script src="js/lender-admin.js"></script>
    <script src="js/ai-assistant.js"></script>
    <script src="js/stats.js"></script>
    <script src="js/csv-import-modal.js"></script>
    <script src="js/calling.js"></script>

    <script type="module" src="js/app-bootstrap.js"></script>

    <!-- Background Verification Modal -->
    <div id="cleanerModal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.7); z-index:9999; justify-content:center; align-items:center;">
        <div style="background:white; padding:30px; border-radius:10px; width:500px; text-align:center;">
            <h3 style="margin-bottom:20px;"><i class="fas fa-user-check"></i> Background Verification</h3>
            <p style="color:#666; margin-bottom:20px;">Upload a CSV to enrich with verified mobile numbers and home addresses.</p>

            <input type="file" id="cleanerFileInput" accept=".csv" style="margin-bottom:20px;">

            <div id="cleanerProgress" style="display:none; margin:20px 0;">
                <div style="background:#eee; border-radius:5px; height:20px; overflow:hidden;">
                    <div id="cleanerProgressBar" style="background:#28a745; height:100%; width:0%; transition:width 0.3s;"></div>
                </div>
                <p id="cleanerStatus" style="margin-top:10px; color:#666;">Processing...</p>
            </div>

            <div style="margin-top:20px;">
                <button onclick="runCleaner()" style="background:#28a745; color:white; border:none; padding:10px 30px; border-radius:5px; cursor:pointer; margin-right:10px;">
                    <i class="fas fa-play"></i> Clean File
                </button>
                <button onclick="document.getElementById('cleanerModal').style.display='none'" style="background:#6c757d; color:white; border:none; padding:10px 30px; border-radius:5px; cursor:pointer;">
                    Cancel
                </button>
            </div>
        </div>
    </div>

    <script>
    function openCleanerModal() {
        document.getElementById('cleanerModal').style.display = 'flex';
        document.getElementById('cleanerFileInput').value = '';
        document.getElementById('cleanerProgress').style.display = 'none';
    }

    async function runCleaner() {
        const fileInput = document.getElementById('cleanerFileInput');
        if (!fileInput.files[0]) {
            alert('Please select a CSV file first.');
            return;
        }

        const formData = new FormData();
        formData.append('csvFile', fileInput.files[0]);

        document.getElementById('cleanerProgress').style.display = 'block';
        document.getElementById('cleanerProgressBar').style.width = '50%';
        document.getElementById('cleanerStatus').textContent = 'Sending to Tracers API...';

        try {
            const response = await fetch('/api/cleaner/process-file', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) throw new Error('Processing failed');

            document.getElementById('cleanerProgressBar').style.width = '100%';
            document.getElementById('cleanerStatus').textContent = 'Complete! Downloading...';

            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'CLEANED_' + fileInput.files[0].name;
            a.click();

            setTimeout(() => {
                document.getElementById('cleanerModal').style.display = 'none';
            }, 1500);

        } catch (error) {
            document.getElementById('cleanerStatus').textContent = 'Error: ' + error.message;
            document.getElementById('cleanerProgressBar').style.background = '#dc3545';
        }
    }
    </script>

</body>
</html>
