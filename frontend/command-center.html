<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>MCAagent</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="css/command-center.css">

    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <!-- Additional styles for modular components -->
    <style>
        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: white;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-width: 500px;
            width: 90%;
            max-height: 80%;
            overflow-y: auto;
        }

        .modal-header {
            padding: 20px 24px 16px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 18px;
            font-weight: 600;
            color: #111827;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #6b7280;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            color: #374151;
        }

        .modal-body {
            padding: 20px 24px;
        }

        .modal-footer {
            padding: 16px 24px 20px;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Form Styles */
        .form-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            margin-bottom: 6px;
            font-weight: 500;
            color: #374151;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 14px;
            box-sizing: border-box;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Button Styles */
        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-secondary {
            background-color: #f3f4f6;
            color: #374151;
            border: 1px solid #d1d5db;
        }

        .btn-secondary:hover {
            background-color: #e5e7eb;
        }

        /* Processing Indicator Styles */
        .processing-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .processing-content {
            background: white;
            border-radius: 12px;
            padding: 32px;
            text-align: center;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            min-width: 200px;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @keyframes typing {
            0%, 60%, 100% { opacity: 0.3; }
            30% { opacity: 1; }
        }

        .processing-text {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
            margin-bottom: 8px;
        }

        .processing-subtext {
            font-size: 14px;
            color: #6b7280;
        }

        /* Intelligence Tab Content Styles */
        .intelligence-content .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #6b7280;
        }

        .intelligence-content .empty-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        /* Form Section Styles */
        .form-section {
            margin-bottom: 24px;
        }

        .form-section h3 {
            margin: 0 0 12px 0;
            font-size: 16px;
            font-weight: 600;
            color: #111827;
        }

        /* Document Selection Styles */
        #fcsDocumentSelection,
        #submissionDocumentList {
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 12px;
            max-height: 300px;
            overflow-y: auto;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .form-row {
                flex-direction: column;
                gap: 12px;
            }

            .modal-content {
                margin: 20px;
                width: calc(100% - 40px);
                max-width: none;
            }
        }

        /* Edit Form Responsive Styles */
        .edit-form-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            width: 100%;
            box-sizing: border-box;
        }

        /* Responsive form rows with max field widths */
        .edit-form-row,
        .edit-form-container .form-row {
            display: grid;
            gap: 16px;
            margin-bottom: 16px;
            grid-template-columns: repeat(auto-fit, minmax(200px, 350px));
        }

        /* Different grid layouts based on number of fields needed */
        .edit-form-row-2 {
            grid-template-columns: repeat(auto-fit, minmax(200px, 350px));
        }

        .edit-form-row-3 {
            grid-template-columns: repeat(auto-fit, minmax(180px, 280px));
        }

        .edit-form-row-4 {
            grid-template-columns: repeat(auto-fit, minmax(150px, 250px));
        }

        .edit-form-row-5 {
            grid-template-columns: repeat(auto-fit, minmax(140px, 220px));
        }

        .edit-form-row-6 {
            grid-template-columns: repeat(auto-fit, minmax(120px, 200px));
        }

        /* Ensure form inputs don't stretch beyond reasonable widths */
        .edit-form-container .form-group input,
        .edit-form-container .form-group select,
        .edit-form-container .form-group textarea {
            width: 100%;
            max-width: 350px;
        }

        /* For fields that should be full width */
        .form-group.full-width input,
        .form-group.full-width textarea {
            max-width: 100% !important;
        }

        /* Section headers stay full width */
        .form-section h3 {
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        /* Responsive behavior for smaller screens */
        @media (max-width: 1400px) {
            .edit-form-container {
                max-width: 1000px;
            }
        }

        @media (max-width: 1200px) {
            .edit-form-container {
                max-width: 900px;
            }

            .edit-form-row-6 {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .edit-form-container {
                padding: 16px;
            }

            .edit-form-row-2,
            .edit-form-row-3,
            .edit-form-row-4,
            .edit-form-row-5,
            .edit-form-row-6 {
                grid-template-columns: 1fr;
            }

            .edit-form-container .form-group input,
            .edit-form-container .form-group select,
            .edit-form-container .form-group textarea {
                max-width: 100%;
            }
        }

        /* Fix for Edit tab form field widths */
        .edit-form-container {
            max-width: 1400px;
            padding: 20px;
        }

        .edit-form-container .form-row-six {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 220px));
            gap: 16px;
            margin-bottom: 16px;
        }

        .edit-form-container .form-group {
            width: 100%;
        }

        .edit-form-container .form-group input,
        .edit-form-container .form-group select,
        .edit-form-container .form-group textarea {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
        }

        /* Ensure the grid doesn't stretch beyond reasonable sizes */
        .edit-form-container .form-section {
            margin-bottom: 24px;
        }

        .edit-form-container .form-section h4 {
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid #e5e7eb;
        }

        /* For wider screens, limit the grid expansion */
        @media (min-width: 1400px) {
            .edit-form-container .form-row-six {
                grid-template-columns: repeat(6, minmax(150px, 200px));
            }
        }

        /* For medium screens */
        @media (max-width: 1200px) {
            .edit-form-container .form-row-six {
                grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            }
        }

        /* For small screens */
        @media (max-width: 768px) {
            .edit-form-container .form-row-six {
                grid-template-columns: 1fr;
            }
        }

        /* Fix for ALL Edit tab form fields and rows */
        #intelligenceContent .edit-form-container .form-group,
        #intelligenceContent .form-group {
            display: inline-block;
            vertical-align: top;
            margin-right: 16px;
            margin-bottom: 16px;
            min-width: 150px;
            max-width: 220px;
        }

        #intelligenceContent .edit-form-container input,
        #intelligenceContent .edit-form-container select,
        #intelligenceContent .edit-form-container textarea,
        #intelligenceContent input[type="text"],
        #intelligenceContent input[type="number"],
        #intelligenceContent input[type="email"],
        #intelligenceContent input[type="tel"],
        #intelligenceContent input[type="url"],
        #intelligenceContent input[type="date"],
        #intelligenceContent select {
            width: 100% !important;
            max-width: 200px !important;
            box-sizing: border-box;
        }

        /* Target all form rows regardless of class name */
        #intelligenceContent .form-row,
        #intelligenceContent .form-row-two,
        #intelligenceContent .form-row-three,
        #intelligenceContent .form-row-four,
        #intelligenceContent .form-row-five,
        #intelligenceContent .form-row-six,
        #intelligenceContent [class*="form-row"] {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-bottom: 16px;
        }

        /* Ensure form sections don't stretch */
        #intelligenceContent .form-section {
            max-width: 1400px;
            margin-bottom: 24px;
        }

        /* Override any inherited width styles */
        #intelligenceContent .form-section .form-group {
            flex: 0 0 auto !important;
            width: auto !important;
            max-width: 220px !important;
        }

        /* Specific handling for different row types */
        #intelligenceContent .form-row-six .form-group {
            flex: 0 1 calc(16.666% - 16px);
            min-width: 140px;
            max-width: 200px;
        }

        /* Ensure dropdowns don't stretch */
        #intelligenceContent select.form-input,
        #intelligenceContent .form-select {
            max-width: 220px !important;
        }

        /* For any row that doesn't have a specific class */
        #intelligenceContent .edit-form-container > div {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
        }

        #intelligenceContent .edit-form-container > div > .form-group {
            flex: 0 0 auto;
            max-width: 220px;
        }
    </style>
</head>
<body>
    <div class="command-center">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <h1 class="title">MCAagent</h1>
                <div class="connection-status" id="connectionStatus">
                    <span class="status-dot disconnected"></span>
                    <span class="status-text">Connecting...</span>
                </div>
            </div>
            <div class="header-right">
            </div>
        </header>

        <div class="main-content">
            <!-- Left Panel - Conversations List -->
            <div class="left-panel">
                <div class="panel-header">
                    <div class="panel-actions">
                        <button class="action-button primary" id="addLeadBtn" onclick="openNewLeadModal()">
                            New Lead
                        </button>
                        <button class="action-button secondary" id="csvImportBtn" onclick="window.location.href='csv-import.html'">
                            Import Leads
                        </button>
                        <button class="action-button secondary" id="reloadBtn" onclick="manualReloadConversations()">
                            Reload
                        </button>
                        <button class="action-button danger" id="deleteSelectedBtn" style="display: none;">
                            Delete Selected
                        </button>
                    </div>
                    <div class="panel-controls">
                        <select class="state-filter" id="stateFilter">
                            <option value="">All States</option>
                            <option value="INTERESTED">Interested</option>
                            <option value="FCS_RUNNING">FCS Running</option>
                            <option value="COLLECTING_INFO">Collecting Info</option>
                            <option value="QUALIFIED">Qualified</option>
                            <option value="OFFER_SENT">Offer Sent</option>
                            <option value="NEGOTIATING">Negotiating</option>
                            <option value="ACCEPTED">Accepted</option>
                        </select>
                        <input type="text" class="search-field" id="searchInput" placeholder="Search conversations">
                    </div>
                </div>
                <div class="conversations-list" id="conversationsList">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <p>Loading conversations...</p>
                    </div>
                </div>
            </div>

            <!-- Center Panel - Conversation Thread -->
            <div class="center-panel">
                <div class="panel-header">
                    <div class="conversation-info" id="conversationInfo">
                        <h2>Select a conversation</h2>
                        <p>Choose a conversation from the left to view messages</p>
                    </div>
                    <!-- Center panel is now messaging-only - action buttons moved to right panel -->
                </div>
                <div class="messages-container" id="messagesContainer">
                    <div class="empty-state">
                        <div class="empty-icon">ðŸ’¬</div>
                        <h3>No conversation selected</h3>
                        <p>Select a conversation from the left panel to view the message thread</p>
                    </div>
                </div>
                <div class="message-input-container" id="messageInputContainer" style="display: none;">
                    <div class="ai-suggestions" id="aiSuggestions" style="display: none;">
                        <div class="suggestions-header">
                            <span>AI Suggestions:</span>
                            <button class="close-suggestions" id="closeSuggestions">Ã—</button>
                        </div>
                        <div class="suggestions-list" id="suggestionsList"></div>
                    </div>
                    <div class="input-row">
                        <button class="attachment-icon" id="attachmentBtn" title="Attach file">ðŸ“Ž</button>
                        <textarea class="message-input" id="messageInput" placeholder="Message" rows="1"></textarea>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Lead Intelligence -->
            <div class="right-panel">
                <div class="panel-header">
                    <h2>Lead Intelligence</h2>
                    <div class="intelligence-tabs" id="intelligenceTabs">
                        <button class="tab-btn active" data-tab="ai-assistant">AI Agent</button>
                        <button class="tab-btn" data-tab="documents">Documents</button>
                        <button class="tab-btn" data-tab="edit">Edit</button>
                        <button class="tab-btn" data-tab="fcs">FCS</button>
                        <button class="tab-btn" data-tab="lenders">Lenders</button>
                        <button class="tab-btn" data-tab="lender-management">Manage Lenders</button>
                    </div>
                </div>
                <div class="intelligence-content" id="intelligenceContent">
                    <div class="empty-state">
                        <div class="empty-icon">ðŸ“Š</div>
                        <h3>No data available</h3>
                        <p>Select a conversation to view lead intelligence</p>
                    </div>

                    <!-- Hidden containers for different tabs -->
                    <div id="lenderForm" style="display: none;"></div>
                    <div id="lenderResults" style="display: none;"></div>
                    <div id="lenderLoading" style="display: none;"></div>
                    <div id="lenderErrorMsg" style="display: none;"></div>
                    <div id="lendersTableContainer" style="display: none;"></div>
                    <div id="lenderTibDisplay" style="display: none;"></div>
                    <div id="fcsDocumentSelection" style="display: none;"></div>
                    <div id="fcsResults" style="display: none;"></div>
                    <div id="fcsLoading" style="display: none;"></div>
                    <div id="fcsErrorMsg" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- Status Bar -->
        <div class="status-bar">
            <div class="status-left">
                <span id="lastUpdated">Last updated: Never</span>
            </div>
            <div class="status-center">
                <div class="processing-indicator" id="processingIndicator" style="display: none;">
                    <div class="loading-spinner small"></div>
                    <span id="processingText">Processing...</span>
                </div>
            </div>
            <div class="status-right">
                <span id="systemStatus">System: Ready</span>
            </div>
        </div>
    </div>

    <!-- Modals -->

    <div class="modal" id="lenderModal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Qualify Lenders</h3>
                <button class="modal-close" id="closeLenderModal">Ã—</button>
            </div>
            <div class="modal-body">
                <p>This will run lender qualification based on the current conversation data and FCS results (if available).</p>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="useExistingData" checked>
                        Use existing conversation and FCS data
                    </label>
                </div>
                <div class="form-group" id="manualDataGroup" style="display: none;">
                    <label>Business Name</label>
                    <input type="text" id="lenderBusinessName" class="form-input">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelLender">Cancel</button>
                <button class="btn btn-primary" id="confirmLender">Qualify Lenders</button>
            </div>
        </div>
    </div>

    <!-- Add Lead Modal -->
    <div class="modal" id="addLeadModal" style="display: none;">
        <div class="modal-content comprehensive-modal">
            <div class="modal-header">
                <h3>Add New Lead</h3>
                <button class="modal-close" id="closeAddLeadModal">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="edit-form-container">
                    <!-- Business Information Section -->
                    <div class="form-section">
                    <div class="section-header" onclick="toggleSection('businessInfo')">
                        <h4>ðŸ“Š Business Information</h4>
                        <span class="section-toggle">âˆ’</span>
                    </div>
                    <div class="section-content" id="businessInfo">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Company Name <span class="required">*</span></label>
                                <input type="text" id="companyName" class="form-input" placeholder="ABC Corporation">
                            </div>
                            <div class="form-group">
                                <label>Doing Business As (DBA)</label>
                                <input type="text" id="dbaName" class="form-input" placeholder="ABC Corp">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Primary Phone <span class="required">*</span></label>
                                <input type="tel" id="primaryPhone" class="form-input" placeholder="(555) 123-4567">
                            </div>
                            <div class="form-group">
                                <label>Business Phone</label>
                                <input type="tel" id="businessPhone" class="form-input" placeholder="(555) 987-6543">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Website</label>
                                <input type="url" id="website" class="form-input" placeholder="https://www.example.com">
                            </div>
                            <div class="form-group">
                                <label>Tax ID (Encrypted)</label>
                                <input type="text" id="federalTaxId" class="form-input" placeholder="12-3456789">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Entity Type</label>
                                <select id="entityType" class="form-select">
                                    <option value="">Select Entity Type...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Industry Type</label>
                                <select id="industryType" class="form-select">
                                    <option value="">Select Industry...</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Time in Business (Months)</label>
                                <input type="number" id="timeInBusiness" class="form-input" placeholder="24" min="1" max="999">
                            </div>
                            <div class="form-group">
                                <label>Requested Amount</label>
                                <input type="number" id="requestedAmount" class="form-input" placeholder="50000" min="1000" max="10000000" step="1000">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Monthly Revenue</label>
                                <input type="number" id="monthlyRevenue" class="form-input" placeholder="25000" min="0" max="50000000" step="1000">
                            </div>
                            <div class="form-group">
                                <label>Annual Revenue</label>
                                <input type="number" id="annualRevenue" class="form-input" placeholder="300000" min="0" max="500000000" step="10000">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Business Address</label>
                                <input type="text" id="businessAddress" class="form-input" placeholder="123 Main Street">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" id="businessCity" class="form-input" placeholder="Los Angeles">
                            </div>
                            <div class="form-group">
                                <label>State</label>
                                <select id="businessState" class="form-select">
                                    <option value="">Select State...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ZIP Code</label>
                                <input type="text" id="businessZip" class="form-input" placeholder="90210">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Lead Source</label>
                                <select id="leadSource" class="form-select">
                                    <option value="">Select Source...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Priority</label>
                                <select id="priority" class="form-select">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Owner Information Section -->
                <div class="form-section">
                    <div class="section-header" onclick="toggleSection('owner1Info')">
                        <h4>ðŸ‘¤ Owner Information</h4>
                        <span class="section-toggle">âˆ’</span>
                    </div>
                    <div class="section-content" id="owner1Info">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Owner First Name</label>
                                <input type="text" id="owner1FirstName" class="form-input" placeholder="John">
                            </div>
                            <div class="form-group">
                                <label>Owner Last Name</label>
                                <input type="text" id="owner1LastName" class="form-input" placeholder="Smith">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Owner Email</label>
                                <input type="email" id="owner1Email" class="form-input" placeholder="john@example.com">
                            </div>
                            <div class="form-group">
                                <label>Owner Phone</label>
                                <input type="tel" id="owner1Phone" class="form-input" placeholder="(555) 123-4567">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Owner Ownership %</label>
                                <input type="number" id="owner1OwnershipPercentage" class="form-input" placeholder="50" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label>Owner Date of Birth</label>
                                <input type="date" id="owner1DateOfBirth" class="form-input">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Owner Home Address</label>
                                <input type="text" id="owner1HomeAddress" class="form-input" placeholder="456 Oak Street">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Owner City</label>
                                <input type="text" id="owner1HomeCity" class="form-input" placeholder="Los Angeles">
                            </div>
                            <div class="form-group">
                                <label>Owner State</label>
                                <select id="owner1HomeState" class="form-select">
                                    <option value="">Select State...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Owner ZIP Code</label>
                                <input type="text" id="owner1HomeZip" class="form-input" placeholder="90210">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Owner SSN (Encrypted)</label>
                                <input type="text" id="owner1SSN" class="form-input" placeholder="123-45-6789" maxlength="11">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Partner Information Section -->
                <div class="form-section">
                    <div class="section-header" onclick="toggleSection('owner2Info')">
                        <h4>ðŸ‘¤ Partner Information (Optional)</h4>
                        <span class="section-toggle">+</span>
                    </div>
                    <div class="section-content collapsed" id="owner2Info" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Partner First Name</label>
                                <input type="text" id="owner2FirstName" class="form-input" placeholder="Jane">
                            </div>
                            <div class="form-group">
                                <label>Partner Last Name</label>
                                <input type="text" id="owner2LastName" class="form-input" placeholder="Smith">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Partner Email</label>
                                <input type="email" id="owner2Email" class="form-input" placeholder="jane@example.com">
                            </div>
                            <div class="form-group">
                                <label>Partner Phone</label>
                                <input type="tel" id="owner2Phone" class="form-input" placeholder="(555) 987-6543">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Partner Ownership %</label>
                                <input type="number" id="owner2OwnershipPercentage" class="form-input" placeholder="50" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label>Partner Date of Birth</label>
                                <input type="date" id="owner2DateOfBirth" class="form-input">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Partner Home Address</label>
                                <input type="text" id="owner2HomeAddress" class="form-input" placeholder="789 Pine Street">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Partner City</label>
                                <input type="text" id="owner2HomeCity" class="form-input" placeholder="Los Angeles">
                            </div>
                            <div class="form-group">
                                <label>Partner State</label>
                                <select id="owner2HomeState" class="form-select">
                                    <option value="">Select State...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Partner ZIP Code</label>
                                <input type="text" id="owner2HomeZip" class="form-input" placeholder="90210">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Partner SSN (Encrypted)</label>
                                <input type="text" id="owner2SSN" class="form-input" placeholder="123-45-6789" maxlength="11">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Marketing and Notes Section -->
                <div class="form-section">
                    <div class="section-header" onclick="toggleSection('marketingNotes')">
                        <h4>ðŸ“§ Marketing & Notes</h4>
                        <span class="section-toggle">+</span>
                    </div>
                    <div class="section-content collapsed" id="marketingNotes" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Marketing Notifications</label>
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="marketingNotification" value="TEXT">
                                        <span class="radio-indicator"></span>
                                        Text Only
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="marketingNotification" value="EMAIL">
                                        <span class="radio-indicator"></span>
                                        Email Only
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="marketingNotification" value="BOTH" checked>
                                        <span class="radio-indicator"></span>
                                        Both Text & Email
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Notes</label>
                                <textarea id="notes" class="form-textarea" rows="4" placeholder="Additional notes about this lead..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelAddLead">Cancel</button>
                <button class="btn btn-primary" id="confirmAddLead">Create Lead</button>
            </div>
        </div>
    </div>

    <!-- Edit Lead Modal -->
    <div class="modal" id="editLeadModal" style="display: none;">
        <div class="modal-content comprehensive-modal">
            <div class="modal-header">
                <h3>Edit Lead - Comprehensive CRM</h3>
                <button class="modal-close" id="closeEditLeadModal">Ã—</button>
            </div>
            <div class="modal-body">
                <div class="edit-form-container">
                    <!-- Business Information Section -->
                    <div class="form-section">
                    <div class="section-header" onclick="toggleSection('editBusinessInfo')">
                        <h4>ðŸ“Š Business Information</h4>
                        <span class="section-toggle">âˆ’</span>
                    </div>
                    <div class="section-content" id="editBusinessInfo">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Company Name <span class="required">*</span></label>
                                <input type="text" id="editCompanyName" class="form-input" placeholder="ABC Corporation">
                            </div>
                            <div class="form-group">
                                <label>Doing Business As (DBA)</label>
                                <input type="text" id="editDbaName" class="form-input" placeholder="ABC Corp">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Primary Phone <span class="required">*</span></label>
                                <input type="tel" id="editPrimaryPhone" class="form-input" placeholder="(555) 123-4567">
                            </div>
                            <div class="form-group">
                                <label>Business Phone</label>
                                <input type="tel" id="editBusinessPhone" class="form-input" placeholder="(555) 987-6543">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Website</label>
                                <input type="url" id="editWebsite" class="form-input" placeholder="https://www.example.com">
                            </div>
                            <div class="form-group">
                                <label>Tax ID (Encrypted)</label>
                                <input type="text" id="editTaxId" class="form-input" placeholder="12-3456789">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Entity Type</label>
                                <select id="editEntityType" class="form-select">
                                    <option value="">Select Entity Type...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Industry Type</label>
                                <select id="editIndustryType" class="form-select">
                                    <option value="">Select Industry...</option>
                                </select>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Time in Business (Months)</label>
                                <input type="number" id="editTimeInBusiness" class="form-input" placeholder="24" min="1" max="999">
                            </div>
                            <div class="form-group">
                                <label>Requested Amount</label>
                                <input type="number" id="editRequestedAmount" class="form-input" placeholder="50000" min="1000" max="10000000" step="1000">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Monthly Revenue</label>
                                <input type="number" id="editMonthlyRevenue" class="form-input" placeholder="25000" min="0" max="50000000" step="1000">
                            </div>
                            <div class="form-group">
                                <label>Annual Revenue</label>
                                <input type="number" id="editAnnualRevenue" class="form-input" placeholder="300000" min="0" max="500000000" step="10000">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Business Address</label>
                                <input type="text" id="editBusinessAddress" class="form-input" placeholder="123 Main Street">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>City</label>
                                <input type="text" id="editBusinessCity" class="form-input" placeholder="Los Angeles">
                            </div>
                            <div class="form-group">
                                <label>State</label>
                                <select id="editBusinessState" class="form-select">
                                    <option value="">Select State...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>ZIP Code</label>
                                <input type="text" id="editBusinessZip" class="form-input" placeholder="90210">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Lead Source</label>
                                <select id="editLeadSource" class="form-select">
                                    <option value="">Select Source...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Priority</label>
                                <select id="editPriority" class="form-select">
                                    <option value="low">Low</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="high">High</option>
                                    <option value="urgent">Urgent</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Owner Information Section -->
                <div class="form-section">
                    <div class="section-header" onclick="toggleSection('editOwner1Info')">
                        <h4>ðŸ‘¤ Owner Information</h4>
                        <span class="section-toggle">âˆ’</span>
                    </div>
                    <div class="section-content" id="editOwner1Info">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Owner First Name</label>
                                <input type="text" id="editOwner1FirstName" class="form-input" placeholder="John">
                            </div>
                            <div class="form-group">
                                <label>Owner Last Name</label>
                                <input type="text" id="editOwner1LastName" class="form-input" placeholder="Smith">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Owner Email</label>
                                <input type="email" id="editOwner1Email" class="form-input" placeholder="john@example.com">
                            </div>
                            <div class="form-group">
                                <label>Owner Phone</label>
                                <input type="tel" id="editOwner1Phone" class="form-input" placeholder="(555) 123-4567">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Owner Ownership %</label>
                                <input type="number" id="editOwner1Ownership" class="form-input" placeholder="50" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label>Owner Date of Birth</label>
                                <input type="date" id="editOwner1DOB" class="form-input">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Owner Home Address</label>
                                <input type="text" id="editOwner1HomeAddress" class="form-input" placeholder="456 Oak Street">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Owner City</label>
                                <input type="text" id="editOwner1HomeCity" class="form-input" placeholder="Los Angeles">
                            </div>
                            <div class="form-group">
                                <label>Owner State</label>
                                <select id="editOwner1HomeState" class="form-select">
                                    <option value="">Select State...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Owner ZIP Code</label>
                                <input type="text" id="editOwner1HomeZip" class="form-input" placeholder="90210">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Owner SSN (Encrypted)</label>
                                <input type="text" id="editOwner1SSN" class="form-input" placeholder="123-45-6789" maxlength="11">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Partner Information Section -->
                <div class="form-section">
                    <div class="section-header" onclick="toggleSection('editOwner2Info')">
                        <h4>ðŸ‘¤ Partner Information (Optional)</h4>
                        <span class="section-toggle">+</span>
                    </div>
                    <div class="section-content collapsed" id="editOwner2Info" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Partner First Name</label>
                                <input type="text" id="editOwner2FirstName" class="form-input" placeholder="Jane">
                            </div>
                            <div class="form-group">
                                <label>Partner Last Name</label>
                                <input type="text" id="editOwner2LastName" class="form-input" placeholder="Smith">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Partner Email</label>
                                <input type="email" id="editOwner2Email" class="form-input" placeholder="jane@example.com">
                            </div>
                            <div class="form-group">
                                <label>Partner Phone</label>
                                <input type="tel" id="editOwner2Phone" class="form-input" placeholder="(555) 987-6543">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Partner Ownership %</label>
                                <input type="number" id="editOwner2Ownership" class="form-input" placeholder="50" min="0" max="100">
                            </div>
                            <div class="form-group">
                                <label>Partner Date of Birth</label>
                                <input type="date" id="editOwner2DOB" class="form-input">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Partner Home Address</label>
                                <input type="text" id="editOwner2HomeAddress" class="form-input" placeholder="789 Pine Street">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Partner City</label>
                                <input type="text" id="editOwner2HomeCity" class="form-input" placeholder="Los Angeles">
                            </div>
                            <div class="form-group">
                                <label>Partner State</label>
                                <select id="editOwner2HomeState" class="form-select">
                                    <option value="">Select State...</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Partner ZIP Code</label>
                                <input type="text" id="editOwner2HomeZip" class="form-input" placeholder="90210">
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label>Partner SSN (Encrypted)</label>
                                <input type="text" id="editOwner2SSN" class="form-input" placeholder="123-45-6789" maxlength="11">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Marketing and Notes Section -->
                <div class="form-section">
                    <div class="section-header" onclick="toggleSection('editMarketingNotes')">
                        <h4>ðŸ“§ Marketing & Notes</h4>
                        <span class="section-toggle">+</span>
                    </div>
                    <div class="section-content collapsed" id="editMarketingNotes" style="display: none;">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Marketing Notifications</label>
                                <div class="radio-group">
                                    <label class="radio-label">
                                        <input type="radio" name="editMarketingNotification" value="TEXT">
                                        <span class="radio-indicator"></span>
                                        Text Only
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="editMarketingNotification" value="EMAIL">
                                        <span class="radio-indicator"></span>
                                        Email Only
                                    </label>
                                    <label class="radio-label">
                                        <input type="radio" name="editMarketingNotification" value="BOTH" checked>
                                        <span class="radio-indicator"></span>
                                        Both Text & Email
                                    </label>
                                </div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label>Notes</label>
                                <textarea id="editNotes" class="form-textarea" rows="4" placeholder="Additional notes about this lead..."></textarea>
                            </div>
                        </div>
                    </div>
                </div>
                </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelEditLead">Cancel</button>
                <button class="btn btn-primary" id="saveEditLead">Save Changes</button>
            </div>
        </div>
    </div>

    <!-- Edit Lead Inline Modal -->
    <div class="modal" id="editLeadInlineModal" style="display: none;">
        <div class="modal-content" style="max-width: 1200px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Edit Lead Information</h3>
                <button class="modal-close" id="closeEditLeadInlineModal">&times;</button>
            </div>
            <div class="modal-body" id="editLeadInlineContent">
                <!-- Form content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Lenders Inline Modal -->
    <div class="modal" id="lendersInlineModal" style="display: none;">
        <div class="modal-content" style="max-width: 1400px; width: 95%; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h3>Lender Qualification & Submission</h3>
                <button class="modal-close" id="closeLendersInlineModal">&times;</button>
            </div>
            <div class="modal-body" id="lendersInlineContent">
                <!-- Lender form content will be injected here -->
            </div>
        </div>
    </div>

    <!-- Confirmation Dialogs -->
    <div class="modal" id="deleteConfirmModal" style="display: none;">
        <div class="modal-content small-modal">
            <div class="modal-header">
                <h3>âš ï¸ Delete Lead</h3>
                <button class="modal-close" id="closeDeleteConfirmModal">Ã—</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to <strong>permanently delete</strong> this lead?</p>
                <p class="warning-text">This action cannot be undone. All messages, FCS results, and lead data will be permanently removed.</p>
                <div class="lead-info" id="deleteLeadInfo">
                    <strong>Lead:</strong> <span id="deleteLeadName">Loading...</span><br>
                    <strong>Phone:</strong> <span id="deleteLeadPhone">Loading...</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelDelete">Cancel</button>
                <button class="btn btn-danger" id="confirmDelete">Delete Lead</button>
            </div>
        </div>
    </div>

    <div class="modal" id="archiveConfirmModal" style="display: none;">
        <div class="modal-content small-modal">
            <div class="modal-header">
                <h3>ðŸ“¦ Archive Lead</h3>
                <button class="modal-close" id="closeArchiveConfirmModal">Ã—</button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to <strong>archive</strong> this lead?</p>
                <p class="info-text">Archived leads can be restored later but won't appear in active conversations.</p>
                <div class="lead-info" id="archiveLeadInfo">
                    <strong>Lead:</strong> <span id="archiveLeadName">Loading...</span><br>
                    <strong>Phone:</strong> <span id="archiveLeadPhone">Loading...</span>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelArchive">Cancel</button>
                <button class="btn btn-primary" id="confirmArchive">Archive Lead</button>
            </div>
        </div>
    </div>

    <!-- Signature Modal -->
    <div class="modal" id="signatureModal" style="display: none;">
        <div class="modal-content signature-modal">
            <div class="modal-header">
                <h3>Sign Application</h3>
                <button class="modal-close" id="closeSignatureModal">Ã—</button>
            </div>
            <div class="modal-body">
                <p>Please sign below to authorize this Working Capital Application:</p>
                <div class="signature-container">
                    <canvas id="signatureCanvas" width="400" height="200"></canvas>
                </div>
                <div class="signature-controls">
                    <button class="btn btn-secondary" id="clearSignature">Clear</button>
                    <button class="btn btn-secondary" id="useTypedSignature">Use Typed Name</button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelSignature">Cancel</button>
                <button class="btn btn-primary" id="confirmSignature">Generate Application</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="notifications" id="notifications"></div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.5/socket.io.js"></script>
    <script>
        // Initialize WebSocket connection immediately after Socket.io loads
        if (typeof io !== 'undefined') {
            console.log('âœ… Socket.io loaded successfully');
            
            // Create global WebSocket connection
            window.globalSocket = io('http://localhost:3001', {
                transports: ['websocket', 'polling'],
                timeout: 20000
            });
            
            window.globalSocket.on('connect', () => {
                console.log('ðŸ”Œ Connected to WebSocket server:', window.globalSocket.id);
            });
            
            window.globalSocket.on('disconnect', () => {
                console.log('âŒ Disconnected from WebSocket server');
            });
            
            window.globalSocket.on('new_message', (data) => {
                console.log('ðŸ“¨ New message received via WebSocket:', data);
                
                // If we have conversation UI loaded, use the new handler method
                if (window.conversationUI && window.conversationUI.handleIncomingMessage) {
                    window.conversationUI.handleIncomingMessage(data);
                } else {
                    console.log('âš ï¸ ConversationUI not yet loaded, message will be shown when UI initializes');
                }
            });
            
            window.globalSocket.on('conversation_updated', (data) => {
                console.log('ðŸ“‹ Conversation updated via WebSocket:', data);
                
                // Refresh conversation list
                if (window.conversationUI) {
                    window.conversationUI.loadConversations();
                }
            });
            
            // Test connection
            window.globalSocket.emit('test', 'Hello from frontend!');
            
        } else {
            console.error('âŒ Socket.io failed to load from CDN');
        }
    </script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://unpkg.com/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/signature_pad/1.5.3/signature_pad.min.js"></script>
    <!-- 1. Utilities FIRST (no dependencies) -->
    <script src="js/templates-utilities.js"></script>

    <!-- 2. WebSocket (no dependencies on other modules) -->
    <script src="js/websocket.js"></script>

    <!-- 3. Core modules (depend on utilities) -->
    <script src="js/conversation-core.js"></script>
    <script src="js/messaging.js"></script>
    <script src="js/documents.js"></script>
    <script src="js/intelligence-tabs.js"></script>
    <script src="js/fcs-module.js"></script>
    <script src="js/lenders.js"></script>
    <script src="js/ai-assistant.js"></script>
    <script src="js/stats.js"></script>

    <!-- New Lead Form Generator -->
    <script src="js/new-lead-form.js"></script>

    <!-- 4. Main app LAST (depends on everything) -->
    <script src="js/command-center.js"></script>
    <script>
        // Comprehensive CRM Form Functions
        let lookupData = {};
        
        // Load lookup data for dropdowns
        async function loadLookupData() {
            try {
                console.log('ðŸ”§ Loading lookup data for dropdowns...');
                
                // For now, use static data since server might be having issues
                lookupData = {
                    states: [
                        { code: 'CA', name: 'California' },
                        { code: 'NY', name: 'New York' },
                        { code: 'TX', name: 'Texas' },
                        { code: 'FL', name: 'Florida' },
                        { code: 'IL', name: 'Illinois' }
                    ],
                    entityTypes: [
                        { id: 1, name: 'Corporation' },
                        { id: 2, name: 'LLC' },
                        { id: 3, name: 'Partnership' },
                        { id: 4, name: 'Sole Proprietorship' }
                    ],
                    industryTypes: [
                        { id: 1, name: 'Construction' },
                        { id: 2, name: 'Restaurant' },
                        { id: 3, name: 'Retail' },
                        { id: 4, name: 'Professional Services' },
                        { id: 5, name: 'Manufacturing' }
                    ],
                    leadSources: [
                        { id: 1, name: 'Google Ads' },
                        { id: 2, name: 'Facebook' },
                        { id: 3, name: 'LinkedIn' },
                        { id: 4, name: 'Referral' },
                        { id: 5, name: 'Website' }
                    ],
                    users: [
                        { id: 1, first_name: 'John', last_name: 'Smith' },
                        { id: 2, first_name: 'Sarah', last_name: 'Johnson' },
                        { id: 3, first_name: 'Mike', last_name: 'Wilson' }
                    ]
                };
                
                console.log('âœ… Lookup data loaded successfully');
                populateDropdowns();
            } catch (error) {
                console.error('âŒ Error loading lookup data:', error);
                // Initialize with empty arrays to prevent errors
                if (!lookupData || typeof lookupData !== 'object') {
                    lookupData = {
                        states: [],
                        entityTypes: [],
                        industryTypes: [],
                        leadSources: [],
                        users: []
                    };
                }
                console.log('âš ï¸ Using fallback empty data');
                populateDropdowns();
            }
        }
        
        // Populate dropdown options
        function populateDropdowns() {
            try {
                console.log('ðŸ”§ Populating dropdowns with lookup data...');
                
                // Check if lookupData is properly loaded
                if (!lookupData || typeof lookupData !== 'object') {
                    console.warn('âš ï¸ lookupData is not available, skipping dropdown population');
                    return;
                }
                
                // States
                const stateSelects = ['businessState', 'stateOfIncorporation', 'owner1HomeState', 'owner2HomeState'];
                if (lookupData.states && Array.isArray(lookupData.states)) {
                    stateSelects.forEach(selectId => {
                        const select = document.getElementById(selectId);
                        if (select) {
                            select.innerHTML = '<option value="">Select State...</option>';
                            lookupData.states.forEach(state => {
                                select.innerHTML += `<option value="${state.code}">${state.name}</option>`;
                            });
                        }
                    });
                    console.log('âœ… States populated successfully');
                } else {
                    console.warn('âš ï¸ States data not available');
                }
                
                // Entity Types
                const entitySelect = document.getElementById('entityType');
                if (entitySelect && lookupData.entityTypes && Array.isArray(lookupData.entityTypes)) {
                    entitySelect.innerHTML = '<option value="">Select Entity Type...</option>';
                    lookupData.entityTypes.forEach(type => {
                        entitySelect.innerHTML += `<option value="${type.name}">${type.name}</option>`;
                    });
                    console.log('âœ… Entity types populated successfully');
                } else {
                    console.warn('âš ï¸ Entity types data not available');
                }
                
                // Industry Types
                const industrySelect = document.getElementById('industryType');
                if (industrySelect && lookupData.industryTypes && Array.isArray(lookupData.industryTypes)) {
                    industrySelect.innerHTML = '<option value="">Select Industry...</option>';
                    lookupData.industryTypes.forEach(type => {
                        industrySelect.innerHTML += `<option value="${type.name}">${type.name}</option>`;
                    });
                    console.log('âœ… Industry types populated successfully');
                } else {
                    console.warn('âš ï¸ Industry types data not available');
                }
                
                // Lead Sources
                const leadSourceSelect = document.getElementById('leadSource');
                if (leadSourceSelect && lookupData.leadSources && Array.isArray(lookupData.leadSources)) {
                    leadSourceSelect.innerHTML = '<option value="">Select Lead Source...</option>';
                    lookupData.leadSources.forEach(source => {
                        leadSourceSelect.innerHTML += `<option value="${source.name}">${source.name}</option>`;
                    });
                    console.log('âœ… Lead sources populated successfully');
                } else {
                    console.warn('âš ï¸ Lead sources data not available');
                }
                
                // Users
                const assignedToSelect = document.getElementById('assignedTo');
                if (assignedToSelect && lookupData.users && Array.isArray(lookupData.users)) {
                    assignedToSelect.innerHTML = '<option value="">Select User...</option>';
                    lookupData.users.forEach(user => {
                        assignedToSelect.innerHTML += `<option value="${user.first_name} ${user.last_name}">${user.first_name} ${user.last_name}</option>`;
                    });
                    console.log('âœ… Users populated successfully');
                } else {
                    console.warn('âš ï¸ Users data not available');
                }
                
                console.log('âœ… Dropdown population completed');
            } catch (error) {
                console.error('âŒ Error populating dropdowns:', error);
                // Don't throw the error to prevent the global error handler from triggering
            }
        }
        
        // Toggle collapsible sections
        function toggleSection(sectionId) {
            const content = document.getElementById(sectionId);
            const toggle = content.previousElementSibling.querySelector('.section-toggle');
            
            if (content.classList.contains('collapsed')) {
                content.classList.remove('collapsed');
                toggle.textContent = 'âˆ’';
                toggle.classList.remove('collapsed');
            } else {
                content.classList.add('collapsed');
                toggle.textContent = '+';
                toggle.classList.add('collapsed');
            }
        }
        
        // Toggle Partner section
        function toggleOwner2Section() {
            try {
                console.log('ðŸ”„ Toggling Partner section...');
                
                const checkbox = document.getElementById('addSecondOwner');
                const owner2Info = document.getElementById('owner2Info');
                const owner2Toggle = document.getElementById('owner2Toggle');
                
                if (!checkbox) {
                    console.warn('âš ï¸ addSecondOwner checkbox not found');
                    return;
                }
                
                if (!owner2Info) {
                    console.warn('âš ï¸ owner2Info element not found');
                    return;
                }
                
                if (!owner2Toggle) {
                    console.warn('âš ï¸ owner2Toggle element not found');
                    return;
                }
                
                if (checkbox.checked) {
                    owner2Info.style.display = 'block';
                    owner2Toggle.style.display = 'block';
                    console.log('âœ… Partner section shown');
                } else {
                    owner2Info.style.display = 'none';
                    owner2Toggle.style.display = 'none';
                    console.log('âœ… Partner section hidden');
                    
                    // Clear Partner fields safely
                    try {
                        const owner2Fields = owner2Info.querySelectorAll('input, select');
                        owner2Fields.forEach((field, index) => {
                            try {
                                field.value = '';
                            } catch (fieldError) {
                                console.warn(`âš ï¸ Error clearing Partner field ${index}:`, fieldError);
                            }
                        });
                        console.log('âœ… Partner fields cleared');
                    } catch (clearError) {
                        console.warn('âš ï¸ Error clearing Partner fields:', clearError);
                    }
                }
                
            } catch (error) {
                console.error('ðŸš¨ Error in toggleOwner2Section:', error);
                // Don't re-throw, just log and continue
            }
        }
        
        // Collect comprehensive form data
        function collectComprehensiveFormData() {
            const formData = {
                // Business Information
                companyName: document.getElementById('companyName').value,
                dbaName: document.getElementById('dbaName').value,
                firstName: document.getElementById('firstName').value,
                lastName: document.getElementById('lastName').value,
                businessAddress: document.getElementById('businessAddress').value,
                businessAddress2: document.getElementById('businessAddress2').value,
                businessCountry: document.getElementById('businessCountry').value,
                businessState: document.getElementById('businessState').value,
                businessCity: document.getElementById('businessCity').value,
                businessZip: document.getElementById('businessZip').value,
                primaryPhone: document.getElementById('primaryPhone').value,
                cellPhone: document.getElementById('cellPhone').value,
                workPhone: document.getElementById('workPhone').value,
                faxPhone: document.getElementById('faxPhone').value,
                federalTaxId: document.getElementById('federalTaxId').value,
                businessStartDate: document.getElementById('businessStartDate').value,
                lengthOfOwnership: document.getElementById('lengthOfOwnership').value,
                website: document.getElementById('website').value,
                stateOfIncorporation: document.getElementById('stateOfIncorporation').value,
                entityType: document.getElementById('entityType').value,
                industryType: document.getElementById('industryType').value,
                businessEmail: document.getElementById('businessEmail').value,
                productSold: document.getElementById('productSold').value,
                useOfProceeds: document.getElementById('useOfProceeds').value,
                annualRevenue: document.getElementById('annualRevenue').value,
                monthlyRevenue: document.getElementById('monthlyRevenue').value,
                requestedAmount: document.getElementById('requestedAmount').value,
                leadSource: document.getElementById('leadSource').value,
                leadStatus: document.getElementById('leadStatus').value,
                assignedTo: document.getElementById('assignedTo').value,
                disposition: document.getElementById('disposition').value,
                campaign: document.getElementById('campaign').value,
                optOutDripCampaign: document.getElementById('optOutDripCampaign').value === 'true',
                marketingNotification: document.querySelector('input[name="marketingNotification"]:checked')?.value || 'BOTH',
                
                // Owner Information
                owner1: {
                    firstName: document.getElementById('owner1FirstName').value,
                    lastName: document.getElementById('owner1LastName').value,
                    email: document.getElementById('owner1Email').value,
                    ownershipPercentage: document.getElementById('owner1OwnershipPercentage').value,
                    homeAddress: document.getElementById('owner1HomeAddress').value,
                    homeAddress2: document.getElementById('owner1HomeAddress2').value,
                    homeCountry: document.getElementById('owner1HomeCountry').value,
                    homeState: document.getElementById('owner1HomeState').value,
                    homeCity: document.getElementById('owner1HomeCity').value,
                    homeZip: document.getElementById('owner1HomeZip').value,
                    ssn: document.getElementById('owner1SSN').value,
                    dateOfBirth: document.getElementById('owner1DateOfBirth').value
                }
            };
            
            // Add Partner if checkbox is checked
            if (document.getElementById('addSecondOwner').checked) {
                formData.owner2 = {
                    firstName: document.getElementById('owner2FirstName').value,
                    lastName: document.getElementById('owner2LastName').value,
                    email: document.getElementById('owner2Email').value,
                    ownershipPercentage: document.getElementById('owner2OwnershipPercentage').value,
                    homeAddress: document.getElementById('owner2HomeAddress').value,
                    homeAddress2: document.getElementById('owner2HomeAddress2').value,
                    homeCountry: document.getElementById('owner2HomeCountry').value,
                    homeState: document.getElementById('owner2HomeState').value,
                    homeCity: document.getElementById('owner2HomeCity').value,
                    homeZip: document.getElementById('owner2HomeZip').value,
                    ssn: document.getElementById('owner2SSN').value,
                    dateOfBirth: document.getElementById('owner2DateOfBirth').value
                };
            }
            
            return formData;
        }
        
        // Validate comprehensive form
        function validateComprehensiveForm(data) {
            const errors = [];
            
            // Required fields
            if (!data.companyName) errors.push('Company Name is required');
            if (!data.primaryPhone) errors.push('Primary Phone is required');
            
            // Phone validation
            const phoneRegex = /^\(?([0-9]{3})\)?[-. ]?([0-9]{3})[-. ]?([0-9]{4})$/;
            if (data.primaryPhone && !phoneRegex.test(data.primaryPhone)) {
                errors.push('Primary Phone must be a valid phone number');
            }
            
            // Email validation
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (data.businessEmail && !emailRegex.test(data.businessEmail)) {
                errors.push('Business Email must be valid');
            }
            
            if (data.owner1?.email && !emailRegex.test(data.owner1.email)) {
                errors.push('Owner Email must be valid');
            }
            
            if (data.owner2?.email && !emailRegex.test(data.owner2.email)) {
                errors.push('Partner Email must be valid');
            }
            
            return errors;
        }
        
        // Clear comprehensive form with null safety
        function clearComprehensiveForm() {
            try {
                console.log('ðŸ§¹ Clearing comprehensive form...');
                const modal = document.getElementById('addLeadModal');
                
                if (!modal) {
                    console.warn('âš ï¸ Modal not found, skipping form clear');
                    return;
                }
                
                const inputs = modal.querySelectorAll('input, select, textarea');
                console.log(`ðŸ” Found ${inputs.length} form inputs to clear`);
                
                inputs.forEach((input, index) => {
                    try {
                        if (input.type === 'radio') {
                            input.checked = input.value === 'BOTH' && input.name === 'marketingNotification';
                        } else if (input.type === 'checkbox') {
                            input.checked = false;
                        } else {
                            input.value = '';
                        }
                    } catch (inputError) {
                        console.warn(`âš ï¸ Error clearing input ${index}:`, inputError);
                    }
                });
                
                // Reset lead status to default (with null check)
                const leadStatusEl = document.getElementById('leadStatus');
                if (leadStatusEl) {
                    leadStatusEl.value = 'SUBMITTED';
                    console.log('âœ… Lead status reset to SUBMITTED');
                } else {
                    console.warn('âš ï¸ leadStatus element not found');
                }
                
                // Hide Partner section (with null checks)
                const owner2Info = document.getElementById('owner2Info');
                const owner2Toggle = document.getElementById('owner2Toggle');
                
                if (owner2Info) {
                    owner2Info.style.display = 'none';
                    console.log('âœ… Partner info hidden');
                } else {
                    console.warn('âš ï¸ owner2Info element not found');
                }
                
                if (owner2Toggle) {
                    owner2Toggle.style.display = 'none';
                    console.log('âœ… Partner toggle hidden');
                } else {
                    console.warn('âš ï¸ owner2Toggle element not found');
                }
                
                console.log('âœ… Form cleared successfully');
                
            } catch (error) {
                console.error('ðŸš¨ Error in clearComprehensiveForm:', error);
                // Don't re-throw error - just log and continue silently
                // This prevents modal opening issues
            }
        }
        
        // DEPRECATED - These functions are replaced by the event listener in DOMContentLoaded
        // See line ~3260 for the new Add Lead button handler
        /*
        function showEditModalForNewLead() { ... }
        function openAddLeadModal() { ... }
        */

        // Clear edit form function
        function clearEditForm() {
            const modal = document.getElementById('editLeadModal');
            if (!modal) return;

            console.log('ðŸ§¹ Clearing edit form...');

            const inputs = modal.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                if (input.type === 'radio') {
                    input.checked = input.value === 'BOTH' && input.name === 'editMarketingNotification';
                } else if (input.type === 'checkbox') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
            });

            console.log('âœ… Form cleared');
        }
        
        // DEPRECATED - testSimpleAdd function removed
        // Use the Add Lead button which opens the Edit modal in create mode
        
        // Enhanced debug logging
        console.log('ðŸ”§ Main script loading...');
        
        // Debug all required classes
        window.debugClasses = function() {
            console.log('ðŸ” Class availability check:');
            console.log('- CommandCenter:', typeof CommandCenter);
            console.log('- ConversationUI:', typeof ConversationUI);
            console.log('- StateManager:', typeof StateManager);
            console.log('- WebSocketManager:', typeof WebSocketManager);
        };
        
        // Debug API connection
        window.testAPI = async function() {
            console.log('ðŸ§ª Testing API connection...');
            try {
                const response = await fetch('http://localhost:3001/api/conversations');
                const data = await response.json();
                console.log('âœ… API Response:', data);
                return data;
            } catch (error) {
                console.error('âŒ API Error:', error);
                return null;
            }
        };
        
        // Force conversations reload
        window.forceReload = function() {
            console.log('ðŸš€ Force reload conversations...');
            fetch('http://localhost:3001/api/conversations')
                .then(response => response.json())
                .then(data => {
                    console.log('ðŸ“‹ Got conversations data:', data);
                    if (window.commandCenter && window.commandCenter.conversationUI) {
                        // Force update the UI
                        const conversationsList = document.getElementById('conversationsList');
                        if (conversationsList) {
                            conversationsList.innerHTML = '<div class="loading">âœ… API Working - Found ' + data.length + ' conversations</div>';
                        }
                    }
                })
                .catch(error => {
                    console.error('âŒ Force reload failed:', error);
                    const conversationsList = document.getElementById('conversationsList');
                    if (conversationsList) {
                        conversationsList.innerHTML = '<div class="error">âŒ API Error: ' + error.message + '</div>';
                    }
                });
        };
        
        // Debug DOM elements
        window.debugDOM = function() {
            console.log('ðŸ” DOM elements check:');
            const addLeadBtn = document.getElementById('addLeadBtn');
            const testBtn = document.getElementById('testAddLeadBtn');
            const modal = document.getElementById('addLeadModal');
            
            console.log('- Add Lead Button:', addLeadBtn);
            console.log('- Add Lead Button text:', addLeadBtn ? addLeadBtn.textContent : 'null');
            console.log('- Add Lead Button visible:', addLeadBtn ? (addLeadBtn.offsetWidth > 0 && addLeadBtn.offsetHeight > 0) : false);
            console.log('- Test Button:', testBtn);
            console.log('- Test Button visible:', testBtn ? (testBtn.offsetWidth > 0 && testBtn.offsetHeight > 0) : false);
            console.log('- Add Lead Modal:', modal);
        };
        
        // Manual button test
        window.testAddLeadButton = function() {
            const modal = document.getElementById('addLeadModal');
            if (modal) {
                modal.style.display = 'flex';
                console.log('âœ… Modal opened manually');
            } else {
                console.log('âŒ Modal not found');
            }
        };
        
        // Initialize comprehensive form
        function initializeComprehensiveForm() {
            console.log('ðŸ”§ Initializing comprehensive form...');
            
            // Load lookup data
            loadLookupData();
            
            // Set up modal event listeners
            const modal = document.getElementById('addLeadModal');
            const closeBtn = document.getElementById('closeAddLeadModal');
            const cancelBtn = document.getElementById('cancelAddLead');
            const confirmBtn = document.getElementById('confirmAddLead');
            
            if (!modal) {
                console.warn('âš ï¸ Modal not found during initialization');
                return;
            }
            
            if (closeBtn) {
                closeBtn.onclick = () => {
                    modal.style.display = 'none';
                    clearComprehensiveForm();
                };
            }
            
            if (cancelBtn) {
                cancelBtn.onclick = () => {
                    modal.style.display = 'none';
                    clearComprehensiveForm();
                };
            }
            
            if (confirmBtn) {
                confirmBtn.onclick = async () => {
                    console.log('ðŸš€ Creating comprehensive lead...');
                    
                    const formData = collectComprehensiveFormData();
                    const errors = validateComprehensiveForm(formData);
                    
                    if (errors.length > 0) {
                        alert('Please fix the following errors:\n' + errors.join('\n'));
                        return;
                    }
                    
                    try {
                        // For now, create a simplified lead for the existing API
                        const leadData = {
                            businessName: formData.companyName,
                            phone: formData.primaryPhone,
                            message: `Comprehensive lead created from CRM form. Industry: ${formData.industryType}`,
                            requestedAmount: formData.requestedAmount,
                            priority: 'normal'
                        };
                        
                        console.log('ðŸ“¤ Sending lead data:', leadData);
                        
                        const response = await fetch('http://localhost:3001/api/conversations', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(leadData)
                        });
                        
                        const result = await response.json();
                        
                        if (result.success) {
                            alert('âœ… Lead created successfully!');
                            modal.style.display = 'none';
                            clearComprehensiveForm();
                            location.reload(); // Refresh to show new lead
                        } else {
                            alert('âŒ Error creating lead: ' + (result.error || 'Unknown error'));
                        }
                        
                    } catch (error) {
                        console.error('Error creating lead:', error);
                        alert('âŒ Connection error: ' + error.message);
                    }
                };
            }
            
            // Close modal when clicking outside
            modal.onclick = (e) => {
                if (e.target === modal) {
                    modal.style.display = 'none';
                    clearComprehensiveForm();
                }
            };
            
            console.log('âœ… Comprehensive form initialized');
        }
        
        // Initialize the command center
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ðŸš€ DOM Content Loaded');

            // Initialize comprehensive form - Re-enabled for standalone Add Lead modal
            setTimeout(initializeComprehensiveForm, 100);
            
            // Run debug checks
            setTimeout(debugClasses, 100);
            setTimeout(debugDOM, 500);
            
            try {
                // Check if classes are available
                if (typeof CommandCenter === 'undefined') {
                    console.error('âŒ CommandCenter class not loaded!');
                    return;
                }
                
                window.commandCenter = new CommandCenter();
                console.log('âœ… CommandCenter instance created and initialized');
                
                // Add reload conversations function
                window.reloadConversations = function() {
                    console.log('ðŸ”„ Manual reload conversations triggered');
                    if (window.commandCenter && window.commandCenter.conversationUI) {
                        window.commandCenter.conversationUI.loadConversations();
                    } else {
                        console.error('âŒ CommandCenter or ConversationUI not available');
                    }
                };
                
                // Add manual reload function for button
                window.manualReloadConversations = function() {
                    console.log('ðŸ”„ Manual button reload triggered');
                    try {
                        if (window.commandCenter && window.commandCenter.conversationUI) {
                            console.log('ðŸ“¡ Calling loadInitialData...');
                            window.commandCenter.conversationUI.loadInitialData();
                        } else {
                            console.error('âŒ CommandCenter or ConversationUI not available');
                            alert('CommandCenter not initialized yet. Please wait and try again.');
                        }
                    } catch (error) {
                        console.error('âŒ Manual reload error:', error);
                        alert('Error reloading: ' + error.message);
                    }
                };
                
                // Auto-retry conversations loading after delay
                setTimeout(() => {
                    console.log('â° Auto-retry conversations loading...');
                    if (window.commandCenter && window.commandCenter.conversationUI) {
                        const conversationsList = document.getElementById('conversationsList');
                        if (conversationsList && conversationsList.innerHTML.includes('Loading conversations...')) {
                            console.log('ðŸ”„ Still loading - retrying...');
                            window.commandCenter.conversationUI.loadConversations();
                        }
                    }
                }, 3000);
                
            } catch (error) {
                console.error('âŒ Error initializing CommandCenter:', error);
                console.error('Stack trace:', error.stack);
            }
        });
        
        // Global error handler
        window.addEventListener('error', (e) => {
            console.error('ðŸš¨ Global JavaScript Error:', e.error);
            console.error('File:', e.filename);
            console.error('Line:', e.lineno);
        });

        // Lead Management Functionality
        let currentEditingLeadId = null;
        let currentConversationId = null;
        let currentConversation = null;

        // Initialize lead management functionality
        function initializeLeadManagement() {
            console.log('ðŸ”§ Initializing lead management...');

            // Lead actions dropdown functionality
            const leadActionsBtn = document.getElementById('leadActionsBtn');
            const leadActionsMenu = document.getElementById('leadActionsMenu');
            
            if (leadActionsBtn && leadActionsMenu) {
                leadActionsBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleLeadActionsDropdown();
                });

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (!leadActionsBtn.contains(e.target) && !leadActionsMenu.contains(e.target)) {
                        closeLeadActionsDropdown();
                    }
                });
            }

            // Edit lead button
            const editLeadBtn = document.getElementById('editLeadBtn');
            if (editLeadBtn) {
                editLeadBtn.addEventListener('click', () => {
                    closeLeadActionsDropdown();
                    openEditLeadModal();
                });
            }

            // Clone lead button
            const cloneLeadBtn = document.getElementById('cloneLeadBtn');
            if (cloneLeadBtn) {
                cloneLeadBtn.addEventListener('click', () => {
                    closeLeadActionsDropdown();
                    cloneLead();
                });
            }

            // Archive lead button
            const archiveLeadBtn = document.getElementById('archiveLeadBtn');
            if (archiveLeadBtn) {
                archiveLeadBtn.addEventListener('click', () => {
                    closeLeadActionsDropdown();
                    showArchiveConfirmation();
                });
            }

            // Delete lead button
            const deleteLeadBtn = document.getElementById('deleteLeadBtn');
            if (deleteLeadBtn) {
                deleteLeadBtn.addEventListener('click', () => {
                    closeLeadActionsDropdown();
                    showDeleteConfirmation();
                });
            }

            // Edit modal event listeners
            setupEditModalEventListeners();
            setupConfirmationDialogs();
        }

        function toggleLeadActionsDropdown() {
            const btn = document.getElementById('leadActionsBtn');
            const menu = document.getElementById('leadActionsMenu');
            
            const isOpen = btn.classList.contains('open');
            
            if (isOpen) {
                closeLeadActionsDropdown();
            } else {
                btn.classList.add('open');
                menu.classList.add('show');
                menu.style.display = 'block';
                
                // Animate in
                setTimeout(() => {
                    menu.style.opacity = '1';
                    menu.style.transform = 'translateY(0)';
                }, 10);
            }
        }

        function closeLeadActionsDropdown() {
            const btn = document.getElementById('leadActionsBtn');
            const menu = document.getElementById('leadActionsMenu');
            
            btn.classList.remove('open');
            menu.classList.remove('show');
            
            setTimeout(() => {
                menu.style.display = 'none';
            }, 200);
        }

        async function openEditLeadModal() {
            // Get current conversation from ConversationUI
            const conversationUI = window.commandCenter?.conversationUI;
            const selectedConversationId = conversationUI?.currentConversationId;
            const selectedConversation = conversationUI?.selectedConversation;
            
            if (!selectedConversationId || !selectedConversation) {
                showNotification('Please select a lead to edit', 'error');
                console.warn('No conversation selected. ConversationUI state:', {
                    conversationUI: !!conversationUI,
                    currentConversationId: selectedConversationId,
                    selectedConversation: !!selectedConversation
                });
                return;
            }

            try {
                // Show loading
                showNotification('Loading lead data...', 'info');

                // Get lead data using existing endpoint
                const response = await fetch(`http://localhost:3001/api/conversations/${selectedConversationId}`);
                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to load lead data');
                }

                currentEditingLeadId = selectedConversationId;
                populateEditForm(result.conversation);
                
                const modal = document.getElementById('editLeadModal');
                modal.style.display = 'flex';

                showNotification('Lead data loaded successfully', 'success');

            } catch (error) {
                console.error('Error opening edit modal:', error);
                showNotification('Failed to load lead data: ' + error.message, 'error');
            }
        }

        function populateEditForm(conversation) {
            console.log('Populating edit form with conversation data:', conversation);
            
            // Business Information - map database fields to form fields
            const setFieldValue = (fieldId, value) => {
                const field = document.getElementById(fieldId);
                if (field) {
                    field.value = value || '';
                } else {
                    console.warn(`Field ${fieldId} not found in edit form`);
                }
            };
            
            // Map conversation database fields to edit form fields
            setFieldValue('editCompanyName', conversation.business_name);
            setFieldValue('editDbaName', conversation.dba_name);
            setFieldValue('editPrimaryPhone', conversation.lead_phone);
            setFieldValue('editBusinessPhone', conversation.business_phone);
            setFieldValue('editWebsite', conversation.website);
            setFieldValue('editTaxId', conversation.tax_id);
            setFieldValue('editEntityType', conversation.entity_type_id);
            setFieldValue('editIndustryType', conversation.industry_type_id);
            setFieldValue('editTimeInBusiness', conversation.time_in_business_months);
            setFieldValue('editRequestedAmount', conversation.requested_amount || conversation.priority);
            setFieldValue('editMonthlyRevenue', conversation.monthly_revenue);
            setFieldValue('editAnnualRevenue', conversation.annual_revenue);
            setFieldValue('editBusinessAddress', conversation.address);
            setFieldValue('editBusinessCity', conversation.city);
            setFieldValue('editBusinessState', conversation.state);
            setFieldValue('editBusinessZip', conversation.zip);
            setFieldValue('editLeadSource', conversation.lead_source_id);
            setFieldValue('editPriority', conversation.priority || 'medium');
            setFieldValue('editNotes', conversation.notes);
            
            // Lead details from API
            setFieldValue('editOwner1SSN', conversation.ssn);
            setFieldValue('editOwner1DOB', conversation.date_of_birth ? conversation.date_of_birth.split('T')[0] : '');
            
            // Add business start date field if it exists
            const businessStartField = document.getElementById('businessStartDate');
            if (businessStartField && conversation.business_start_date) {
                businessStartField.value = conversation.business_start_date.split('T')[0];
            }

            // Marketing preferences
            const marketingRadios = document.querySelectorAll('input[name="editMarketingNotification"]');
            marketingRadios.forEach(radio => {
                if (conversation.marketing_opt_text && conversation.marketing_opt_email) {
                    radio.checked = radio.value === 'BOTH';
                } else if (conversation.marketing_opt_text) {
                    radio.checked = radio.value === 'TEXT';
                } else if (conversation.marketing_opt_email) {
                    radio.checked = radio.value === 'EMAIL';
                } else {
                    radio.checked = radio.value === 'BOTH'; // Default
                }
            });

            // Note: Owner data may need to be fetched separately since it's not in the basic conversation endpoint
            console.log('Edit form populated successfully with basic conversation data');
        }

        async function populateEditDropdowns() {
            try {
                console.log('ðŸ“‹ Populating edit dropdowns...');

                // Entity Types - Static data
                const entityTypes = [
                    'LLC', 'Corporation', 'Partnership', 'Sole Proprietorship', 'S-Corp', 'C-Corp', 'Non-Profit', 'Other'
                ];
                const editEntitySelect = document.getElementById('editEntityType');
                if (editEntitySelect) {
                    editEntitySelect.innerHTML = '<option value="">Select Entity Type...</option>';
                    entityTypes.forEach(type => {
                        editEntitySelect.innerHTML += `<option value="${type}">${type}</option>`;
                    });
                }

                // Industry Types - Static data
                const industryTypes = [
                    'Restaurant', 'Retail', 'Construction', 'Healthcare', 'Professional Services',
                    'Manufacturing', 'Transportation', 'Real Estate', 'Technology', 'Hospitality',
                    'Education', 'Finance', 'Other'
                ];
                const editIndustrySelect = document.getElementById('editIndustryType');
                if (editIndustrySelect) {
                    editIndustrySelect.innerHTML = '<option value="">Select Industry...</option>';
                    industryTypes.forEach(type => {
                        editIndustrySelect.innerHTML += `<option value="${type}">${type}</option>`;
                    });
                }

                // Lead Sources - Static data
                const leadSources = [
                    'Website', 'Referral', 'Cold Call', 'Email Campaign', 'Social Media',
                    'Trade Show', 'Partner', 'Advertisement', 'Direct Mail', 'Other'
                ];
                const editLeadSourceSelect = document.getElementById('editLeadSource');
                if (editLeadSourceSelect) {
                    editLeadSourceSelect.innerHTML = '<option value="">Select Source...</option>';
                    leadSources.forEach(source => {
                        editLeadSourceSelect.innerHTML += `<option value="${source}">${source}</option>`;
                    });
                }

                // States for business and owners
                const states = [
                    { code: 'AL', name: 'Alabama' }, { code: 'AK', name: 'Alaska' },
                    { code: 'AZ', name: 'Arizona' }, { code: 'AR', name: 'Arkansas' },
                    { code: 'CA', name: 'California' }, { code: 'CO', name: 'Colorado' },
                    { code: 'CT', name: 'Connecticut' }, { code: 'DE', name: 'Delaware' },
                    { code: 'FL', name: 'Florida' }, { code: 'GA', name: 'Georgia' },
                    { code: 'HI', name: 'Hawaii' }, { code: 'ID', name: 'Idaho' },
                    { code: 'IL', name: 'Illinois' }, { code: 'IN', name: 'Indiana' },
                    { code: 'IA', name: 'Iowa' }, { code: 'KS', name: 'Kansas' },
                    { code: 'KY', name: 'Kentucky' }, { code: 'LA', name: 'Louisiana' },
                    { code: 'ME', name: 'Maine' }, { code: 'MD', name: 'Maryland' },
                    { code: 'MA', name: 'Massachusetts' }, { code: 'MI', name: 'Michigan' },
                    { code: 'MN', name: 'Minnesota' }, { code: 'MS', name: 'Mississippi' },
                    { code: 'MO', name: 'Missouri' }, { code: 'MT', name: 'Montana' },
                    { code: 'NE', name: 'Nebraska' }, { code: 'NV', name: 'Nevada' },
                    { code: 'NH', name: 'New Hampshire' }, { code: 'NJ', name: 'New Jersey' },
                    { code: 'NM', name: 'New Mexico' }, { code: 'NY', name: 'New York' },
                    { code: 'NC', name: 'North Carolina' }, { code: 'ND', name: 'North Dakota' },
                    { code: 'OH', name: 'Ohio' }, { code: 'OK', name: 'Oklahoma' },
                    { code: 'OR', name: 'Oregon' }, { code: 'PA', name: 'Pennsylvania' },
                    { code: 'RI', name: 'Rhode Island' }, { code: 'SC', name: 'South Carolina' },
                    { code: 'SD', name: 'South Dakota' }, { code: 'TN', name: 'Tennessee' },
                    { code: 'TX', name: 'Texas' }, { code: 'UT', name: 'Utah' },
                    { code: 'VT', name: 'Vermont' }, { code: 'VA', name: 'Virginia' },
                    { code: 'WA', name: 'Washington' }, { code: 'WV', name: 'West Virginia' },
                    { code: 'WI', name: 'Wisconsin' }, { code: 'WY', name: 'Wyoming' }
                ];

                const stateSelects = ['editBusinessState', 'editOwner1HomeState', 'editOwner2HomeState'];
                stateSelects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">Select State...</option>';
                        states.forEach(state => {
                            select.innerHTML += `<option value="${state.code}">${state.name}</option>`;
                        });
                    }
                });

                console.log('âœ… Edit dropdowns populated');
            } catch (error) {
                console.error('âŒ Error populating edit dropdowns:', error);
            }
        }

        function setupEditModalEventListeners() {
            // Close buttons
            const closeBtn = document.getElementById('closeEditLeadModal');
            const cancelBtn = document.getElementById('cancelEditLead');
            const saveBtn = document.getElementById('saveEditLead');

            if (closeBtn) {
                closeBtn.addEventListener('click', closeEditModal);
            }

            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeEditModal);
            }

            if (saveBtn) {
                saveBtn.addEventListener('click', saveLeadChanges);
            }
        }

        function closeEditModal() {
            const modal = document.getElementById('editLeadModal');
            modal.style.display = 'none';

            // Reset mode back to edit
            modal.dataset.mode = 'edit';

            // Reset button text
            const saveBtn = document.getElementById('saveEditLead');
            if (saveBtn) {
                saveBtn.textContent = 'Save Changes';
            }

            // Reset title
            const modalTitle = modal.querySelector('.modal-header h3');
            if (modalTitle) {
                modalTitle.textContent = 'Edit Lead - Comprehensive CRM';
            }

            currentEditingLeadId = null;
        }

        async function saveLeadChanges() {
            const modal = document.getElementById('editLeadModal');
            const mode = modal?.dataset.mode || 'edit';

            console.log('ðŸ’¾ Saving lead in mode:', mode);

            if (mode === 'edit' && !currentEditingLeadId) {
                showNotification('No lead selected for editing', 'error');
                return;
            }

            try {
                // Show loading
                showNotification(mode === 'create' ? 'Creating lead...' : 'Saving changes...', 'info');

                // Collect form data
                const leadData = collectEditFormData();

                console.log('ðŸ“¤ Sending lead data:', leadData);

                let response;

                if (mode === 'create') {
                    // CREATE mode - POST to /api/conversations
                    response = await fetch('http://localhost:3001/api/conversations', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(leadData)
                    });
                } else {
                    // EDIT mode - PUT to /api/conversations/:id
                    response = await fetch(`http://localhost:3001/api/conversations/${currentEditingLeadId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(leadData)
                    });
                }

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || `Failed to ${mode} lead`);
                }

                // Success
                showNotification(
                    mode === 'create' ? 'Lead created successfully!' : 'Lead updated successfully!',
                    'success'
                );

                closeEditModal();

                // Refresh the conversation list
                if (window.commandCenter?.conversationUI) {
                    await window.commandCenter.conversationUI.loadConversations();

                    // If we created a new lead, select it
                    if (mode === 'create' && result.conversation?.id) {
                        setTimeout(() => {
                            window.commandCenter.conversationUI.selectConversation(result.conversation.id);
                        }, 500);
                    } else if (mode === 'edit') {
                        // If this is the currently selected conversation, refresh it
                        const selectedConversationId = window.commandCenter.conversationUI.currentConversationId;
                        if (selectedConversationId === currentEditingLeadId) {
                            window.commandCenter.conversationUI.selectConversation(selectedConversationId);
                        }
                    }
                }

            } catch (error) {
                console.error('âŒ Error saving lead:', error);
                showNotification('Failed to save lead: ' + error.message, 'error');
            }
        }

        function collectEditFormData() {
            // Marketing preferences
            const marketingRadio = document.querySelector('input[name="editMarketingNotification"]:checked');
            const marketingPref = marketingRadio ? marketingRadio.value : 'BOTH';

            const leadData = {
                // Business information
                business_name: document.getElementById('editCompanyName').value,
                dba_name: document.getElementById('editDbaName').value,
                lead_phone: document.getElementById('editPrimaryPhone').value,
                business_phone: document.getElementById('editBusinessPhone').value,
                website: document.getElementById('editWebsite').value,
                tax_id_encrypted: document.getElementById('editTaxId').value,
                entity_type_id: document.getElementById('editEntityType').value || null,
                industry_type_id: document.getElementById('editIndustryType').value || null,
                time_in_business_months: parseInt(document.getElementById('editTimeInBusiness').value) || null,
                requested_amount: parseInt(document.getElementById('editRequestedAmount').value) || null,
                monthly_revenue: parseInt(document.getElementById('editMonthlyRevenue').value) || null,
                annual_revenue: parseInt(document.getElementById('editAnnualRevenue').value) || null,
                address: document.getElementById('editBusinessAddress').value,
                city: document.getElementById('editBusinessCity').value,
                state: document.getElementById('editBusinessState').value,
                zip: document.getElementById('editBusinessZip').value,
                lead_source_id: document.getElementById('editLeadSource').value || null,
                priority: document.getElementById('editPriority').value,
                notes: document.getElementById('editNotes').value,
                marketing_opt_text: marketingPref === 'TEXT' || marketingPref === 'BOTH',
                marketing_opt_email: marketingPref === 'EMAIL' || marketingPref === 'BOTH',
                owners: []
            };

            // Owner data
            const owner1FirstName = document.getElementById('editOwner1FirstName').value;
            const owner1LastName = document.getElementById('editOwner1LastName').value;
            if (owner1FirstName || owner1LastName) {
                leadData.owners.push({
                    first_name: owner1FirstName,
                    last_name: owner1LastName,
                    email: document.getElementById('editOwner1Email').value,
                    phone: document.getElementById('editOwner1Phone').value,
                    ownership_percentage: parseInt(document.getElementById('editOwner1Ownership').value) || null,
                    date_of_birth: document.getElementById('editOwner1DOB').value || null,
                    address: document.getElementById('editOwner1HomeAddress').value,
                    city: document.getElementById('editOwner1HomeCity').value,
                    state: document.getElementById('editOwner1HomeState').value,
                    zip: document.getElementById('editOwner1HomeZip').value,
                    ssn_encrypted: document.getElementById('editOwner1SSN').value
                });
            }

            // Partner data (if provided)
            const owner2FirstName = document.getElementById('editOwner2FirstName').value;
            const owner2LastName = document.getElementById('editOwner2LastName').value;
            if (owner2FirstName || owner2LastName) {
                leadData.owners.push({
                    first_name: owner2FirstName,
                    last_name: owner2LastName,
                    email: document.getElementById('editOwner2Email').value,
                    phone: document.getElementById('editOwner2Phone').value,
                    ownership_percentage: parseInt(document.getElementById('editOwner2Ownership').value) || null,
                    date_of_birth: document.getElementById('editOwner2DOB').value || null,
                    address: document.getElementById('editOwner2HomeAddress').value,
                    city: document.getElementById('editOwner2HomeCity').value,
                    state: document.getElementById('editOwner2HomeState').value,
                    zip: document.getElementById('editOwner2HomeZip').value,
                    ssn_encrypted: document.getElementById('editOwner2SSN').value
                });
            }

            return leadData;
        }

        async function cloneLead() {
            // Get current conversation from ConversationUI
            const conversationUI = window.commandCenter?.conversationUI;
            const selectedConversationId = conversationUI?.currentConversationId;
            
            if (!selectedConversationId) {
                showNotification('Please select a lead to clone', 'error');
                return;
            }

            try {
                showNotification('Cloning lead...', 'info');

                const response = await fetch(`http://localhost:3001/api/conversations/${selectedConversationId}/clone`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to clone lead');
                }

                showNotification('Lead cloned successfully!', 'success');
                window.commandCenter?.conversationUI?.loadConversations();

            } catch (error) {
                console.error('Error cloning lead:', error);
                showNotification('Failed to clone lead: ' + error.message, 'error');
            }
        }

        function showArchiveConfirmation() {
            // Get current conversation from ConversationUI
            const conversationUI = window.commandCenter?.conversationUI;
            const selectedConversation = conversationUI?.selectedConversation;
            
            if (!selectedConversation) {
                showNotification('Please select a lead to archive', 'error');
                return;
            }

            // Populate confirmation dialog
            document.getElementById('archiveLeadName').textContent = selectedConversation.business_name || 'Unknown';
            document.getElementById('archiveLeadPhone').textContent = selectedConversation.lead_phone || 'N/A';

            const modal = document.getElementById('archiveConfirmModal');
            modal.style.display = 'flex';
        }

        function showDeleteConfirmation() {
            // Get current conversation from ConversationUI
            const conversationUI = window.commandCenter?.conversationUI;
            const selectedConversation = conversationUI?.selectedConversation;
            
            if (!selectedConversation) {
                showNotification('Please select a lead to delete', 'error');
                return;
            }

            // Populate confirmation dialog
            document.getElementById('deleteLeadName').textContent = selectedConversation.business_name || 'Unknown';
            document.getElementById('deleteLeadPhone').textContent = selectedConversation.lead_phone || 'N/A';

            const modal = document.getElementById('deleteConfirmModal');
            modal.style.display = 'flex';
        }

        function setupConfirmationDialogs() {
            // Archive confirmation
            const archiveModal = document.getElementById('archiveConfirmModal');
            const closeArchiveBtn = document.getElementById('closeArchiveConfirmModal');
            const cancelArchiveBtn = document.getElementById('cancelArchive');
            const confirmArchiveBtn = document.getElementById('confirmArchive');

            if (closeArchiveBtn) closeArchiveBtn.addEventListener('click', () => archiveModal.style.display = 'none');
            if (cancelArchiveBtn) cancelArchiveBtn.addEventListener('click', () => archiveModal.style.display = 'none');
            if (confirmArchiveBtn) confirmArchiveBtn.addEventListener('click', confirmArchiveLead);

            // Delete confirmation
            const deleteModal = document.getElementById('deleteConfirmModal');
            const closeDeleteBtn = document.getElementById('closeDeleteConfirmModal');
            const cancelDeleteBtn = document.getElementById('cancelDelete');
            const confirmDeleteBtn = document.getElementById('confirmDelete');

            if (closeDeleteBtn) closeDeleteBtn.addEventListener('click', () => deleteModal.style.display = 'none');
            if (cancelDeleteBtn) cancelDeleteBtn.addEventListener('click', () => deleteModal.style.display = 'none');
            if (confirmDeleteBtn) confirmDeleteBtn.addEventListener('click', confirmDeleteLead);
        }

        async function confirmArchiveLead() {
            if (!currentConversationId) return;

            try {
                showNotification('Archiving lead...', 'info');

                const response = await fetch(`http://localhost:3001/api/conversations/${currentConversationId}/archive`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to archive lead');
                }

                showNotification('Lead archived successfully!', 'success');
                document.getElementById('archiveConfirmModal').style.display = 'none';
                window.commandCenter?.conversationUI?.loadConversations();
                clearConversationView();

            } catch (error) {
                console.error('Error archiving lead:', error);
                showNotification('Failed to archive lead: ' + error.message, 'error');
            }
        }

        async function confirmDeleteLead() {
            // Get current conversation from ConversationUI
            const conversationUI = window.commandCenter?.conversationUI;
            const selectedConversationId = conversationUI?.currentConversationId;
            
            if (!selectedConversationId) return;

            try {
                showNotification('Deleting lead...', 'info');

                const response = await fetch(`http://localhost:3001/api/conversations/${selectedConversationId}`, {
                    method: 'DELETE'
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.error || 'Failed to delete lead');
                }

                showNotification('Lead deleted successfully!', 'warning');
                document.getElementById('deleteConfirmModal').style.display = 'none';
                window.commandCenter?.conversationUI?.loadConversations();
                clearConversationView();

            } catch (error) {
                console.error('Error deleting lead:', error);
                showNotification('Failed to delete lead: ' + error.message, 'error');
            }
        }

        function clearConversationView() {
            // Clear conversation selection in ConversationUI
            const conversationUI = window.commandCenter?.conversationUI;
            if (conversationUI) {
                conversationUI.currentConversationId = null;
                conversationUI.selectedConversation = null;
            }
            
            const conversationActions = document.getElementById('conversationActions');
            const messageInputContainer = document.getElementById('messageInputContainer');
            const messagesContainer = document.getElementById('messagesContainer');
            const conversationInfo = document.getElementById('conversationInfo');
            
            if (conversationActions) conversationActions.style.display = 'none';
            if (messageInputContainer) messageInputContainer.style.display = 'none';
            if (messagesContainer) {
                messagesContainer.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ðŸ’¬</div>
                        <h3>No conversation selected</h3>
                        <p>Select a conversation from the left panel to view the message thread</p>
                    </div>
                `;
            }
            if (conversationInfo) {
                conversationInfo.className = 'conversation-info';
                conversationInfo.innerHTML = `
                    <h2>Select a conversation</h2>
                    <p>Choose a conversation from the left to view messages</p>
                `;
            }
        }

        // Initialize lead management when page loads
        initializeLeadManagement();
    </script>

    <!-- FCS Generation Modal -->
    <div id="fcsModal" class="modal fcs-modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Generate FCS Report</h3>
                <button class="modal-close" onclick="window.conversationUI.fcs.hideFCSModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p>Select bank statements to analyze:</p>
                <div id="fcsDocumentSelection" style="max-height: 300px; overflow-y: auto;">
                    <!-- Documents will be populated here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="window.conversationUI.fcs.hideFCSModal()">Cancel</button>
                <button id="confirmFcs" class="btn btn-primary" onclick="window.conversationUI.fcs.triggerFCS()">Generate FCS</button>
            </div>
        </div>
    </div>

    <!-- Processing Indicator -->
    <div id="processingIndicator" class="processing-overlay" style="display: none;">
        <div class="processing-content">
            <div class="spinner"></div>
            <div class="processing-text">Processing...</div>
            <div class="processing-subtext" id="processingSubtext">Please wait while we process your request</div>
        </div>
    </div>

    <!-- Lender Submission Modal -->
    <div id="lenderSubmissionModal" class="modal" style="display: none;">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2>Send Submissions to Lenders</h2>
                <button class="modal-close" id="closeLenderSubmissionModal">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Lenders Selection -->
                <div class="form-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <h3 style="margin: 0;">Select Lenders</h3>
                        <button type="button" id="toggleAllLendersBtn" class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;">
                            Deselect All
                        </button>
                    </div>
                    <div id="lenderSelectionList" style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px;">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Documents Selection -->
                <div class="form-section" style="margin-top: 20px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <h3 style="margin: 0;">Select Documents</h3>
                        <button type="button" id="toggleAllDocumentsBtn" class="btn btn-secondary" style="padding: 4px 12px; font-size: 12px;">
                            Select All
                        </button>
                    </div>
                    <div id="submissionDocumentList" style="max-height: 200px; overflow-y: auto; border: 1px solid #e2e8f0; border-radius: 8px; padding: 12px;">
                        <!-- Populated dynamically -->
                    </div>
                </div>

                <!-- Message -->
                <div class="form-section" style="margin-top: 20px;">
                    <h3>Message</h3>
                    <textarea id="submissionMessage" rows="6" style="width: 100%; padding: 12px; border: 1px solid #e2e8f0; border-radius: 8px; font-family: inherit; font-size: 14px;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelLenderSubmission">Cancel</button>
                <button class="btn btn-primary" id="confirmLenderSubmission">
                    <span id="sendSubmissionsText">Send Submissions</span>
                    <span id="sendSubmissionsLoading" style="display: none;">Sending...</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Global Functions - Loaded BEFORE module script -->
    <script>
        console.log('ðŸŒ Loading global openLeadModal function...');

        // Define openLeadModal in global scope IMMEDIATELY
        window.openLeadModal = function(mode = 'create', conversationData = null) {
            console.log(`ðŸ“ openLeadModal called in ${mode.toUpperCase()} mode`);

            // Wait for intelligence module if not ready
            if (!window.conversationUI?.intelligence) {
                console.log('â³ Intelligence not ready, waiting...');
                setTimeout(() => window.openLeadModal(mode, conversationData), 100);
                return;
            }

            const modal = document.getElementById('editLeadInlineModal');
            const modalContent = document.getElementById('editLeadInlineContent');

            if (!modal || !modalContent) {
                console.error('âŒ Modal elements not found');
                return;
            }

            const intelligence = window.conversationUI.intelligence;

            if (mode === 'create') {
                console.log('âœ… Opening in CREATE mode');

                // Empty conversation data
                const emptyConversation = {
                    business_name: '', dba_name: '', lead_phone: '', business_phone: '',
                    website: '', tax_id: '', entity_type: '', industry_type: '',
                    business_address: '', business_address2: '', business_city: '',
                    business_state: '', business_zip: '', business_country: 'United States',
                    cell_phone: '', work_phone: '', fax_phone: '', annual_revenue: '',
                    monthly_revenue: '', requested_amount: '', time_in_business: '',
                    credit_score: '', years_in_business: '', owner_first_name: '',
                    owner_last_name: '', owner_email: '', owner_home_address: '',
                    owner_home_address2: '', owner_home_city: '', owner_home_state: '',
                    owner_home_zip: '', owner_home_country: 'United States',
                    ownership_percent: '', ssn: '', date_of_birth: '',
                    business_start_date: '', length_of_ownership: '', product_sold: '',
                    use_of_proceeds: '', lead_source: '', campaign: '', lead_status: '',
                    business_email: '', factor_rate: '', term_months: '', funding_date: '',
                    lead_details: {}
                };

                const formHTML = intelligence.createEditFormTemplate(emptyConversation);
                modalContent.innerHTML = formHTML;

                const modalTitle = modal.querySelector('.modal-header h3');
                if (modalTitle) modalTitle.textContent = 'Add New Lead - Comprehensive CRM';

                const generateBtn = modalContent.querySelector('#generateApplicationBtn');
                if (generateBtn) generateBtn.style.display = 'none';

                const submitBtn = modalContent.querySelector('.update-btn');
                if (submitBtn) {
                    submitBtn.textContent = 'Create Lead';
                    submitBtn.style.background = '#10b981';
                }

                // Attach form submission handler
                const form = modalContent.querySelector('#editLeadForm');
                if (form) {
                    form.onsubmit = async (e) => {
                        e.preventDefault();
                        await handleCreateFormSubmit(e);
                    };
                    console.log('âœ… Form submit handler attached');
                }

                console.log('âœ… Form generated for CREATE mode');
            } else if (mode === 'edit') {
                console.log('âœ… Opening in EDIT mode');

                if (!conversationData) {
                    console.error('âŒ No conversation data provided for edit mode');
                    return;
                }

                const formHTML = intelligence.createEditFormTemplate(conversationData);
                modalContent.innerHTML = formHTML;

                const modalTitle = modal.querySelector('.modal-header h3');
                if (modalTitle) modalTitle.textContent = 'Edit Lead Information';

                // Attach form submission handler for edit
                const form = modalContent.querySelector('#editLeadForm');
                if (form) {
                    form.onsubmit = async (e) => {
                        e.preventDefault();
                        await handleEditFormSubmit(e, conversationData.id);
                    };
                    console.log('âœ… Edit form submit handler attached');
                }

                console.log('âœ… Form generated for EDIT mode');
            }

            // Close handlers
            const closeBtn = document.getElementById('closeEditLeadInlineModal');
            if (closeBtn) {
                closeBtn.onclick = () => { modal.style.display = 'none'; };
            }

            modal.onclick = (e) => {
                if (e.target === modal) modal.style.display = 'none';
            };

            modal.style.display = 'flex';
            console.log('âœ… Modal displayed');
        };

        console.log('âœ… openLeadModal defined globally');

        // Debug helper to test modal function
        window.testOpenLeadModal = function() {
            console.log('ðŸ§ª Testing openLeadModal function...');
            console.log('Function exists:', !!window.openLeadModal);
            console.log('Function type:', typeof window.openLeadModal);

            if (window.openLeadModal) {
                console.log('Calling openLeadModal("create")...');
                try {
                    window.openLeadModal('create');
                    console.log('âœ… Function executed');
                } catch (error) {
                    console.error('âŒ Error:', error);
                }
            }
        };

        console.log('ðŸ’¡ Test helper added: window.testOpenLeadModal()');

        // Handle new lead form submission
        async function handleNewLeadSubmit(e) {
            e.preventDefault();
            console.log('ðŸ“¤ Submitting new lead...');

            const formData = new FormData(e.target);
            const data = {};

            // Convert form data to object with snake_case keys
            for (const [key, value] of formData.entries()) {
                const snakeKey = key.replace(/([A-Z])/g, '_$1').toLowerCase();
                if (value) {
                    data[snakeKey] = value;
                }
            }

            const submitBtn = e.target.querySelector('[type="submit"]');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Creating...';
            submitBtn.disabled = true;

            try {
                const response = await fetch('http://localhost:3001/api/conversations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    alert('âœ… Lead created successfully!');
                    document.getElementById('addLeadModal').style.display = 'none';
                    location.reload(); // Refresh to show new lead
                } else {
                    throw new Error(result.error || 'Failed to create lead');
                }
            } catch (error) {
                console.error('Error creating lead:', error);
                alert('âŒ Error: ' + error.message);
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
            }
        }

        // Simple standalone function to open the add lead modal
        window.openNewLeadModal = function() {
            console.log('ðŸ†• Opening standalone Add Lead modal');
            const modal = document.getElementById('addLeadModal');
            if (!modal) {
                console.error('âŒ Add Lead modal not found');
                return;
            }

            // Inject the generated form
            const modalBody = modal.querySelector('.modal-body');
            if (modalBody && typeof generateNewLeadForm === 'function') {
                modalBody.innerHTML = generateNewLeadForm();

                // Attach submit handler
                const form = document.getElementById('newLeadForm');
                if (form) {
                    form.onsubmit = async (e) => {
                        e.preventDefault();
                        await handleNewLeadSubmit(e);
                    };
                }
            }

            modal.style.display = 'flex';
        };

        // Close button handler
        document.addEventListener('DOMContentLoaded', function() {
            const closeBtn = document.getElementById('closeAddLeadModal');
            const cancelBtn = document.getElementById('cancelAddLead');
            const modal = document.getElementById('addLeadModal');

            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
            }

            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    modal.style.display = 'none';
                });
            }

            // Close on outside click
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                    }
                });
            }
        });

        console.log('âœ… openNewLeadModal defined globally');
    </script>

    <!-- Main JavaScript Integration Script -->
    <script type="module">
        // Import all modules
        import { Utilities, Templates } from './js/templates-utilities.js';
        import ConversationCore from './js/conversation-core.js';
        import MessagingModule from './js/messaging.js';
        import DocumentsModule from './js/documents.js';
        import StatsModule from './js/stats.js';
        import IntelligenceTabs from './js/intelligence-tabs.js';
        import FCSModule from './js/fcs-module.js';
        import LendersModule from './js/lenders.js';
        import AIAssistant from './js/ai-assistant.js';
        // import WebSocketManager from './js/websocket.js'; // Temporarily disabled

        // Main ConversationUI class that integrates all modules
        class ConversationUI {
            constructor() {
                // Configuration
                this.apiBaseUrl = 'http://localhost:3001';
                this.wsUrl = `ws://localhost:3001`;
                this.userId = 'user_' + Math.random().toString(36).substr(2, 9);

                // Initialize core state
                this.currentConversationId = null;
                this.selectedConversation = null;
                this.conversations = new Map();
                this.selectedForDeletion = new Set();
                this.unreadMessages = new Map();

                // Initialize utilities and templates with proper classes
                this.utils = new Utilities(this);
                this.templates = new Templates(this);

                // Initialize modules
                this.initializeModules();

                // Set up global reference
                window.conversationUI = this;

                console.log('âœ… ConversationUI initialized with modular architecture');
            }

            initializeModules() {
                try {
                    // Initialize core conversation functionality
                    this.core = new ConversationCore(this);
                    console.log('âœ… ConversationCore initialized');

                    // Initialize messaging
                    this.messaging = new MessagingModule(this);
                    console.log('âœ… MessagingModule initialized');

                    // Initialize documents
                    this.documents = new DocumentsModule(this);
                    console.log('âœ… DocumentsModule initialized');

                    // Initialize stats
                    this.stats = new StatsModule(this);
                    console.log('âœ… StatsModule initialized');

                    // Initialize intelligence tabs
                    this.intelligence = new IntelligenceTabs(this);
                    console.log('âœ… IntelligenceTabs initialized');

                    // Initialize FCS module
                    this.fcs = new FCSModule(this);
                    console.log('âœ… FCSModule initialized');

                    // Initialize lenders module
                    this.lenders = new LendersModule(this);
                    console.log('âœ… LendersModule initialized');

                    // Initialize AI assistant
                    this.ai = new AIAssistant(this);
                    console.log('âœ… AIAssistant initialized');

                    // Initialize WebSocket manager (temporarily disabled - backend uses Socket.io)
                    // this.websocket = new WebSocketManager(this);
                    // console.log('âœ… WebSocketManager initialized');
                    console.log('âš ï¸ WebSocketManager disabled (backend uses Socket.io)');

                    // Set up module cross-references
                    this.setupModuleCrossReferences();

                } catch (error) {
                    console.error('âŒ Error initializing modules:', error);
                }
            }

            initializeUI() {
                console.log('ðŸŽ¯ initializeUI() called');

                // Setup Add Lead button after modules are initialized
                setTimeout(() => {
                    console.log('ðŸŽ¯ Timeout fired, looking for addLeadBtn...');
                    const addLeadBtn = document.getElementById('addLeadBtn');
                    console.log('ðŸŽ¯ addLeadBtn:', addLeadBtn);

                    if (!addLeadBtn) {
                        console.error('âŒ Add Lead button not found');
                        // List all buttons to debug
                        const allButtons = document.querySelectorAll('button');
                        console.log('All buttons on page:', allButtons);
                        return;
                    }

                    console.log('ðŸ”§ Setting up Add Lead button...');
                    console.log('ðŸ”§ Button has', addLeadBtn.getEventListeners ? 'listeners' : 'no listener API');

                    // Remove existing listeners by cloning
                    const cleanBtn = addLeadBtn.cloneNode(true);
                    addLeadBtn.parentNode.replaceChild(cleanBtn, addLeadBtn);
                    console.log('ðŸ”§ Button cloned and replaced');

                    cleanBtn.addEventListener('click', async (e) => {
                        console.log('ðŸŽ¯ðŸŽ¯ðŸŽ¯ CLICK EVENT FIRED!!! ðŸŽ¯ðŸŽ¯ðŸŽ¯');
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('ðŸ†• Add Lead button clicked');

                        // Wait for modules to be ready with retry logic
                        let attempts = 0;
                        const maxAttempts = 20;

                        const waitForModules = () => {
                            return new Promise((resolve, reject) => {
                                const checkReady = () => {
                                    attempts++;

                                    // Log current state
                                    console.log(`â³ Attempt ${attempts}/${maxAttempts}:`, {
                                        conversationUI: !!window.conversationUI,
                                        intelligence: !!window.conversationUI?.intelligence,
                                        openLeadModal: !!window.openLeadModal
                                    });

                                    if (window.conversationUI?.intelligence && window.openLeadModal) {
                                        console.log('âœ… All systems ready!');
                                        resolve();
                                    } else if (attempts >= maxAttempts) {
                                        console.error('âŒ Timeout waiting for modules');
                                        reject(new Error('System initialization timeout'));
                                    } else {
                                        setTimeout(checkReady, 100);
                                    }
                                };

                                checkReady();
                            });
                        };

                        try {
                            await waitForModules();
                            console.log('âœ… Opening modal in CREATE mode');
                            window.openLeadModal('create');
                        } catch (error) {
                            console.error('âŒ Error:', error);
                            alert('System is still loading. Please wait a moment and try again.');
                        }
                    });

                    console.log('âœ… Add Lead button configured successfully');
                }, 1500);
            }

            setupModuleCrossReferences() {
                // Allow modules to reference each other through parent
                // This enables modules to call methods on other modules when needed
            }

            // Proxy methods to core functionality
            getCurrentConversationId() {
                return this.currentConversationId || this.core?.currentConversationId;
            }

            getSelectedConversation() {
                return this.selectedConversation || this.core?.selectedConversation;
            }

            selectConversation(conversationId) {
                return this.core?.selectConversation(conversationId);
            }

            loadConversations() {
                return this.core?.loadConversations();
            }

            // Conversation context helper methods
            getCurrentConversationId() {
                return this.currentConversationId ||
                       (this.core && this.core.currentConversationId) ||
                       null;
            }

            getSelectedConversation() {
                return this.selectedConversation ||
                       (this.core && this.core.selectedConversation) ||
                       null;
            }

            setCurrentConversation(conversationId, conversationData) {
                this.currentConversationId = conversationId;
                this.selectedConversation = conversationData;

                if (this.core) {
                    this.core.currentConversationId = conversationId;
                    this.core.selectedConversation = conversationData;
                }
            }

            // Modal management methods
            hideAddLeadModal() {
                const modal = document.getElementById('addLeadModal');
                if (modal) modal.style.display = 'none';
            }

            saveNewLead() {
                return this.core?.saveNewLead();
            }

            hideLenderSubmissionModal() {
                const modal = document.getElementById('lenderSubmissionModal');
                if (modal) modal.style.display = 'none';
            }

            sendLenderSubmissions() {
                return this.lenders?.sendLenderSubmissions();
            }

            toggleAllLenders() {
                return this.lenders?.toggleAllLenders();
            }

            // Processing indicator methods
            showProcessing(text = 'Processing...', subtext = 'Please wait while we process your request') {
                const indicator = document.getElementById('processingIndicator');
                const subtextEl = document.getElementById('processingSubtext');

                if (indicator) {
                    indicator.style.display = 'flex';
                    if (subtextEl) subtextEl.textContent = subtext;
                }
            }

            hideProcessing() {
                const indicator = document.getElementById('processingIndicator');
                if (indicator) indicator.style.display = 'none';
            }
        }

        // Helper function to get conversation ID with display ID
        window.getConversationId = function() {
            const selected = document.querySelector('.conversation-item.selected');
            if (selected) {
                const displayId = selected.dataset.displayId || 'Not set';
                const uuid = selected.dataset.conversationId;

                console.log('Display ID:', displayId);
                console.log('UUID:', uuid);

                // Copy display ID to clipboard for easy use
                if (navigator.clipboard && displayId !== 'Not set') {
                    navigator.clipboard.writeText(displayId).then(() => {
                        alert(`Lead ID: #${displayId}\n(Copied to clipboard)`);
                    }).catch(() => {
                        alert(`Lead ID: #${displayId}\nUUID: ${uuid}`);
                    });
                } else {
                    alert(`Lead ID: #${displayId}\nUUID: ${uuid}`);
                }

                return { displayId, uuid };
            }

            alert('Please select a conversation first');
            return null;
        };

        // Initialize the application when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ðŸš€ CODE VERSION: 2025-01-06-v6 - HEAVY DEBUG VERSION');
            console.log('ðŸš€ Initializing ConversationUI...');

            try {
                const ui = new ConversationUI();

                // Initialize UI and New Lead button with HEAVY DEBUG
                setTimeout(() => {
                    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                    console.log('ðŸ”§ NEW LEAD BUTTON SETUP - DEBUG MODE');
                    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                    const addLeadBtn = document.getElementById('addLeadBtn');
                    console.log('1ï¸âƒ£ Button element:', addLeadBtn);
                    console.log('   - Exists:', !!addLeadBtn);
                    console.log('   - Tag:', addLeadBtn?.tagName);
                    console.log('   - ID:', addLeadBtn?.id);
                    console.log('   - Classes:', addLeadBtn?.className);
                    console.log('   - Text:', addLeadBtn?.textContent?.trim());
                    console.log('   - Visible:', addLeadBtn ? (addLeadBtn.offsetWidth > 0 && addLeadBtn.offsetHeight > 0) : false);
                    console.log('   - Disabled:', addLeadBtn?.disabled);

                    if (!addLeadBtn) {
                        console.error('âŒ Add Lead button NOT FOUND in DOM');
                        console.log('ðŸ“‹ All buttons with "add" or "lead" in ID:');
                        document.querySelectorAll('button[id*="add"], button[id*="lead"], button[id*="Lead"]').forEach(btn => {
                            console.log('   -', btn.id, ':', btn.textContent?.trim());
                        });
                        return;
                    }

                    console.log('2ï¸âƒ£ Checking for existing event listeners...');
                    console.log('   - onclick:', addLeadBtn.onclick);
                    console.log('   - Has inline handler:', !!addLeadBtn.getAttribute('onclick'));

                    // DON'T REMOVE INLINE HANDLER - LET IT WORK
                    console.log('   â„¹ï¸ Keeping inline onclick handler for testing');

                    // DON'T CLONE BUTTON - causes issues
                    console.log('3ï¸âƒ£ Skipping button clone - using original button');
                    const cleanBtn = addLeadBtn; // Just use the original button
                    console.log('   âœ… Using original button');

                    console.log('4ï¸âƒ£ Checking global functions...');
                    console.log('   - window.openLeadModal exists:', !!window.openLeadModal);
                    console.log('   - window.openLeadModal type:', typeof window.openLeadModal);
                    console.log('   - window.conversationUI exists:', !!window.conversationUI);
                    console.log('   - window.conversationUI.intelligence exists:', !!window.conversationUI?.intelligence);

                    console.log('5ï¸âƒ£ Adding new event listener...');

                    // Add click listener with MAXIMUM debug
                    cleanBtn.addEventListener('click', (e) => {
                        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                        console.log('ðŸŽ¯ðŸŽ¯ðŸŽ¯ BUTTON CLICKED!!! ðŸŽ¯ðŸŽ¯ðŸŽ¯');
                        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                        console.log('Event details:');
                        console.log('   - Type:', e.type);
                        console.log('   - Target:', e.target);
                        console.log('   - CurrentTarget:', e.currentTarget);
                        console.log('   - TimeStamp:', e.timeStamp);

                        e.preventDefault();
                        console.log('   âœ… preventDefault() called');

                        e.stopPropagation();
                        console.log('   âœ… stopPropagation() called');

                        console.log('Checking system state:');
                        console.log('   - window.openLeadModal:', !!window.openLeadModal);
                        console.log('   - window.conversationUI:', !!window.conversationUI);
                        console.log('   - intelligence module:', !!window.conversationUI?.intelligence);

                        if (!window.openLeadModal) {
                            console.error('âŒ openLeadModal function NOT FOUND');
                            console.log('Available window functions:', Object.keys(window).filter(k => k.includes('Lead') || k.includes('lead') || k.includes('open')));
                            alert('System is still loading. Please wait a moment and try again.');
                            return;
                        }

                        console.log('ðŸš€ Calling window.openLeadModal("create")...');
                        try {
                            window.openLeadModal('create');
                            console.log('âœ… openLeadModal() called successfully');
                        } catch (error) {
                            console.error('âŒ Error calling openLeadModal:', error);
                            console.error('Stack trace:', error.stack);
                            alert('Error opening modal: ' + error.message);
                        }
                    }, { capture: false, once: false });

                    console.log('   âœ… Event listener added');

                    // Test the button programmatically
                    console.log('6ï¸âƒ£ Testing button click programmatically...');
                    console.log('   Run this in console to test: document.getElementById("addLeadBtn").click()');

                    // Verify the button is interactive
                    console.log('7ï¸âƒ£ Final verification:');
                    console.log('   - Button in DOM:', !!document.getElementById('addLeadBtn'));
                    console.log('   - Button is same element:', document.getElementById('addLeadBtn') === cleanBtn);
                    console.log('   - Button parent:', cleanBtn.parentElement?.className);
                    console.log('   - Button computed style display:', window.getComputedStyle(cleanBtn).display);
                    console.log('   - Button computed style visibility:', window.getComputedStyle(cleanBtn).visibility);
                    console.log('   - Button pointer-events:', window.getComputedStyle(cleanBtn).pointerEvents);

                    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
                    console.log('âœ… NEW LEAD BUTTON SETUP COMPLETE');
                    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');

                    // Initialize rest of UI
                    ui.initializeUI();
                }, 500);

            } catch (error) {
                console.error('âŒ Failed to initialize ConversationUI:', error);
                console.error('Stack trace:', error.stack);
            }
        });

        // Additional debug helper
        window.debugNewLeadButton = function() {
            console.log('ðŸ” Manual Debug Check:');
            const btn = document.getElementById('addLeadBtn');
            console.log('Button:', btn);
            console.log('Visible:', btn ? (btn.offsetWidth > 0 && btn.offsetHeight > 0) : false);
            console.log('Disabled:', btn?.disabled);
            console.log('onclick:', btn?.onclick);
            console.log('Has listeners:', btn ? 'unknown (no API)' : 'N/A');

            if (btn) {
                console.log('Attempting manual click...');
                btn.click();
            }
        };

        console.log('ðŸ’¡ Debug helper added: window.debugNewLeadButton()');

        // NOTE: window.openLeadModal is already defined in the global script above (line ~2858)
        // No need to redefine it here

        async function handleCreateFormSubmit(e) {
            e.preventDefault();
            console.log('ðŸ“¤ Creating new lead...');

            const formData = new FormData(e.target);
            const rawData = Object.fromEntries(formData.entries());

            const createData = {};
            for (const [field, value] of Object.entries(rawData)) {
                const snakeCase = field.replace(/([A-Z])/g, '_$1').toLowerCase();
                if (['annual_revenue', 'monthly_revenue', 'requested_amount', 'credit_score',
                     'years_in_business', 'ownership_percent', 'factor_rate', 'term_months'].includes(snakeCase)) {
                    createData[snakeCase] = value ? parseFloat(value.toString().replace(/[$,\s%]/g, '')) : null;
                } else {
                    createData[snakeCase] = value || null;
                }
            }

            Object.keys(createData).forEach(key => {
                if (createData[key] === '' || createData[key] === null) delete createData[key];
            });

            const submitBtn = e.target.querySelector('.update-btn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Creating...';
            submitBtn.disabled = true;

            try {
                const response = await fetch('http://localhost:3001/api/conversations', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(createData)
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Failed to create lead');

                console.log('âœ… Lead created successfully:', result);

                if (window.conversationUI?.utils) {
                    window.conversationUI.utils.showNotification('Lead created successfully!', 'success');
                }

                const modal = document.getElementById('editLeadInlineModal');
                if (modal) modal.style.display = 'none';

                if (window.conversationUI?.core) {
                    await window.conversationUI.core.loadConversations();
                    const newId = result.conversation?.id || result.id;
                    if (newId) {
                        setTimeout(() => window.conversationUI.core.selectConversation(newId), 500);
                    }
                }
            } catch (error) {
                console.error('âŒ Error creating lead:', error);
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                if (window.conversationUI?.utils) {
                    window.conversationUI.utils.showNotification('Failed to create lead: ' + error.message, 'error');
                } else {
                    alert('Failed to create lead: ' + error.message);
                }
            }
        }

        async function handleEditFormSubmit(e, conversationId) {
            e.preventDefault();
            console.log('ðŸ“¤ Updating lead...');

            const leadId = conversationId || currentEditingLeadId;

            if (!leadId) {
                console.error('âŒ No lead ID set for editing');
                return;
            }

            const formData = new FormData(e.target);
            const rawData = Object.fromEntries(formData.entries());

            const updateData = {};
            for (const [field, value] of Object.entries(rawData)) {
                const snakeCase = field.replace(/([A-Z])/g, '_$1').toLowerCase();
                if (['annual_revenue', 'monthly_revenue', 'requested_amount', 'credit_score',
                     'years_in_business', 'ownership_percent', 'factor_rate', 'term_months'].includes(snakeCase)) {
                    updateData[snakeCase] = value ? parseFloat(value.toString().replace(/[$,\s%]/g, '')) : null;
                } else {
                    updateData[snakeCase] = value || null;
                }
            }

            Object.keys(updateData).forEach(key => {
                if (updateData[key] === '' || updateData[key] === null) delete updateData[key];
            });

            const submitBtn = e.target.querySelector('.update-btn');
            const originalText = submitBtn.textContent;
            submitBtn.textContent = 'Updating...';
            submitBtn.disabled = true;

            try {
                const response = await fetch(`http://localhost:3001/api/conversations/${leadId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });

                const result = await response.json();
                if (!response.ok) throw new Error(result.error || 'Failed to update lead');

                console.log('âœ… Lead updated successfully:', result);

                if (window.conversationUI?.utils) {
                    window.conversationUI.utils.showNotification('Lead updated successfully!', 'success');
                }

                const modal = document.getElementById('editLeadInlineModal');
                if (modal) modal.style.display = 'none';

                if (window.conversationUI?.core) {
                    const currentId = window.conversationUI.core.currentConversationId;
                    if (currentId === leadId) {
                        window.conversationUI.core.selectConversation(currentId);
                    }
                    await window.conversationUI.core.loadConversations();
                }
            } catch (error) {
                console.error('âŒ Error updating lead:', error);
                submitBtn.textContent = originalText;
                submitBtn.disabled = false;
                if (window.conversationUI?.utils) {
                    window.conversationUI.utils.showNotification('Failed to update lead: ' + error.message, 'error');
                } else {
                    alert('Failed to update lead: ' + error.message);
                }
            }
        }

        console.log('âœ… Unified lead modal system loaded');
    </script>
</body>
</html>